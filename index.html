<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ESRC Elections 2026â€“2027 | Voting Portal</title>

<!-- Modern Fonts: Plus Jakarta Sans for Headings, Inter for Body/UI -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap" rel="stylesheet">

<style>
:root {
  /* Modern Color Palette - "Circuit Board Green" */
  --primary: #10b981;       /* Emerald 500 */
  --primary-hover: #059669; /* Emerald 600 */
  --primary-dark: #047857;  /* Emerald 700 */
  --primary-light: #d1fae5; /* Emerald 100 */
  --primary-subtle: #ecfdf5;/* Emerald 50 */
  
  --bg-main: #f8fafc;       /* Slate 50 */
  --surface: #ffffff;
  --surface-alt: #f1f5f9;   /* Slate 100 */
  
  --text-main: #0f172a;     /* Slate 900 */
  --text-muted: #64748b;    /* Slate 500 */
  --text-light: #94a3b8;    /* Slate 400 */
  
  --border: #e2e8f0;        /* Slate 200 */
  --border-focus: #34d399;  /* Emerald 400 */
  
  --danger: #ef4444;
  --danger-light: #fee2e2;
  --warning: #f59e0b;
  --warning-light: #fef3c7;
  
  /* Typography */
  --font-body: 'Inter', sans-serif;
  --font-heading: 'Plus Jakarta Sans', sans-serif;
  --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  
  /* Layout & Shadows */
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 24px;
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.02);
  --shadow-glow: 0 0 0 4px rgba(16, 185, 129, 0.2);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; }
body { 
  font-family: var(--font-body); 
  background-color: var(--bg-main); 
  /* Subtle tech grid background */
  background-image: radial-gradient(var(--border) 1px, transparent 1px);
  background-size: 24px 24px;
  color: var(--text-main); 
  min-height: 100vh; 
  overflow-x: hidden; 
  line-height: 1.5; 
}

/* â”€â”€ ANIMATIONS â”€â”€ */
@keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
@keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes pulseGlow { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

/* â”€â”€ LOADING OVERLAY & INLINE SPINNERS â”€â”€ */
#loading-overlay {
  position: fixed; inset: 0; background: rgba(248, 250, 252, 0.95); backdrop-filter: blur(8px); z-index: 9999;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: opacity 0.4s ease;
}
.spinner {
  width: 48px; height: 48px; border: 4px solid var(--border); border-top-color: var(--primary);
  border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 24px;
  box-shadow: 0 0 16px rgba(16, 185, 129, 0.2);
}
.inline-spinner {
  width: 20px; height: 20px; border-width: 3px; border-color: rgba(255,255,255,0.3); border-top-color: #fff;
  border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle;
  margin-right: 8px;
}
.btn-loading { pointer-events: none; opacity: 0.85; }

/* â”€â”€ STATUS BAR â”€â”€ */
#status-bar { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 10px 1rem; font-size: 0.8rem; font-weight: 600; font-family: var(--font-heading); color: #fff; background: var(--primary-dark); transition: background 0.3s; z-index: 400; position: relative; letter-spacing: 0.3px;}
#status-bar.closed { background: #991b1b; }
.sdot { width: 8px; height: 8px; border-radius: 50%; background: #fff; flex-shrink: 0; animation: blink 2s infinite; box-shadow: 0 0 8px rgba(255,255,255,0.8); }
#status-bar.closed .sdot { background: #fca5a5; animation: none; box-shadow: none; }

/* â”€â”€ HEADER â”€â”€ */
header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 300; border-bottom: 1px solid rgba(226, 232, 240, 0.8); box-shadow: var(--shadow-sm); }
.hdr { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; height: 76px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
.logo { display: flex; align-items: center; gap: 12px; cursor: pointer; text-decoration: none; transition: transform 0.2s ease; }
.logo:hover { transform: scale(1.02); }
.logo-ico { width: 44px; height: 44px; background: linear-gradient(135deg, var(--primary-subtle), var(--surface)); color: var(--primary-dark); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.15rem; border: 1px solid var(--primary-light); font-family: var(--font-mono); font-weight: 800; letter-spacing: -1px; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1); }
.logo-l1 { font-family: var(--font-heading); color: var(--text-main); font-size: 1.2rem; font-weight: 800; letter-spacing: -0.5px; line-height: 1.1; }
.logo-l2 { color: var(--text-muted); font-size: 0.65rem; letter-spacing: 1px; text-transform: uppercase; font-weight: 600; margin-top: 2px; }
.hdr-r { display: flex; align-items: center; gap: 12px; }
.chip { background: var(--surface); border: 1px solid var(--border); color: var(--text-muted); font-size: 0.7rem; font-weight: 700; padding: 6px 14px; border-radius: 100px; white-space: nowrap; font-family: var(--font-heading); text-transform: uppercase; box-shadow: var(--shadow-sm); }
.btn-hdr { background: var(--surface); border: 1px solid var(--border); color: var(--text-main); padding: 8px 18px; border-radius: 100px; font-size: 0.85rem; font-family: var(--font-heading); font-weight: 600; cursor: pointer; transition: all 0.2s ease; box-shadow: var(--shadow-sm); }
.btn-hdr:hover { background: var(--surface-alt); border-color: #cbd5e1; transform: translateY(-1px); }
.btn-live { background: var(--primary-subtle) !important; border-color: var(--primary-light) !important; color: var(--primary-dark) !important; }
.btn-live:hover { background: var(--primary-light) !important; }

/* â”€â”€ HERO â”€â”€ */
.hero { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #fff; padding: 88px 1.5rem; text-align: center; position: relative; overflow: hidden; }
.hero::before { content: ''; position: absolute; inset: 0; background: radial-gradient(circle at 50% 100%, rgba(16, 185, 129, 0.2), transparent 60%); animation: pulseGlow 6s ease-in-out infinite; }
.hero-inner { position: relative; z-index: 1; max-width: 720px; margin: 0 auto; animation: fadeUp 0.6s ease; }
.eyebrow { display: inline-flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--primary-light); font-size: 0.75rem; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; padding: 8px 20px; border-radius: 100px; margin-bottom: 24px; font-family: var(--font-heading); backdrop-filter: blur(8px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.hero h1 { font-family: var(--font-heading); font-size: clamp(2.5rem, 6vw, 4.5rem); line-height: 1.1; margin-bottom: 20px; font-weight: 800; letter-spacing: -1.5px; }
.hero h1 em { font-style: normal; color: var(--primary); text-shadow: 0 0 24px rgba(16, 185, 129, 0.4); }
.hero p { color: #94a3b8; font-size: 1.15rem; line-height: 1.6; margin-bottom: 40px; max-width: 580px; margin-left: auto; margin-right: auto; }
.pills { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
.pill { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: #cbd5e1; padding: 10px 20px; border-radius: 100px; font-size: 0.85rem; font-weight: 500; font-family: var(--font-body); backdrop-filter: blur(4px); }
.pill b { color: #fff; font-weight: 700; font-family: var(--font-heading); font-size: 0.9rem; }

/* â”€â”€ MAIN â”€â”€ */
main { max-width: 1000px; margin: -20px auto 80px; padding: 0 1.5rem; position: relative; z-index: 10; }
.page { display: none; }
.page.active { display: block; animation: fadeUp 0.5s ease forwards; }

/* â”€â”€ CARDS â”€â”€ */
.card { background: var(--surface); border-radius: var(--radius-xl); border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: var(--shadow-lg); padding: 40px; margin-bottom: 24px; position: relative; overflow: hidden; }
.card-title { font-family: var(--font-heading); font-size: 1.35rem; color: var(--text-main); margin-bottom: 8px; font-weight: 800; letter-spacing: -0.3px; }
.card-sub { font-size: 0.95rem; color: var(--text-muted); margin-bottom: 28px; line-height: 1.6; }

/* â”€â”€ GATE (LOGIN) â”€â”€ */
.gate-wrap { max-width: 480px; margin: 0 auto; text-align: center; padding: 10px 0; }
.gate-icon { font-size: 4rem; margin-bottom: 24px; animation: float 4s ease-in-out infinite; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1)); }
.gate-title { font-family: var(--font-heading); font-size: 2.2rem; color: var(--text-main); margin-bottom: 12px; font-weight: 800; letter-spacing: -0.5px; }
.gate-sub { color: var(--text-muted); font-size: 1rem; margin-bottom: 32px; line-height: 1.6; padding: 0 20px;}
.inp-wrap { position: relative; margin-bottom: 20px; text-align: left; }
.inp-wrap input { width: 100%; padding: 18px 20px 18px 52px; border: 2px solid var(--border); border-radius: var(--radius-lg); font-size: 1.05rem; font-family: var(--font-mono); font-weight: 500; color: var(--text-main); background: var(--surface-alt); outline: none; transition: all 0.2s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }
.inp-wrap input:focus { border-color: var(--primary); background: var(--surface); box-shadow: var(--shadow-glow); }
.inp-wrap input::placeholder { color: var(--text-light); font-weight: 400; font-family: var(--font-body); }
.inp-ico { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); pointer-events: none; font-size: 1.1rem; opacity: 0.6; font-family: var(--font-mono); font-weight: bold; color: var(--text-muted); }
.btn-enter { width: 100%; padding: 18px; background: var(--primary); color: #fff; border: none; border-radius: var(--radius-lg); font-size: 1.05rem; font-weight: 700; font-family: var(--font-heading); cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25); display: flex; align-items: center; justify-content: center; gap: 8px;}
.btn-enter:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(16, 185, 129, 0.35); }
.err-box { background: var(--danger-light); border: 1px solid #fca5a5; color: #b91c1c; border-radius: var(--radius-md); padding: 14px 16px; font-size: 0.9rem; margin-top: 16px; display: none; text-align: left; line-height: 1.5; font-weight: 500; box-shadow: var(--shadow-sm); }
.err-box.show { display: block; animation: scaleIn 0.2s ease; }

/* â”€â”€ BALLOT HEADER â”€â”€ */
.ballot-hdr { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: var(--radius-xl); padding: 28px 36px; margin-bottom: 24px; display: flex; align-items: center; gap: 24px; position: relative; overflow: hidden; box-shadow: var(--shadow-lg); border: 1px solid rgba(255,255,255,0.1); }
.ballot-hdr::before { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 50%; background: radial-gradient(circle at right, rgba(16, 185, 129, 0.2), transparent); pointer-events: none; }
.bh-av { width: 64px; height: 64px; border-radius: 50%; background: var(--primary-light); color: var(--primary-dark); display: flex; align-items: center; justify-content: center; font-size: 1.8rem; flex-shrink: 0; border: 3px solid var(--primary); font-family: var(--font-heading); font-weight: 700; box-shadow: 0 0 16px rgba(16,185,129,0.3); }
.bh-name { font-family: var(--font-heading); font-size: 1.4rem; color: #fff; font-weight: 800; margin-bottom: 4px; letter-spacing: -0.3px;}
.bh-meta { font-size: 0.85rem; color: #cbd5e1; font-weight: 500; font-family: var(--font-mono); background: rgba(255,255,255,0.1); display: inline-block; padding: 4px 10px; border-radius: var(--radius-sm);}
.bh-hint { margin-left: auto; font-size: 0.85rem; color: #94a3b8; text-align: right; line-height: 1.6; background: rgba(0,0,0,0.2); padding: 12px 20px; border-radius: var(--radius-lg); border: 1px solid rgba(255,255,255,0.05); }
.bh-hint b { color: #fff; font-weight: 600;}

/* â”€â”€ STICKY PROGRESS â”€â”€ */
.progress-container { position: sticky; top: 90px; z-index: 200; margin-bottom: 32px; }
.progress-tracker { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); border: 1px solid rgba(226, 232, 240, 0.8); border-radius: var(--radius-xl); padding: 18px 28px; display: flex; align-items: center; gap: 20px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05), 0 0 0 1px rgba(255,255,255,0.5) inset; }
.pt-label { font-size: 0.85rem; font-weight: 800; color: var(--text-main); white-space: nowrap; font-family: var(--font-heading); text-transform: uppercase; letter-spacing: 0.5px; }
.pt-bar-wrap { flex: 1; min-width: 140px; background: var(--border); border-radius: 100px; height: 10px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }
.pt-bar { height: 100%; border-radius: 100px; background: linear-gradient(90deg, var(--primary), var(--primary-hover)); transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); width: 0%; box-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
.pt-count { font-size: 0.9rem; color: var(--text-main); white-space: nowrap; font-weight: 700; font-family: var(--font-heading); background: var(--surface-alt); padding: 6px 12px; border-radius: var(--radius-md); border: 1px solid var(--border);}

/* â”€â”€ PHASE BANNER â”€â”€ */
.phase-banner { display: flex; align-items: center; gap: 20px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-xl); padding: 20px 28px; margin-bottom: 28px; margin-top: 16px; box-shadow: var(--shadow-md); position: relative; overflow: hidden;}
.phase-banner::after { content: ''; position: absolute; right: -20px; top: -20px; width: 100px; height: 100px; background: radial-gradient(circle, var(--primary-subtle), transparent 70%); pointer-events: none;}
.ph-num { width: 42px; height: 42px; background: var(--primary-light); color: var(--primary-dark); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 800; font-family: var(--font-heading); flex-shrink: 0; border: 2px solid var(--primary-subtle);}
.ph-txt { font-size: 0.95rem; color: var(--text-muted); line-height: 1.5; z-index: 1;}
.ph-txt b { color: var(--text-main); font-weight: 800; font-family: var(--font-heading); font-size: 1.1rem; display: block; margin-bottom: 2px; letter-spacing: -0.2px;}

/* â”€â”€ POSITION CARD â”€â”€ */
.pos-card { background: var(--surface); border-radius: var(--radius-xl); border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: var(--shadow-sm); padding: 36px; margin-bottom: 28px; transition: all 0.3s ease; scroll-margin-top: 180px; position: relative; }
.pos-card:hover { box-shadow: var(--shadow-md); border-color: var(--border-focus); }
.pos-card.has-sel { border-color: var(--primary-light); box-shadow: 0 8px 24px rgba(16, 185, 129, 0.1); background: linear-gradient(to bottom right, #ffffff, var(--primary-subtle));}
.pos-head { margin-bottom: 28px; }
.pos-name { font-family: var(--font-heading); font-size: 1.35rem; color: var(--text-main); display: flex; align-items: center; gap: 12px; margin-bottom: 8px; font-weight: 800; letter-spacing: -0.3px;}
.pos-rule { font-size: 0.9rem; color: var(--text-muted); font-weight: 500; display: inline-flex; align-items: center; gap: 8px;}
.auto-tag { display: inline-flex; align-items: center; gap: 6px; background: var(--warning-light); color: #b45309; border-radius: var(--radius-sm); padding: 4px 10px; font-size: 0.75rem; font-weight: 700; font-family: var(--font-heading); box-shadow: var(--shadow-sm); border: 1px solid #fde68a;}

/* â”€â”€ CANDIDATE CARDS â”€â”€ */
.cands-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
.cand { background: var(--surface); border: 2px solid var(--border); border-radius: var(--radius-lg); padding: 28px 20px; cursor: pointer; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); text-align: center; position: relative; user-select: none; display: flex; flex-direction: column; align-items: center; box-shadow: var(--shadow-sm); overflow: hidden;}
.cand:hover { border-color: var(--primary-light); background: var(--surface-alt); transform: translateY(-4px); box-shadow: var(--shadow-md); }
.cand.sel { border-color: var(--primary); background: #ffffff; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.15), 0 0 0 1px var(--primary) inset; transform: translateY(-4px); }
.cand-radio { position: absolute; top: 16px; right: 16px; width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border); background: var(--surface); transition: all 0.2s; display: flex; align-items: center; justify-content: center; z-index: 2;}
.cand.sel .cand-radio { border-color: var(--primary); background: var(--primary); }
.cand.sel .cand-radio::after { content: ''; width: 10px; height: 10px; background: #fff; border-radius: 50%; animation: scaleIn 0.2s ease;}

/* Updated Avatar/Image handling */
.cav { width: 80px; height: 80px; border-radius: 50%; background-color: var(--surface-alt); color: var(--text-muted); display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 800; font-family: var(--font-heading); margin-bottom: 20px; transition: all 0.2s ease; border: 3px solid var(--border); position: relative; z-index: 1; box-shadow: var(--shadow-sm); overflow: hidden; }
.cand.sel .cav { border-color: var(--primary); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }

.cname { font-weight: 800; font-size: 1.1rem; color: var(--text-main); margin-bottom: 6px; font-family: var(--font-heading); line-height: 1.2; letter-spacing: -0.2px; z-index: 1;}
.cmeta { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; margin-bottom: 12px; font-family: var(--font-mono); z-index: 1;}
.cbio { font-size: 0.85rem; color: var(--text-light); line-height: 1.5; padding-top: 16px; border-top: 1px solid var(--border); width: 100%; margin-top: auto; z-index: 1;}
.cand.sel .cbio { border-color: rgba(16, 185, 129, 0.2); color: var(--primary-dark); font-weight: 500;}

/* â”€â”€ SUBMIT ZONE â”€â”€ */
.submit-zone { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: var(--radius-xl); padding: 48px; text-align: center; margin-top: 40px; box-shadow: var(--shadow-lg); color: #fff; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
.submit-zone::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 40%; background: radial-gradient(circle at left, rgba(16, 185, 129, 0.15), transparent); pointer-events: none; }
.submit-zone h3 { font-family: var(--font-heading); font-size: 1.8rem; margin-bottom: 12px; font-weight: 800; letter-spacing: -0.5px; position: relative; z-index: 1;}
.submit-zone p { font-size: 1rem; color: #94a3b8; margin-bottom: 36px; position: relative; z-index: 1;}
.sel-summary { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius-lg); padding: 24px 32px; margin-bottom: 40px; text-align: left; font-size: 0.95rem; color: #e2e8f0; line-height: 2; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px 32px; position: relative; z-index: 1; backdrop-filter: blur(8px);}
.sel-summary b { color: #fff; font-weight: 700; font-family: var(--font-heading); font-size: 1rem; display: block; margin-bottom: 4px;}
.sel-summary .miss { color: #fca5a5; background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: var(--radius-md); border: 1px solid rgba(239, 68, 68, 0.2); }
.sel-summary .miss b { color: #fca5a5; }
.btn-sub { padding: 20px 56px; background: linear-gradient(135deg, var(--primary), var(--primary-hover)); color: #fff; border: none; border-radius: var(--radius-lg); font-size: 1.15rem; font-weight: 800; font-family: var(--font-heading); cursor: pointer; transition: all 0.3s; box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3); width: 100%; max-width: 360px; position: relative; z-index: 1; display: inline-flex; align-items: center; justify-content: center;}
.btn-sub:hover { transform: translateY(-3px); box-shadow: 0 12px 32px rgba(16, 185, 129, 0.4); }

/* â”€â”€ SUCCESS â”€â”€ */
.success-wrap { text-align: center; padding: 80px 20px; }
.s-icon { font-size: 4.5rem; margin-bottom: 28px; animation: scaleIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: inline-flex; align-items: center; justify-content: center; background: var(--primary-subtle); width: 120px; height: 120px; border-radius: 50%; box-shadow: 0 10px 30px rgba(16,185,129,0.2); border: 4px solid var(--surface);}
.s-title { font-family: var(--font-heading); font-size: 2.5rem; font-weight: 800; color: var(--text-main); margin-bottom: 16px; letter-spacing: -0.8px; }
.s-sub { color: var(--text-muted); font-size: 1.1rem; line-height: 1.6; max-width: 480px; margin: 0 auto 40px; }
.s-box { background: var(--surface-alt); border: 1px solid var(--border); border-radius: var(--radius-xl); padding: 32px; font-size: 0.95rem; color: var(--text-main); line-height: 1.8; max-width: 520px; margin: 0 auto 40px; text-align: left; box-shadow: var(--shadow-md);}
.s-box strong { font-family: var(--font-heading); color: var(--text-main); font-size: 1.1rem; display: block; margin-bottom: 12px;}
.s-box ul { list-style: none; padding-left: 0; }
.s-box li { margin-bottom: 8px; display: flex; align-items: flex-start; gap: 10px; }
.s-box li::before { content: 'âœ“'; color: var(--primary); font-weight: bold; }

/* â”€â”€ LIVE RESULTS PAGE â”€â”€ */
.live-hero { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: var(--radius-xl); padding: 48px; margin-bottom: 32px; display: flex; align-items: center; gap: 32px; position: relative; overflow: hidden; color: #fff; box-shadow: var(--shadow-lg); border: 1px solid rgba(255,255,255,0.1); }
.live-hero::after { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 60%; background: radial-gradient(circle at right, rgba(16, 185, 129, 0.2), transparent); pointer-events: none; }
.live-icon { font-size: 3.5rem; background: rgba(255,255,255,0.1); width: 96px; height: 96px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-lg); flex-shrink: 0; z-index: 1; backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.2);}
.live-hero-txt { z-index: 1; flex: 1; }
.live-hero-txt h2 { font-family: var(--font-heading); font-size: 2.2rem; font-weight: 800; margin-bottom: 12px; letter-spacing: -0.5px; }
.live-hero-txt p { font-size: 1rem; color: #94a3b8; line-height: 1.6; max-width: 500px; }
.live-meta { text-align: right; z-index: 1; background: rgba(0,0,0,0.25); padding: 24px 32px; border-radius: var(--radius-lg); border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(8px);}
.lm-voted { font-family: var(--font-heading); font-size: 3.5rem; font-weight: 800; line-height: 1; color: var(--primary); margin-bottom: 8px; text-shadow: 0 0 20px rgba(16,185,129,0.3);}
.lm-label { font-size: 0.85rem; color: #fff; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; }
.lm-pct { font-size: 0.9rem; color: #94a3b8; margin-top: 6px; font-family: var(--font-mono);}

.live-refresh { display: flex; align-items: center; gap: 16px; margin-bottom: 32px; flex-wrap: wrap; }
.refresh-badge { display: flex; align-items: center; gap: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 100px; padding: 10px 24px; font-size: 0.9rem; color: var(--text-main); font-weight: 600; box-shadow: var(--shadow-sm); }
.refresh-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--primary); animation: blink 1.4s infinite; box-shadow: 0 0 8px rgba(16,185,129,0.6);}
.btn-refresh-now { background: var(--surface); color: var(--text-main); border: 1px solid var(--border); border-radius: 100px; padding: 10px 24px; font-size: 0.9rem; font-weight: 600; font-family: var(--font-body); cursor: pointer; transition: all 0.2s; box-shadow: var(--shadow-sm);}
.btn-refresh-now:hover { background: var(--surface-alt); border-color: var(--primary-light); color: var(--primary-dark);}

.live-overall { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 48px; }
.ov-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-xl); padding: 32px 24px; text-align: center; box-shadow: var(--shadow-sm); transition: transform 0.2s ease;}
.ov-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md);}
.ov-n { font-family: var(--font-heading); font-size: 2.8rem; color: var(--text-main); line-height: 1; font-weight: 800; margin-bottom: 12px; letter-spacing: -1px;}
.ov-l { font-size: 0.85rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

.live-pos-card { background: var(--surface); border-radius: var(--radius-xl); border: 1px solid var(--border); box-shadow: var(--shadow-md); padding: 40px; margin-bottom: 32px; }
.lpc-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; margin-bottom: 28px; flex-wrap: wrap; border-bottom: 2px solid var(--surface-alt); padding-bottom: 24px; }
.lpc-name { font-family: var(--font-heading); font-size: 1.5rem; color: var(--text-main); font-weight: 800; display: flex; align-items: center; gap: 12px; margin-bottom: 8px; letter-spacing: -0.3px;}
.lpc-total { font-size: 0.95rem; color: var(--text-muted); font-weight: 500; }

.live-cand-row { display: flex; align-items: center; gap: 20px; margin-bottom: 16px; padding: 24px; background: var(--surface-alt); border-radius: var(--radius-lg); border: 2px solid transparent; transition: all 0.3s; }
.live-cand-row.leading { border-color: var(--primary-light); background: var(--surface); box-shadow: var(--shadow-md); }
.lcr-rank { width: 44px; height: 44px; border-radius: 50%; background: var(--border); color: var(--text-muted); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 800; font-family: var(--font-heading); flex-shrink: 0; }
.lcr-avatar { width: 44px; height: 44px; border-radius: 50%; background-color: var(--border); color: var(--text-muted); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 800; font-family: var(--font-heading); flex-shrink: 0; overflow: hidden; border: 2px solid var(--border); }
.live-cand-row.leading .lcr-rank { background: var(--primary-subtle); color: var(--primary-dark); border: 2px solid var(--primary-light);}
.live-cand-row.leading .lcr-avatar { border-color: var(--primary); background-color: var(--primary-subtle); color: var(--primary-dark); }
.lcr-info { flex: 1; min-width: 0; }
.lcr-name { font-weight: 800; font-size: 1.2rem; color: var(--text-main); display: flex; align-items: center; gap: 12px; margin-bottom: 6px; font-family: var(--font-heading); }
.lcr-meta { font-size: 0.9rem; color: var(--text-muted); font-weight: 500; font-family: var(--font-mono);}
.lcr-bar-wrap { background: var(--border); border-radius: 100px; height: 14px; overflow: hidden; margin-top: 16px; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);}
.lcr-bar { height: 100%; border-radius: 100px; background: var(--text-light); transition: width 1s cubic-bezier(0.22, 1, 0.36, 1); }
.live-cand-row.leading .lcr-bar { background: linear-gradient(90deg, var(--primary), var(--primary-hover)); }
.lcr-pct { font-size: 1.4rem; font-weight: 800; color: var(--text-main); white-space: nowrap; text-align: right; font-family: var(--font-heading); }
.live-cand-row.leading .lcr-pct { color: var(--primary); }
.lcr-votes { font-size: 0.9rem; color: var(--text-muted); text-align: right; font-weight: 600; margin-top: 4px; }
.runner-assign { background: var(--warning-light); border: 1px solid #fcd34d; border-radius: var(--radius-md); padding: 20px 24px; margin-top: 28px; font-size: 0.95rem; color: #92400e; display: flex; gap: 16px; align-items: flex-start; box-shadow: var(--shadow-sm);}

/* â”€â”€ ADMIN/FORMS â”€â”€ */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
@media(max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
.fg { display: flex; flex-direction: column; gap: 8px; }
.fg.full { grid-column: 1 / -1; }
label { font-size: 0.85rem; font-weight: 700; color: var(--text-main); font-family: var(--font-body); text-transform: uppercase; letter-spacing: 0.5px;}
input[type=text], input[type=email], input[type=password], select, textarea { padding: 14px 16px; border: 2px solid var(--border); border-radius: var(--radius-md); font-size: 1rem; font-family: var(--font-body); color: var(--text-main); background: var(--surface-alt); outline: none; transition: all 0.2s; }
input:focus, select:focus, textarea:focus { border-color: var(--primary); background: var(--surface); box-shadow: var(--shadow-glow); }
.btn { padding: 14px 28px; border-radius: var(--radius-md); border: none; cursor: pointer; font-size: 0.95rem; font-weight: 700; font-family: var(--font-heading); transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px;}
.btn-p { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);}
.btn-p:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);}
.btn-o { background: var(--surface); color: var(--text-main); border: 2px solid var(--border); }
.btn-o:hover { background: var(--surface-alt); border-color: var(--text-light);}
.btn-d { background: var(--danger-light); color: var(--danger); padding: 8px 16px; font-size: 0.85rem; border: none; border-radius: var(--radius-sm); font-weight: 600; cursor: pointer; transition: all 0.2s;}
.btn-d:hover { background: #fecaca; transform: translateY(-1px);}

/* TABLES */
.twrap { overflow-x: auto; border-radius: var(--radius-lg); border: 1px solid var(--border); background: var(--surface); box-shadow: var(--shadow-sm);}
table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
thead { background: var(--surface-alt); border-bottom: 2px solid var(--border); }
thead th { padding: 18px 20px; text-align: left; font-weight: 700; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; font-family: var(--font-heading);}
tbody tr { border-bottom: 1px solid var(--border); transition: background 0.2s;}
tbody tr:hover { background: var(--surface-alt); }
tbody td { padding: 16px 20px; color: var(--text-main); vertical-align: middle; }
.badge { display: inline-flex; align-items: center; padding: 6px 14px; border-radius: 100px; font-size: 0.8rem; font-weight: 700; font-family: var(--font-heading); letter-spacing: 0.5px;}
.bg { background: var(--primary-subtle); color: var(--primary-dark); }
.bo { background: var(--warning-light); color: #b45309; }
.bp { background: #f3e8ff; color: #6b21a8; }

/* ADMIN TABS */
.atabs { display: flex; gap: 8px; background: var(--surface-alt); padding: 8px; border-radius: var(--radius-lg); margin-bottom: 32px; flex-wrap: wrap; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);}
.atab { padding: 14px 28px; border-radius: var(--radius-md); border: none; cursor: pointer; font-size: 0.95rem; font-weight: 700; font-family: var(--font-heading); transition: all 0.2s; background: transparent; color: var(--text-muted); display: flex; align-items: center; gap: 8px;}
.atab.active { background: var(--surface); color: var(--text-main); box-shadow: var(--shadow-sm); }
.atab:hover:not(.active) { color: var(--text-main); background: rgba(255,255,255,0.5);}

.admin-hdr-bar { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: var(--radius-xl); padding: 40px; margin-bottom: 40px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 24px; color: #fff; box-shadow: var(--shadow-lg); border: 1px solid rgba(255,255,255,0.1);}
.admin-hdr-bar h2 { font-family: var(--font-heading); font-size: 2rem; font-weight: 800; margin-bottom: 8px; letter-spacing: -0.5px;}
.admin-hdr-bar p { color: #94a3b8; font-size: 1rem; }
.toggle-wrap { display: flex; align-items: center; gap: 12px; font-weight: 700; font-family: var(--font-heading); font-size: 0.9rem;}
.toggle { position: relative; width: 56px; height: 32px; cursor: pointer; }
.toggle input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; inset: 0; background: rgba(255,255,255,0.2); border-radius: 100px; transition: 0.3s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);}
.slider::before { content: ''; position: absolute; height: 24px; width: 24px; left: 4px; bottom: 4px; background: #fff; border-radius: 50%; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);}
input:checked + .slider { background: var(--primary); }
input:checked + .slider::before { transform: translateX(24px); }
.btn-logout { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 12px 24px; border-radius: var(--radius-md); font-weight: 700; font-family: var(--font-heading); cursor: pointer; transition: all 0.2s;}
.btn-logout:hover { background: rgba(255,255,255,0.2); transform: translateY(-1px);}

/* TOAST */
#toast { position: fixed; bottom: 32px; right: 32px; background: #0f172a; color: #fff; padding: 16px 24px; border-radius: var(--radius-md); font-size: 0.95rem; font-weight: 600; font-family: var(--font-body); box-shadow: var(--shadow-lg); z-index: 9999; transform: translateY(100px); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; gap: 12px; border: 1px solid rgba(255,255,255,0.1);}
#toast.show { transform: translateY(0); opacity: 1; }
#toast.err { background: var(--danger); border-color: rgba(0,0,0,0.1); }

.empty { text-align: center; padding: 80px 20px; color: var(--text-muted); }
.empty .ei { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; filter: grayscale(1); }

footer { background: #ffffff; color: var(--text-muted); text-align: center; padding: 40px 20px; font-size: 0.9rem; font-family: var(--font-body); border-top: 1px solid var(--border); position: relative; z-index: 10;}
footer strong { color: var(--text-main); font-family: var(--font-heading); font-weight: 800; }

@media(max-width: 768px) {
  .hdr { padding: 0 1rem; }
  main { padding: 32px 1rem 60px; margin-top: 0;}
  .card { padding: 24px 16px; }
  .ballot-hdr { flex-direction: column; text-align: center; padding: 24px 16px; }
  .bh-hint { text-align: center; margin-left: 0; width: 100%; }
  .progress-tracker { flex-direction: column; align-items: stretch; }
  .pt-bar-wrap { width: 100%; }
  .live-hero { flex-direction: column; text-align: center; padding: 32px 20px; }
  .live-meta { text-align: center; width: 100%; }
  .live-cand-row { flex-direction: column; align-items: stretch; gap: 16px; text-align: center;}
  .lcr-rank, .lcr-avatar { margin: 0 auto;}
  .live-cand-row > div:last-child { text-align: center; width: 100%; display: flex; justify-content: space-between; align-items: center; background: var(--surface); padding: 12px; border-radius: var(--radius-md); border: 1px solid var(--border);}
  .admin-hdr-bar { flex-direction: column; text-align: center;}
  .toggle-wrap { justify-content: space-between; width: 100%;}
  .btn-logout { width: 100%;}
}
</style>

<!-- Add Supabase JS Client Library -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- INITIAL LOADING OVERLAY -->
<div id="loading-overlay">
  <div class="spinner"></div>
  <div style="font-family: var(--font-heading); font-size: 1.25rem; color: var(--text-main); font-weight: 800; letter-spacing: -0.3px;">Initializing Secure Terminal...</div>
  <div style="color: var(--text-muted); font-size: 0.9rem; margin-top: 8px;">Connecting to ESRC database</div>
</div>

<!-- STATUS BAR -->
<div id="status-bar">
  <span class="sdot"></span>
  <span id="status-text">Connecting to Live Server...</span>
</div>

<!-- HEADER -->
<header>
  <div class="hdr">
    <div class="logo" onclick="showPage('voter')">
      <div class="logo-ico">&lt;/&gt;</div>
      <div>
        <div class="logo-l1">ESRC</div>
        <div class="logo-l2">Embedded System Research Center</div>
      </div>
    </div>
    <div class="hdr-r">
      <div class="chip">2026â€“2027 Elections</div>
      <button class="btn-hdr btn-live" onclick="showPage('live')">ğŸ“¡ Live Results</button>
      <button class="btn-hdr" onclick="showPage('admin')">ğŸ›¡ï¸ Admin</button>
    </div>
  </div>
</header>

<!-- HERO -->
<div class="hero" id="hero-section">
  <div class="hero-inner">
    <div class="eyebrow">âš¡ Secure Voting Terminal</div>
    <h1>ESRC Committee <br><em>Elections 2026â€“2027</em></h1>
    <p>Vote for all positions in a single seamless ballot. Runner-up roles are automatically assigned based on total vote counts.</p>
    <div class="pills">
      <div class="pill">ğŸ§‘â€ğŸ’» <b id="total-pill">0</b> Voters Registered</div>
      <div class="pill">ğŸ›ï¸ <b>10</b> Direct Positions</div>
      <div class="pill">âš¡ <b>8</b> Auto-Roles</div>
    </div>
  </div>
</div>

<!-- MAIN -->
<main>

<!-- â•â• VOTER PAGE â•â• -->
<div id="page-voter" class="page active">

  <div class="card gate-wrap" id="voter-gate">
    <div class="gate-icon">ğŸ—³ï¸</div>
    <div class="gate-title">Access Your Ballot</div>
    <div class="gate-sub">Enter your Student ID exactly as registered. You will vote for <strong>all positions</strong> in one single secure session.</div>
    <div class="inp-wrap">
      <span class="inp-ico">&gt;_</span>
      <input type="text" id="voter-id-input" placeholder="e.g. 241-15-519" onkeydown="if(event.key==='Enter')verifyVoter()"/>
    </div>
    <button class="btn-enter" onclick="verifyVoter()" id="btn-verify">
      Verify &amp; Open Ballot â†’
    </button>
    <div class="err-box" id="gate-err"></div>
  </div>

  <div id="ballot-section" style="display:none">
    <div class="ballot-hdr">
      <div class="bh-av">ğŸ§‘â€ğŸ’»</div>
      <div style="flex:1">
        <div class="bh-name" id="bh-name"></div>
        <div class="bh-meta" id="bh-meta"></div>
      </div>
      <div class="bh-hint">Select <b>one</b> candidate per position.<br>Runner-ups are auto-assigned.</div>
    </div>

    <!-- Sticky Progress Tracker -->
    <div class="progress-container">
      <div class="progress-tracker">
        <span class="pt-label">Ballot Progress</span>
        <div class="pt-bar-wrap"><div class="pt-bar" id="pt-bar"></div></div>
        <span class="pt-count" id="pt-count">0 / 0 selected</span>
      </div>
    </div>

    <div id="ballot-body"></div>

    <div class="submit-zone">
      <h3>Review &amp; Submit</h3>
      <p>Please review your choices below. Once submitted, your vote is <strong>final</strong> and cannot be altered.</p>
      <div class="sel-summary" id="sel-summary"></div>
      <button class="btn-sub" id="btn-submit" onclick="submitVote()">
        Confirm &amp; Submit Vote
      </button>
    </div>
  </div>

  <div class="card" id="success-section" style="display:none">
    <div class="success-wrap">
      <div class="s-icon">ğŸš€</div>
      <div class="s-title">Vote Securely Submitted!</div>
      <p class="s-sub">Thank you, <strong id="success-name"></strong>. Your cryptographic ballot for the ESRC Committee Elections has been recorded.</p>
      <div class="s-box">
        <strong>ğŸ“‹ Post-Election Protocol:</strong>
        <ul>
          <li>Your votes instantly update the live tallies.</li>
          <li>President runner-up inherits VP-1.</li>
          <li>General Secretary runner-up inherits AGS-1.</li>
          <li>Executive runner-ups inherit Assistant roles.</li>
        </ul>
      </div>
      <button class="btn-o btn" onclick="location.reload()">Return to Home Terminal</button>
    </div>
  </div>

</div>

<!-- â•â• LIVE RESULTS PAGE â•â• -->
<div id="page-live" class="page">

  <div class="live-hero">
    <div class="live-icon">ğŸ“¡</div>
    <div class="live-hero-txt">
      <h2>Live Results Dashboard</h2>
      <p>Real-time vote counting for all positions. Percentages represent the share of total votes cast for that specific role.</p>
    </div>
    <div class="live-meta">
      <div class="lm-voted" id="lv-voted">0</div>
      <div class="lm-label">Total Votes Cast</div>
      <div class="lm-pct" id="lv-pct">of 0 registered</div>
    </div>
  </div>

  <div class="live-refresh">
    <div class="refresh-badge">
      <span class="refresh-dot"></span>
      Updating in <span style="font-family:var(--font-heading); font-weight:800; color:var(--primary); margin:0 4px;" id="lv-countdown">10</span>s
    </div>
    <button class="btn-refresh-now" onclick="renderLive()" id="btn-refresh">Refresh Now</button>
    <div style="margin-left:auto;font-size:0.85rem;color:var(--text-muted); font-family: var(--font-mono);" id="lv-lastupdate">â€”</div>
  </div>

  <div class="live-overall" id="lv-overall"></div>
  <div id="lv-body"></div>

</div>

<!-- â•â• ADMIN PAGE â•â• -->
<div id="page-admin" class="page">

  <div id="admin-gate" class="gate-wrap" style="padding-top: 40px;">
    <div class="card">
      <div class="card-title" style="margin-bottom: 24px; font-size: 1.6rem; text-align: center;">ğŸ›¡ï¸ Admin Auth</div>
      <div class="fg" style="margin-bottom:28px">
        <label>Master Password</label>
        <input type="password" id="admin-pass" placeholder="Enter secure password..." onkeydown="if(event.key==='Enter')adminLogin()"/>
      </div>
      <button class="btn-enter" onclick="adminLogin()" id="btn-admin-login">Access Admin Panel</button>
      <div class="err-box" id="admin-err"></div>
    </div>
  </div>

  <div id="admin-panel" style="display:none">
    <div class="admin-hdr-bar">
      <div>
        <h2>Election Control Center</h2>
        <p>Manage voters, candidates, and oversee real-time system metrics.</p>
      </div>
      <div style="display:flex;align-items:center;gap:24px;flex-wrap:wrap">
        <div class="toggle-wrap">
          <span id="elec-lbl">Accepting Votes</span>
          <label class="toggle"><input type="checkbox" id="elec-toggle" onchange="toggleElection()"/><span class="slider"></span></label>
        </div>
        <div class="toggle-wrap">
          <span id="live-lbl">Public Live Results</span>
          <label class="toggle"><input type="checkbox" id="live-toggle" onchange="toggleLive()"/><span class="slider"></span></label>
        </div>
        <button class="btn-logout" onclick="adminLogout()">Sign Out</button>
      </div>
    </div>

    <div class="atabs">
      <button class="atab active" onclick="switchATab('voters',this)">ğŸ§‘â€ğŸ’» Voters Registry (<span id="atab-vc">0</span>)</button>
      <button class="atab" onclick="switchATab('candidates',this)">ğŸ›ï¸ Candidates Setup</button>
      <button class="atab" onclick="switchATab('results',this)">ğŸ“ˆ Analytics & Reports</button>
    </div>

    <!-- VOTERS -->
    <div id="atab-voters">
      <div class="card">
        <div class="card-title">Add Voter Manually</div>
        <div class="card-sub">Register members who were missed in the initial import.</div>
        <div class="form-grid">
          <div class="fg"><label>Full Name *</label><input type="text" id="nv-name" placeholder="John Doe"/></div>
          <div class="fg"><label>Student ID *</label><input type="text" id="nv-sid" placeholder="e.g. 241-15-519"/></div>
          <div class="fg"><label>Email</label><input type="email" id="nv-email" placeholder="name@diu.edu.bd"/></div>
          <div class="fg"><label>Department</label><input type="text" id="nv-dept" placeholder="e.g. CSE"/></div>
          <div class="fg"><label>Batch</label><input type="text" id="nv-batch" placeholder="e.g. Batch 65"/></div>
        </div>
        <div style="margin-top: 32px;"><button class="btn btn-p" id="btn-add-voter" onclick="addVoter()">Register Voter</button></div>
      </div>
      
      <div class="card">
        <div class="card-title">Voter Directory</div>
        <div class="card-sub" id="voter-count-lbl">â€”</div>
        <div style="display:flex; gap:16px; margin-bottom: 24px; flex-wrap: wrap;">
          <input type="text" placeholder="Search by name, ID or departmentâ€¦" oninput="filterVoters(this.value)" style="flex:1; min-width: 200px;"/>
          <button class="btn btn-o" onclick="renderVoterTable()">Refresh Directory</button>
        </div>
        <div class="twrap">
          <table>
            <thead><tr><th>#</th><th>Name</th><th>Student ID</th><th>Dept</th><th>Batch</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="voter-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- CANDIDATES -->
    <div id="atab-candidates" style="display:none">
      <div class="card">
        <div class="card-title">Register Candidate</div>
        <div class="card-sub">Add candidates for the 10 direct election positions. Provide a public URL (Imgur, Google Drive, etc.) for the image.</div>
        <div class="form-grid">
          <div class="fg"><label>Full Name *</label><input type="text" id="nc-name" placeholder="Candidate Name"/></div>
          <div class="fg"><label>Student ID</label><input type="text" id="nc-sid" placeholder="e.g. 241-15-519"/></div>
          <div class="fg"><label>Target Position *</label>
            <select id="nc-pos">
              <option value="">â€” Select Target Position â€”</option>
              <optgroup label="Phase 1 Â· Leadership">
                <option value="President">President</option>
                <option value="Vice President - 2">Vice President - 2</option>
                <option value="General Secretary">General Secretary</option>
                <option value="Assistant General Secretary - 2">Assistant General Secretary - 2</option>
              </optgroup>
              <optgroup label="Phase 2 Â· Executive Council">
                <option value="Treasurer">Treasurer</option>
                <option value="Women's Secretary">Women's Secretary</option>
                <option value="Media Secretary">Media Secretary</option>
                <option value="Office Secretary">Office Secretary</option>
                <option value="Organizing Secretary">Organizing Secretary</option>
                <option value="Press Secretary">Press Secretary</option>
              </optgroup>
            </select>
          </div>
          <div class="fg"><label>Department</label><input type="text" id="nc-dept" placeholder="e.g. CSE"/></div>
          <div class="fg"><label>Batch</label><input type="text" id="nc-batch" placeholder="e.g. Batch 65"/></div>
          <div class="fg"><label>Image URL (Optional)</label><input type="text" id="nc-image" placeholder="https://example.com/image.jpg"/></div>
          <div class="fg full"><label>Campaign Bio</label><textarea id="nc-bio" placeholder="Short manifesto or vision statement..."></textarea></div>
        </div>
        <div style="margin-top: 32px;"><button class="btn btn-p" id="btn-add-cand" onclick="addCandidate()">Register Candidate</button></div>
      </div>
      <div class="card">
        <div class="card-title">Active Ballot Candidates</div>
        <div class="twrap" style="margin-top:24px;">
          <table>
            <thead><tr><th>#</th><th>Name</th><th>ID</th><th>Position</th><th>Dept</th><th>Batch</th><th>Action</th></tr></thead>
            <tbody id="cand-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="atab-results" style="display:none">
      <div class="live-overall">
        <div class="ov-card"><div class="ov-n" id="r-total">â€”</div><div class="ov-l">Voters</div></div>
        <div class="ov-card"><div class="ov-n" id="r-voted">â€”</div><div class="ov-l">Cast</div></div>
        <div class="ov-card"><div class="ov-n" id="r-pct">â€”</div><div class="ov-l">Turnout</div></div>
        <div class="ov-card"><div class="ov-n" id="r-pos">â€”</div><div class="ov-l">Direct</div></div>
        <div class="ov-card"><div class="ov-n" id="r-auto">8</div><div class="ov-l">Auto</div></div>
      </div>
      <div class="card">
        <div class="card-title">Final Assignment Report</div>
        <div class="card-sub">Detailed breakdown of winners and automatically assigned runner-ups.</div>
        <div id="results-body"><div class="empty"><div class="ei">ğŸ“­</div><p>Awaiting votes...</p></div></div>
      </div>
    </div>

  </div>
</div>

</main>

<div id="toast"></div>

<footer>
  <strong>ESRC</strong> â€” Embedded System Research Center &nbsp;&middot;&nbsp; 2026â€“2027 Secure Election Portal
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPABASE INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = 'https://pxqruwscthmedqmnaruz.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_58wOpVLaXUajnX0fUdtWPQ_ByhqfzXd';
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const POSITIONS = [
  { id:'president', name:'President', phase:1, batchNote:'Batch 61â€“63', runnerUpRole:'Vice President - 1' },
  { id:'vp2', name:'Vice President - 2', phase:1, batchNote:'Batch 64â€“65', runnerUpRole:null },
  { id:'gs', name:'General Secretary', phase:1, batchNote:'Batch 63â€“64', runnerUpRole:'Assistant General Secretary - 1' },
  { id:'ags2', name:'Assistant General Secretary - 2', phase:1, batchNote:'Batch 66+', runnerUpRole:null },
  { id:'treasurer', name:'Treasurer', phase:2, batchNote:'Batch 63â€“67', runnerUpRole:'Assistant Treasurer' },
  { id:'womens', name:"Women's Secretary", phase:2, batchNote:'Batch 63â€“67', runnerUpRole:"Joint Women's Secretary" },
  { id:'media', name:'Media Secretary', phase:2, batchNote:'Batch 63â€“67', runnerUpRole:'Assistant Media Secretary' },
  { id:'office', name:'Office Secretary', phase:2, batchNote:'Batch 63â€“67', runnerUpRole:'Assistant Office Secretary' },
  { id:'organizing', name:'Organizing Secretary', phase:2, batchNote:'Batch 63â€“67', runnerUpRole:'Assistant Organizing Secretary' },
  { id:'press', name:'Press Secretary', phase:2, batchNote:'Batch 63â€“67', runnerUpRole:'Assistant Press Secretary' },
];

let voters          = [];
let candidates      = [];
let votes           = {}; 
let selections      = {}; 

let electionOpen    = true;
let liveResultsOpen = true; 
let currentVoter    = null;

const ADMIN_PASS    = 'admin123';

// â”€â”€ UI HELPERS FOR LOADING STATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setBtnLoading(btnId, isLoading, originalText = '') {
  const btn = document.getElementById(btnId);
  if (!btn) return;
  if (isLoading) {
    btn.dataset.origText = btn.innerHTML;
    btn.classList.add('btn-loading');
    btn.innerHTML = `<svg class="inline-spinner" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25" style="opacity:0.25;"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" style="opacity:0.75;"></path></svg> Processing...`;
  } else {
    btn.classList.remove('btn-loading');
    btn.innerHTML = originalText || btn.dataset.origText;
  }
}

// â”€â”€ INITIAL DATA FETCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', async () => {
  await fetchData();
  
  // Hide loading screen smoothly
  const loader = document.getElementById('loading-overlay');
  loader.style.opacity = '0';
  setTimeout(() => loader.style.display = 'none', 400);
});

async function fetchData() {
  try {
    // 1. Fetch Settings
    const { data: settings } = await supabaseClient.from('election_settings').select('*').single();
    if(settings) {
      electionOpen = settings.is_open;
      liveResultsOpen = settings.live_results_public;
      updateStatusUI();
    }

    // 2. Fetch Voters
    const { data: vData } = await supabaseClient.from('voters').select('*');
    if(vData) {
      voters = vData.map(v => ({
        id: v.id, name: v.full_name, sid: v.student_id, 
        email: v.email, dept: v.department, batch: v.batch, voted: v.has_voted
      }));
    }

    // 3. Fetch Candidates
    const { data: cData } = await supabaseClient.from('candidates').select('*');
    if(cData) {
      candidates = cData.map(c => ({
        id: c.id, name: c.full_name, sid: c.student_id, 
        position: c.target_position, dept: c.department, batch: c.batch, bio: c.bio, imageUrl: c.image_url
      }));
    }

    // 4. Fetch Votes
    const { data: vtData } = await supabaseClient.from('votes').select('*');
    votes = {};
    if(vtData) {
      vtData.forEach(v => {
        if(!votes[v.voter_id]) votes[v.voter_id] = {};
        votes[v.voter_id][v.target_position] = v.candidate_id;
      });
    }

    // Trigger UI updates
    document.getElementById('total-pill').textContent = voters.length;
    
    if(document.getElementById('page-admin').classList.contains('active')) {
      renderVoterTable(); 
      renderCandTable();
      if(document.getElementById('atab-results').style.display !== 'none') renderResults();
    }
    
    if(document.getElementById('page-live').classList.contains('active')) {
      renderLive();
    }

  } catch (err) {
    console.error("Fetch Error:", err);
  }
}

function updateStatusUI() {
  const bar = document.getElementById('status-bar');
  const txt = document.getElementById('status-text');
  const elecLbl = document.getElementById('elec-lbl');
  const elecToggle = document.getElementById('elec-toggle');
  const liveLbl = document.getElementById('live-lbl');
  const liveToggle = document.getElementById('live-toggle');

  if(elecToggle) elecToggle.checked = electionOpen;
  if(liveToggle) liveToggle.checked = liveResultsOpen;

  if(electionOpen) {
    bar.className = '';
    txt.textContent = 'System Active: Secure Voting is currently OPEN';
    if(elecLbl) elecLbl.textContent = 'Accepting Votes';
  } else {
    bar.className = 'closed';
    txt.textContent = 'System Locked: Secure Voting is CLOSED';
    if(elecLbl) elecLbl.textContent = 'Election Closed';
  }
  
  if(liveLbl) liveLbl.textContent = liveResultsOpen ? 'Public Live Results' : 'Results Hidden';
}

// â”€â”€ PAGE NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPage(p) {
  document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
  document.getElementById('page-' + p).classList.add('active');
  document.getElementById('hero-section').style.display = (p === 'voter') ? '' : 'none';
  if(p === 'voter') resetGate();
  if(p === 'live') {
    startLiveRefresh();
  } else {
    stopLiveRefresh();
  }
  window.scrollTo({top:0, behavior:'smooth'});
}

// â”€â”€ VOTER FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetGate() {
  show('voter-gate'); hide('ballot-section'); hide('success-section');
  document.getElementById('voter-id-input').value = '';
  document.getElementById('gate-err').classList.remove('show');
  currentVoter = null; selections = {};
}

async function verifyVoter() {
  if(!electionOpen) { showErr('gate-err', 'The election is currently closed.'); return; }
  const sid = document.getElementById('voter-id-input').value.trim();
  if(!sid) { showErr('gate-err', 'Please enter your Student ID.'); return; }
  
  setBtnLoading('btn-verify', true);
  
  // Re-fetch to ensure we have latest vote status before letting them in
  await fetchData();
  
  const v = voters.find(x => x.sid === sid);
  if(!v) { 
    showErr('gate-err', 'ID not found. Please verify your student ID.'); 
    setBtnLoading('btn-verify', false, 'Verify &amp; Open Ballot â†’');
    return; 
  }
  if(v.voted || votes[v.id]) { 
    showErr('gate-err', 'You have already voted. Only one submission is allowed.'); 
    setBtnLoading('btn-verify', false, 'Verify &amp; Open Ballot â†’');
    return; 
  }
  
  setBtnLoading('btn-verify', false, 'Verify &amp; Open Ballot â†’');
  currentVoter = v;
  selections[v.id] = {};
  buildBallot();
  hide('voter-gate');
  show('ballot-section');
  document.getElementById('bh-name').textContent = v.name;
  document.getElementById('bh-meta').textContent = v.dept + ' â€¢ ' + v.batch + ' â€¢ ID: ' + v.sid;
  updateProgress();
  window.scrollTo({top:0, behavior:'smooth'});
}

function buildBallot() {
  const body = document.getElementById('ballot-body');
  body.innerHTML = '';
  let currentPhase = 0;

  POSITIONS.forEach(pos => {
    const cands = candidates.filter(c => c.position === pos.name);
    if(!cands.length) return;

    if(pos.phase !== currentPhase) {
      currentPhase = pos.phase;
      const banner = document.createElement('div');
      banner.className = 'phase-banner';
      banner.innerHTML = `
        <div class="ph-num">${pos.phase}</div>
        <div class="ph-txt">
          <b>${pos.phase === 1 ? 'Phase 1: Leadership Council' : 'Phase 2: Executive Board'}</b>
          <span>${pos.phase === 1 ? 'President, VP, and General Secretaries' : 'Specialized Executive Secretaries'}</span>
        </div>`;
      body.appendChild(banner);
    }

    const div = document.createElement('div');
    div.className = 'pos-card';
    div.id = 'poscard-' + pos.id;
    div.innerHTML = `
      <div class="pos-head">
        <div class="pos-name">
          ${esc(pos.name)}
          ${pos.runnerUpRole ? `<span class="auto-tag">âš¡ Runner-up becomes ${esc(pos.runnerUpRole)}</span>` : ''}
        </div>
        <div class="pos-rule"><span>ğŸ“Œ</span> ${esc(pos.batchNote)} &middot; Select exactly one candidate</div>
      </div>
      <div class="cands-grid" id="grid-${pos.id}">
        ${cands.map(c => `
          <div class="cand" id="cc-${c.id}" data-posid="${pos.id}" data-cid="${c.id}" onclick="pick(this)">
            <div class="cand-radio"></div>
            <div class="cav" ${c.imageUrl ? `style="background-image: url('${esc(c.imageUrl)}'); background-size: cover; background-position: center; border-color: transparent;"` : ''}>
              ${c.imageUrl ? '' : c.name.trim()[0]}
            </div>
            <div class="cname">${esc(c.name)}</div>
            <div class="cmeta">${esc(c.batch)} &middot; ${esc(c.dept)}</div>
            ${c.bio ? `<div class="cbio">"${esc(c.bio)}"</div>` : ''}
          </div>`).join('')}
      </div>`;
    body.appendChild(div);
  });

  if(!body.children.length) {
    body.innerHTML = '<div class="card"><div class="empty"><div class="ei">ğŸª«</div><p>No candidates available yet.</p></div></div>';
  }
}

function pick(el) {
  const posId   = el.dataset.posid;
  const cid     = el.dataset.cid; // UUID strings instead of ints
  const pos     = POSITIONS.find(p => p.id === posId);
  const posName = pos ? pos.name : posId;
  
  document.querySelectorAll(`#grid-${posId} .cand`).forEach(e => e.classList.remove('sel'));
  el.classList.add('sel');
  
  const posCard = document.getElementById('poscard-' + posId);
  if(posCard) posCard.classList.add('has-sel');
  
  selections[currentVoter.id][posName] = cid;
  updateProgress();
  updateSummary();
}

function updateProgress() {
  const activePosCount = POSITIONS.filter(p => candidates.some(c => c.position === p.name)).length;
  const selected = Object.keys(selections[currentVoter.id] || {}).length;
  const pct = activePosCount ? Math.round(selected / activePosCount * 100) : 0;
  
  document.getElementById('pt-bar').style.width = pct + '%';
  document.getElementById('pt-count').textContent = `${selected} / ${activePosCount} Processed`;
}

function updateSummary() {
  const sel = selections[currentVoter.id] || {};
  const lines = POSITIONS
    .filter(p => candidates.some(c => c.position === p.name))
    .map(p => {
      const cid = sel[p.name];
      if(cid) {
        const c = candidates.find(x => x.id === cid);
        return `<div><span style="color:var(--primary);margin-right:8px;font-size:1.2rem;vertical-align:sub;">âœ…</span><b>${esc(p.name)}</b>${esc(c ? c.name : 'â€”')}</div>`;
      }
      return `<div class="miss"><span>âš ï¸</span> <b>${esc(p.name)}</b>Pending selection</div>`;
    }).join('');
  document.getElementById('sel-summary').innerHTML = lines || '<em>No selections made yet.</em>';
}

async function submitVote() {
  const sel = selections[currentVoter.id] || {};
  const activePosCount = POSITIONS.filter(p => candidates.some(c => c.position === p.name)).length;
  
  if(Object.keys(sel).length < activePosCount) { 
    toast('Please make a selection for every position before submitting.', true); 
    return; 
  }
  if(!confirm('Are you sure you want to submit your ballot? Your choices are final and securely encrypted.')) return;
  
  // Format for Supabase Insertion
  const votesToInsert = Object.keys(sel).map(posName => ({
    voter_id: currentVoter.id,
    candidate_id: sel[posName],
    target_position: posName
  }));

  setBtnLoading('btn-submit', true);
  
  try {
    const { error: voteErr } = await supabaseClient.from('votes').insert(votesToInsert);
    if (voteErr) { throw voteErr; }

    const { error: uErr } = await supabaseClient.from('voters').update({ has_voted: true }).eq('id', currentVoter.id);
    if (uErr) { throw uErr; }

    // Success State
    votes[currentVoter.id] = sel;
    currentVoter.voted = true;
    hide('ballot-section');
    show('success-section');
    document.getElementById('success-name').textContent = currentVoter.name;
    
    // Refresh Global Sync
    await fetchData();

  } catch(err) {
    toast('Error submitting vote: ' + err.message, true);
  } finally {
    setBtnLoading('btn-submit', false, 'Confirm &amp; Submit Vote');
  }
}

// â”€â”€ ADMIN CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleElection() {
  electionOpen = document.getElementById('elec-toggle').checked;
  await supabaseClient.from('election_settings').update({is_open: electionOpen}).eq('id', 1);
  updateStatusUI();
  toast(electionOpen ? 'System is accepting votes.' : 'System is locked.');
}

async function toggleLive() {
  liveResultsOpen = document.getElementById('live-toggle').checked;
  await supabaseClient.from('election_settings').update({live_results_public: liveResultsOpen}).eq('id', 1);
  updateStatusUI();
  toast(liveResultsOpen ? 'Live results are now visible.' : 'Live results are hidden.');
  if (document.getElementById('page-live').classList.contains('active')) renderLive();
}

function adminLogin() {
  if(document.getElementById('admin-pass').value === ADMIN_PASS) {
    hide('admin-gate'); show('admin-panel');
    renderVoterTable(); renderCandTable();
    toast('Authenticated successfully.');
  } else {
    showErr('admin-err', 'Invalid credentials.');
  }
}

function adminLogout() {
  show('admin-gate'); hide('admin-panel');
  document.getElementById('admin-pass').value = '';
}

function switchATab(name, btn) {
  ['voters','candidates','results'].forEach(t => document.getElementById('atab-'+t).style.display = t === name ? '' : 'none');
  document.querySelectorAll('.atab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if(name === 'results') renderResults();
}

// â”€â”€ ADMIN: VOTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let vFilter = '';
function filterVoters(q) { vFilter = q.toLowerCase(); renderVoterTable(); }

async function addVoter() {
  const name  = document.getElementById('nv-name').value.trim();
  const sid   = document.getElementById('nv-sid').value.trim();
  const email = document.getElementById('nv-email').value.trim();
  const dept  = document.getElementById('nv-dept').value.trim();
  const batch = document.getElementById('nv-batch').value.trim();
  
  if(!name || !sid) { toast('Name and Student ID required.', true); return; }
  if(voters.find(v => v.sid === sid)) { toast('ID already registered.', true); return; }
  
  setBtnLoading('btn-add-voter', true);
  
  const { error } = await supabaseClient.from('voters').insert([{
    full_name: name, student_id: sid, email: email, department: dept, batch: batch
  }]);

  if(error) {
    toast(error.message, true);
    setBtnLoading('btn-add-voter', false, 'Register Voter');
    return;
  }

  ['nv-name','nv-sid','nv-email','nv-dept','nv-batch'].forEach(f => document.getElementById(f).value = '');
  await fetchData();
  toast('Voter registered.');
  setBtnLoading('btn-add-voter', false, 'Register Voter');
}

async function removeVoter(id) {
  if(!confirm('Permanently remove this voter?')) return;
  const { error } = await supabaseClient.from('voters').delete().eq('id', id);
  if(error) { toast(error.message, true); return; }
  await fetchData();
  toast('Voter removed');
}

function renderVoterTable() {
  const list = voters.filter(v => 
    !vFilter || 
    v.name.toLowerCase().includes(vFilter) || 
    v.sid.toLowerCase().includes(vFilter) || 
    (v.dept||'').toLowerCase().includes(vFilter)
  );
  
  const voted = voters.filter(v => v.voted || votes[v.id]).length;
  document.getElementById('atab-vc').textContent = voters.length;
  document.getElementById('voter-count-lbl').textContent = `${voters.length} registered â€¢ ${voted} voted â€¢ ${voters.length - voted} pending`;

  const tb = document.getElementById('voter-tbody');
  if(!list.length) { tb.innerHTML = `<tr><td colspan="7"><div class="empty"><div class="ei">ğŸ“­</div>No matching records.</div></td></tr>`; return; }
  
  tb.innerHTML = list.map((v,i) => `
    <tr>
      <td style="color:var(--text-light)">${i+1}</td>
      <td><strong>${esc(v.name)}</strong></td>
      <td style="font-family:monospace">${esc(v.sid)}</td>
      <td>${esc(v.dept||'â€”')}</td>
      <td>${esc(v.batch||'â€”')}</td>
      <td><span class="badge ${(v.voted||votes[v.id]) ? 'bg' : 'bo'}">${(v.voted||votes[v.id]) ? 'Voted' : 'Pending'}</span></td>
      <td><button class="btn-d" onclick="removeVoter('${v.id}')">Del</button></td>
    </tr>`).join('');
}

// â”€â”€ ADMIN: CANDIDATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addCandidate() {
  const name     = document.getElementById('nc-name').value.trim();
  const sid      = document.getElementById('nc-sid').value.trim();
  const pos      = document.getElementById('nc-pos').value;
  const dept     = document.getElementById('nc-dept').value.trim();
  const batch    = document.getElementById('nc-batch').value.trim();
  const imageUrl = document.getElementById('nc-image').value.trim();
  const bio      = document.getElementById('nc-bio').value.trim();
  
  if(!name || !pos) { toast('Name and Position are required.', true); return; }
  
  setBtnLoading('btn-add-cand', true);
  
  const { error } = await supabaseClient.from('candidates').insert([{
    full_name: name, student_id: sid, target_position: pos, department: dept, batch: batch, image_url: imageUrl, bio: bio
  }]);

  if(error) { 
    toast(error.message, true); 
    setBtnLoading('btn-add-cand', false, 'Register Candidate');
    return; 
  }

  ['nc-name','nc-sid','nc-dept','nc-batch','nc-image','nc-bio'].forEach(f => document.getElementById(f).value = '');
  document.getElementById('nc-pos').value = '';
  
  await fetchData();
  toast('Candidate registered.');
  setBtnLoading('btn-add-cand', false, 'Register Candidate');
}

async function removeCandidate(id) {
  if(!confirm('Remove this candidate?')) return;
  const { error } = await supabaseClient.from('candidates').delete().eq('id', id);
  if(error) { toast(error.message, true); return; }
  await fetchData();
  toast('Candidate removed.');
}

function renderCandTable() {
  const tb = document.getElementById('cand-tbody');
  if(!candidates.length) { tb.innerHTML = `<tr><td colspan="7"><div class="empty"><div class="ei">ğŸª«</div>No candidates found.</div></td></tr>`; return; }
  
  tb.innerHTML = candidates.map((c,i) => `
    <tr>
      <td style="color:var(--text-light)">${i+1}</td>
      <td><strong>${esc(c.name)}</strong></td>
      <td style="font-family:monospace">${esc(c.sid||'â€”')}</td>
      <td><span class="badge bg">${esc(c.position)}</span></td>
      <td>${esc(c.dept||'â€”')}</td>
      <td>${esc(c.batch||'â€”')}</td>
      <td><button class="btn-d" onclick="removeCandidate('${c.id}')">Del</button></td>
    </tr>`).join('');
}

// â”€â”€ SHARED REPORTING LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function aggregateResults() {
  const vcounts = {};
  Object.values(votes).forEach(sel => {
    Object.values(sel).forEach(cid => {
      vcounts[cid] = (vcounts[cid] || 0) + 1;
    });
  });

  const posMap = {};
  candidates.forEach(c => {
    if(!posMap[c.position]) posMap[c.position] = [];
    posMap[c.position].push({...c, vc: vcounts[c.id] || 0});
  });
  return posMap;
}

// â”€â”€ ADMIN: RESULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResults() {
  const total = voters.length;
  const voted = voters.filter(v => v.voted || votes[v.id]).length;
  
  document.getElementById('r-total').textContent = total;
  document.getElementById('r-voted').textContent = voted;
  document.getElementById('r-pct').textContent   = total ? Math.round(voted/total*100) + '%' : '0%';
  document.getElementById('r-pos').textContent   = POSITIONS.length;

  const posMap = aggregateResults();
  const activePositions = POSITIONS.filter(p => posMap[p.name]);
  const body = document.getElementById('results-body');
  
  if(!activePositions.length) {
    body.innerHTML = '<div class="empty"><div class="ei">ğŸ“­</div><p>Awaiting votes...</p></div>';
    return;
  }

  let html = '';
  activePositions.forEach(pos => {
    const sorted = [...posMap[pos.name]].sort((a,b) => b.vc - a.vc);
    const winner = sorted[0];
    const runnerup = sorted[1];
    const max = Math.max(winner?.vc || 0, 1);

    html += `<div style="margin-bottom:40px; padding-bottom:32px; border-bottom:1px solid var(--border)">
      <h4 style="font-family:var(--font-heading); font-size:1.25rem; margin-bottom:20px; color:var(--text-main);">${esc(pos.name)}</h4>
      ${sorted.map((c,i) => `
        <div style="margin-bottom:16px; display:flex; align-items:center; gap:20px;">
          <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--surface-alt); text-align:center; line-height: 32px; color:var(--text-muted); font-weight: bold; flex-shrink:0;">${i===0 && c.vc>0 ? 'ğŸ†' : i+1}</div>
          <div style="width: 36px; height: 36px; border-radius: 50%; background-color: var(--surface-alt); color: var(--text-muted); display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; overflow: hidden; border: 2px solid var(--border); ${c.imageUrl ? `background-image: url('${esc(c.imageUrl)}'); background-size: cover; background-position: center; border-color: transparent;` : ''}">
            ${c.imageUrl ? '' : c.name.trim()[0]}
          </div>
          <div style="flex:1">
            <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:1rem">
              <strong>${esc(c.name)}</strong>
              <span style="color:var(--text-muted); font-weight: 600;">${c.vc} votes</span>
            </div>
            <div style="background:var(--border); height:10px; border-radius:100px; overflow:hidden;">
              <div style="background:linear-gradient(90deg, var(--primary), var(--primary-hover)); width:${Math.round(c.vc/max*100)}%; height:100%;"></div>
            </div>
          </div>
        </div>
      `).join('')}
      ${pos.runnerUpRole && runnerup && runnerup.vc > 0 ? `
        <div class="runner-assign" style="margin-top:24px; font-size:0.9rem">
          âš¡ Runner-up <b>${esc(runnerup.name)}</b> secures the role of <b>${esc(pos.runnerUpRole)}</b>.
        </div>` : ''}
    </div>`;
  });
  body.innerHTML = html;
}

// â”€â”€ LIVE DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let liveTimer = null;
let liveCountdown = 10;

async function startLiveRefresh() {
  stopLiveRefresh();
  
  // Show spinner inside refresh button instantly on page load
  setBtnLoading('btn-refresh', true);
  await fetchData(); 
  setBtnLoading('btn-refresh', false, 'Refresh Now');
  renderLive();
  
  liveCountdown = 10;
  liveTimer = setInterval(async () => {
    liveCountdown--;
    const el = document.getElementById('lv-countdown');
    if(el) el.textContent = liveCountdown;
    if(liveCountdown <= 0) { 
      setBtnLoading('btn-refresh', true);
      await fetchData(); // Pull fresh db data
      setBtnLoading('btn-refresh', false, 'Refresh Now');
      renderLive(); 
      liveCountdown = 10; 
    }
  }, 1000);
}

function stopLiveRefresh() { if(liveTimer) clearInterval(liveTimer); }

function renderLive() {
  liveCountdown = 10;
  
  if (!liveResultsOpen) {
    document.getElementById('lv-voted').textContent = '-';
    document.getElementById('lv-pct').textContent = 'Hidden by Administrator';
    document.getElementById('lv-lastupdate').textContent = 'Last sync: ' + new Date().toLocaleTimeString();
    document.getElementById('lv-overall').innerHTML = '';
    document.getElementById('lv-body').innerHTML = `
      <div class="card">
        <div class="empty">
          <div class="ei">ğŸ›¡ï¸</div>
          <h3 style="font-family:var(--font-heading); font-size:1.8rem; color:var(--text-main); margin-bottom:12px;">Live Results Hidden</h3>
          <p>The administrator has temporarily hidden the live public telecast to ensure integrity during ballot processing.</p>
        </div>
      </div>`;
    return;
  }

  const totalVoters = voters.length;
  const totalVoted  = voters.filter(v => v.voted || votes[v.id]).length;
  
  document.getElementById('lv-voted').textContent = totalVoted;
  document.getElementById('lv-pct').textContent = `of ${totalVoters} registered voters`;
  document.getElementById('lv-lastupdate').textContent = 'Last sync: ' + new Date().toLocaleTimeString();

  const posMap = aggregateResults();
  const activePositions = POSITIONS.filter(p => posMap[p.name]);
  
  document.getElementById('lv-overall').innerHTML = `
    <div class="ov-card"><div class="ov-n">${totalVoted}</div><div class="ov-l">Total Ballots Cast</div></div>
    <div class="ov-card"><div class="ov-n">${totalVoters ? Math.round(totalVoted/totalVoters*100) : 0}%</div><div class="ov-l">Voter Turnout</div></div>
    <div class="ov-card"><div class="ov-n">${activePositions.length}</div><div class="ov-l">Active Races</div></div>
  `;

  const body = document.getElementById('lv-body');
  if(!activePositions.length) {
    body.innerHTML = '<div class="card"><div class="empty"><div class="ei">ğŸª«</div>Awaiting candidate registration...</div></div>';
    return;
  }

  let html = '';
  activePositions.forEach(pos => {
    const cands = (posMap[pos.name] || []).sort((a,b) => b.vc - a.vc);
    const posTotal = cands.reduce((s,c) => s + c.vc, 0);
    const winner = cands[0];
    const runnerup = cands[1];

    html += `<div class="live-pos-card">
      <div class="lpc-header">
        <div>
          <div class="lpc-name">${esc(pos.name)}</div>
          <div class="lpc-total">${posTotal} total votes distributed</div>
        </div>
      </div>
      ${cands.map((c, i) => {
        const pct = posTotal > 0 ? Math.round(c.vc / posTotal * 100) : 0;
        const isLeading = i === 0 && c.vc > 0;
        return `
          <div class="live-cand-row ${isLeading ? 'leading' : ''}">
            <div class="lcr-rank">${i === 0 && c.vc > 0 ? 'ğŸ†' : i + 1}</div>
            <div class="lcr-avatar" ${c.imageUrl ? `style="background-image: url('${esc(c.imageUrl)}'); background-size: cover; background-position: center; border-color: transparent;"` : ''}>
              ${c.imageUrl ? '' : c.name.trim()[0]}
            </div>
            <div class="lcr-info">
              <div class="lcr-name">${esc(c.name)}</div>
              <div class="lcr-meta">${esc(c.batch)} &middot; ${esc(c.dept)}</div>
              <div class="lcr-bar-wrap"><div class="lcr-bar" style="width:${pct}%"></div></div>
            </div>
            <div>
              <div class="lcr-pct">${pct}%</div>
              <div class="lcr-votes">${c.vc} votes</div>
            </div>
          </div>`;
      }).join('')}
      ${pos.runnerUpRole && runnerup && runnerup.vc > 0 ? `
        <div class="runner-assign">
          <span>âš¡</span>
          <span>Based on current projections, <strong>${esc(runnerup.name)}</strong> tracks for <strong>${esc(pos.runnerUpRole)}</strong>.</span>
        </div>` : ''}
    </div>`;
  });
  body.innerHTML = html;
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function show(id) { document.getElementById(id).style.display = ''; }
function hide(id) { document.getElementById(id).style.display = 'none'; }
function showErr(id, msg) {
  const e = document.getElementById(id);
  e.textContent = msg; e.classList.add('show');
  setTimeout(() => e.classList.remove('show'), 4000);
}
function toast(msg, err=false) {
  const t = document.getElementById('toast');
  t.innerHTML = (err ? 'âš ï¸ ' : 'âœ… ') + msg; 
  t.className = 'show' + (err ? ' err' : '');
  setTimeout(() => t.className = '', 3000);
}
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
</script>
</body>
</html>