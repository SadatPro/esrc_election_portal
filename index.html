<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ESRC Elections 2026‚Äì2027 | Voting Portal</title>

<!-- Modern Fonts: Plus Jakarta Sans for Headings, Inter for Body/UI -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap" rel="stylesheet">

<style>
:root {
  /* Material Design 3 Inspired Color Palette */
  --md-primary: #006C4C;           /* Deep Emerald */
  --md-primary-hover: #005239; 
  --md-on-primary: #FFFFFF;
  --md-primary-container: #89F8C7; /* Light Mint */
  --md-on-primary-container: #002114;
  
  --md-secondary: #4C6357;
  --md-on-secondary: #FFFFFF;
  --md-secondary-container: #CEE9DB;
  
  --md-surface: #FBFDF9;           /* App Background */
  --md-surface-card: #FFFFFF;      /* Card Background */
  --md-surface-variant: #DBE5E0;   /* Inputs, disabled states */
  
  --md-on-surface: #191C1A;        /* Main Text */
  --md-on-surface-variant: #404943;/* Muted Text */
  --md-outline: #707973;           /* Input Borders */
  --md-outline-variant: #BFC9C4;   /* Card/Divider Borders */
  
  --md-error: #BA1A1A;
  --md-error-container: #FFDAD6;
  --md-on-error-container: #410002;
  
  --md-warning: #B36B00;
  --md-warning-container: #FFDE9C;
  
  /* Typography */
  --font-body: 'Inter', sans-serif;
  --font-heading: 'Plus Jakarta Sans', sans-serif;
  --font-mono: ui-monospace, SFMono-Regular, Consolas, monospace;
  
  /* Material Elevation (Shadows) */
  --elevation-1: 0px 1px 2px 0px rgba(0, 0, 0, 0.1), 0px 1px 3px 1px rgba(0, 0, 0, 0.05);
  --elevation-2: 0px 1px 2px 0px rgba(0, 0, 0, 0.1), 0px 2px 6px 2px rgba(0, 0, 0, 0.05);
  --elevation-3: 0px 4px 8px 3px rgba(0, 0, 0, 0.1), 0px 1px 3px 0px rgba(0, 0, 0, 0.05);
  
  /* Spacing System */
  --space-xs: 4px;
  --space-sm: 8px;
  --space-md: 16px;
  --space-lg: 24px;
  --space-xl: 32px;
  --space-2xl: 48px;
  
  /* Radii */
  --radius-xs: 4px;   /* Inputs */
  --radius-sm: 8px;   /* Small Cards/Badges */
  --radius-md: 16px;  /* Standard Cards */
  --radius-pill: 100px; /* Buttons */
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; }
body { 
  font-family: var(--font-body); 
  background-color: var(--md-surface); 
  color: var(--md-on-surface); 
  min-height: 100vh; 
  overflow-x: hidden; 
  line-height: 1.5; 
}

/* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
@keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
@keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
@keyframes spin { to { transform: rotate(360deg); } }

/* ‚îÄ‚îÄ LOADING OVERLAY & INLINE SPINNERS ‚îÄ‚îÄ */
#loading-overlay {
  position: fixed; inset: 0; background: rgba(251, 253, 249, 0.9); backdrop-filter: blur(8px); z-index: 9999;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: opacity 0.3s ease;
}
.spinner {
  width: 48px; height: 48px; border: 4px solid var(--md-surface-variant); border-top-color: var(--md-primary);
  border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: var(--space-lg);
}
.inline-spinner {
  width: 18px; height: 18px; border-width: 2px; border-color: rgba(255,255,255,0.3); border-top-color: #fff;
  border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle;
  margin-right: var(--space-sm);
}
.btn-loading { pointer-events: none; opacity: 0.8; }

/* ‚îÄ‚îÄ STATUS BAR ‚îÄ‚îÄ */
#status-bar { display: flex; align-items: center; justify-content: center; gap: var(--space-sm); padding: var(--space-sm) var(--space-md); font-size: 0.85rem; font-weight: 600; font-family: var(--font-body); color: var(--md-on-primary); background: var(--md-primary); transition: background 0.3s; z-index: 400; position: relative;}
#status-bar.closed { background: var(--md-error); }
.sdot { width: 8px; height: 8px; border-radius: 50%; background: var(--md-primary-container); flex-shrink: 0; animation: blink 2s infinite; }
#status-bar.closed .sdot { background: var(--md-error-container); animation: none; }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 300; border-bottom: 1px solid var(--md-outline-variant); box-shadow: var(--elevation-1); }
.hdr { max-width: 1200px; margin: 0 auto; padding: 0 var(--space-lg); height: 72px; display: flex; align-items: center; justify-content: space-between; gap: var(--space-md); }
.logo { display: flex; align-items: center; gap: var(--space-sm); cursor: pointer; text-decoration: none; }
.logo-ico { width: 40px; height: 40px; background: var(--md-primary-container); color: var(--md-on-primary-container); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-family: var(--font-mono); font-weight: 800; letter-spacing: -1px; }
.logo-l1 { font-family: var(--font-heading); color: var(--md-on-surface); font-size: 1.25rem; font-weight: 800; letter-spacing: -0.5px; line-height: 1.1; }
.logo-l2 { color: var(--md-on-surface-variant); font-size: 0.7rem; letter-spacing: 0.5px; text-transform: uppercase; font-weight: 600; margin-top: 2px; }
.hdr-r { display: flex; align-items: center; gap: var(--space-sm); }
.btn-hdr { background: var(--md-surface-card); border: 1px solid var(--md-outline-variant); color: var(--md-on-surface); padding: 8px 16px; border-radius: var(--radius-pill); font-size: 0.85rem; font-family: var(--font-body); font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
.btn-hdr:hover { background: var(--md-surface-variant); color: var(--md-on-surface); }
.btn-live { background: var(--md-primary-container) !important; border-color: transparent !important; color: var(--md-on-primary-container) !important; }
.btn-live:hover { filter: brightness(0.95); }

/* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
.hero { background: var(--md-on-surface); color: var(--md-surface); padding: var(--space-2xl) var(--space-lg); text-align: center; position: relative; overflow: hidden; border-radius: 0 0 var(--radius-md) var(--radius-md); margin-bottom: var(--space-xl); box-shadow: var(--elevation-2);}
.hero-inner { position: relative; z-index: 1; max-width: 800px; margin: 0 auto; animation: fadeUp 0.6s ease; }
.eyebrow { display: inline-flex; align-items: center; gap: var(--space-sm); background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: var(--md-primary-container); font-size: 0.75rem; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; padding: 6px 16px; border-radius: var(--radius-pill); margin-bottom: var(--space-lg); font-family: var(--font-body); }
.hero h1 { font-family: var(--font-heading); font-size: clamp(2rem, 5vw, 3.5rem); line-height: 1.2; margin-bottom: var(--space-md); font-weight: 800; letter-spacing: -1px; }
.hero h1 em { font-style: normal; color: var(--md-primary-container); }
.hero p { color: var(--md-outline-variant); font-size: 1.1rem; line-height: 1.6; margin-bottom: var(--space-xl); max-width: 600px; margin-left: auto; margin-right: auto; }
.pills { display: flex; gap: var(--space-sm); justify-content: center; flex-wrap: wrap; }
.pill { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); color: #fff; padding: 8px 16px; border-radius: var(--radius-pill); font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 6px;}
.pill b { font-weight: 700; font-family: var(--font-heading); }

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
main { max-width: 1040px; margin: 0 auto var(--space-2xl); padding: 0 var(--space-lg); position: relative; z-index: 10; }
.page { display: none; }
.page.active { display: block; animation: fadeUp 0.4s ease forwards; }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card { background: var(--md-surface-card); border-radius: var(--radius-md); border: 1px solid var(--md-outline-variant); box-shadow: var(--elevation-1); padding: var(--space-xl); margin-bottom: var(--space-lg); }
.card-title { font-family: var(--font-heading); font-size: 1.4rem; color: var(--md-on-surface); margin-bottom: var(--space-sm); font-weight: 700; letter-spacing: -0.3px; }
.card-sub { font-size: 0.95rem; color: var(--md-on-surface-variant); margin-bottom: var(--space-xl); line-height: 1.5; }

/* ‚îÄ‚îÄ FORMS & INPUTS (Material 3 Style) ‚îÄ‚îÄ */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); }
.fg { display: flex; flex-direction: column; gap: var(--space-xs); text-align: left; }
.fg.full { grid-column: 1 / -1; }
label { font-size: 0.85rem; font-weight: 600; color: var(--md-on-surface-variant); font-family: var(--font-body); }
input[type=text], input[type=email], input[type=password], select, textarea { 
  width: 100%; padding: 14px 16px; border: 1px solid var(--md-outline); border-radius: var(--radius-xs); 
  font-size: 1rem; font-family: var(--font-body); color: var(--md-on-surface); background: transparent; transition: border-color 0.2s, padding 0.2s; 
}
input:focus, select:focus, textarea:focus { border: 2px solid var(--md-primary); padding: 13px 15px; outline: none; }
input::placeholder, textarea::placeholder { color: var(--md-outline); }

/* Terms & Conditions Box */
.terms-box {
  background: var(--md-surface-variant);
  border: 1px solid var(--md-outline-variant);
  border-radius: var(--radius-sm);
  padding: var(--space-md);
  max-height: 200px;
  overflow-y: auto;
  font-size: 0.85rem;
  color: var(--md-on-surface-variant);
  line-height: 1.6;
  margin-top: var(--space-sm);
}
.terms-box ul { padding-left: 20px; margin-top: 8px; margin-bottom: 8px;}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn { padding: 12px 24px; border-radius: var(--radius-pill); border: none; cursor: pointer; font-size: 0.95rem; font-weight: 600; font-family: var(--font-body); transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px;}
.btn-p { background: var(--md-primary); color: var(--md-on-primary); box-shadow: var(--elevation-1); }
.btn-p:hover { background: var(--md-primary-hover); box-shadow: var(--elevation-2); transform: translateY(-1px); }
.btn-p:active { transform: translateY(0); box-shadow: var(--elevation-1); }
.btn-o { background: transparent; color: var(--md-primary); border: 1px solid var(--md-outline); }
.btn-o:hover { background: var(--md-surface-variant); color: var(--md-on-surface); }
.btn-d { background: transparent; color: var(--md-error); padding: 8px 16px; font-size: 0.85rem; border: 1px solid var(--md-error); border-radius: var(--radius-pill); font-weight: 600; cursor: pointer; transition: all 0.2s;}
.btn-d:hover { background: var(--md-error-container); color: var(--md-on-error-container); border-color: transparent;}
.btn-approve { background: var(--md-primary-container); color: var(--md-on-primary-container); border: none; padding: 8px 16px; font-size: 0.85rem; border-radius: var(--radius-pill); font-weight: 600; cursor: pointer; transition: all 0.2s; }
.btn-approve:hover { filter: brightness(0.95); transform: translateY(-1px); }
.btn-edit { background: var(--md-secondary-container); color: var(--md-secondary); border: none; padding: 8px 16px; font-size: 0.85rem; border-radius: var(--radius-pill); font-weight: 600; cursor: pointer; transition: all 0.2s; }
.btn-edit:hover { filter: brightness(0.95); transform: translateY(-1px); }

/* ‚îÄ‚îÄ GATE (LOGIN & REGISTER) ‚îÄ‚îÄ */
.gate-wrap { max-width: 480px; margin: 0 auto; text-align: center; }
.gate-icon { font-size: 3.5rem; margin-bottom: var(--space-md); }
.gate-title { font-family: var(--font-heading); font-size: 2rem; color: var(--md-on-surface); margin-bottom: var(--space-sm); font-weight: 800; }
.gate-sub { color: var(--md-on-surface-variant); font-size: 1rem; margin-bottom: var(--space-xl); line-height: 1.5; }
.inp-wrap { position: relative; margin-bottom: var(--space-md); }
.inp-wrap input { padding-left: 48px; }
.inp-wrap input:focus { padding-left: 47px; }
.inp-ico { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 1.1rem; color: var(--md-outline); font-family: var(--font-mono); font-weight: bold; }
.err-box { background: var(--md-error-container); color: var(--md-on-error-container); border-radius: var(--radius-sm); padding: 12px 16px; font-size: 0.9rem; margin-top: var(--space-md); display: none; text-align: left; line-height: 1.5; font-weight: 500; }
.err-box.show { display: block; animation: scaleIn 0.2s ease; }

/* ‚îÄ‚îÄ BALLOT HEADER ‚îÄ‚îÄ */
.ballot-hdr { background: var(--md-primary-container); border-radius: var(--radius-md); padding: var(--space-lg) var(--space-xl); margin-bottom: var(--space-lg); display: flex; align-items: center; gap: var(--space-lg); color: var(--md-on-primary-container); }
.bh-av { width: 56px; height: 56px; border-radius: 50%; background: #fff; color: var(--md-primary); display: flex; align-items: center; justify-content: center; font-size: 1.8rem; flex-shrink: 0; box-shadow: var(--elevation-1); }
.bh-name { font-family: var(--font-heading); font-size: 1.4rem; font-weight: 800; margin-bottom: 2px;}
.bh-meta { font-size: 0.85rem; opacity: 0.85; font-family: var(--font-mono); }
.bh-hint { margin-left: auto; font-size: 0.85rem; text-align: right; line-height: 1.5; background: rgba(255,255,255,0.4); padding: 10px 16px; border-radius: var(--radius-sm); }

/* ‚îÄ‚îÄ STICKY PROGRESS ‚îÄ‚îÄ */
.progress-container { position: sticky; top: 88px; z-index: 200; margin-bottom: var(--space-xl); }
.progress-tracker { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid var(--md-outline-variant); border-radius: var(--radius-md); padding: 16px 24px; display: flex; align-items: center; gap: var(--space-md); box-shadow: var(--elevation-1); }
.pt-label { font-size: 0.85rem; font-weight: 700; color: var(--md-on-surface); font-family: var(--font-body); text-transform: uppercase; letter-spacing: 0.5px; }
.pt-bar-wrap { flex: 1; min-width: 140px; background: var(--md-surface-variant); border-radius: var(--radius-pill); height: 8px; overflow: hidden; }
.pt-bar { height: 100%; border-radius: var(--radius-pill); background: var(--md-primary); transition: width 0.4s ease; width: 0%; }
.pt-count { font-size: 0.9rem; color: var(--md-on-surface-variant); white-space: nowrap; font-weight: 600; font-family: var(--font-mono); }

/* ‚îÄ‚îÄ PHASE BANNER ‚îÄ‚îÄ */
.phase-banner { display: flex; align-items: center; gap: var(--space-md); padding: var(--space-md) 0; margin-bottom: var(--space-md); margin-top: var(--space-lg); border-bottom: 2px solid var(--md-outline-variant);}
.ph-num { width: 36px; height: 36px; background: var(--md-secondary-container); color: var(--md-on-surface); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; font-weight: 700; font-family: var(--font-heading); flex-shrink: 0; }
.ph-txt { font-size: 0.95rem; color: var(--md-on-surface-variant); line-height: 1.4; }
.ph-txt b { color: var(--md-on-surface); font-weight: 700; font-family: var(--font-heading); font-size: 1.1rem; display: block; margin-bottom: 2px;}

/* ‚îÄ‚îÄ POSITION CARD ‚îÄ‚îÄ */
.pos-card { background: var(--md-surface-card); border-radius: var(--radius-md); border: 1px solid var(--md-outline-variant); box-shadow: var(--elevation-1); padding: var(--space-xl); margin-bottom: var(--space-lg); transition: all 0.2s ease; scroll-margin-top: 180px; }
.pos-card:hover { box-shadow: var(--elevation-2); }
.pos-card.has-sel { border: 2px solid var(--md-primary); padding: calc(var(--space-xl) - 1px); }
.pos-head { margin-bottom: var(--space-lg); }
.pos-name { font-family: var(--font-heading); font-size: 1.3rem; color: var(--md-on-surface); display: flex; align-items: center; gap: var(--space-sm); margin-bottom: 4px; font-weight: 700; }
.pos-rule { font-size: 0.9rem; color: var(--md-on-surface-variant); font-weight: 500; }
.auto-tag { display: inline-flex; align-items: center; background: var(--md-warning-container); color: var(--md-warning); border-radius: var(--radius-xs); padding: 2px 8px; font-size: 0.75rem; font-weight: 700; font-family: var(--font-body); }

/* ‚îÄ‚îÄ CANDIDATE CARDS ‚îÄ‚îÄ */
.cands-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: var(--space-md); }
.cand { background: var(--md-surface-card); border: 1px solid var(--md-outline-variant); border-radius: var(--radius-md); padding: var(--space-lg) var(--space-md); cursor: pointer; transition: all 0.2s ease; text-align: center; position: relative; user-select: none; display: flex; flex-direction: column; align-items: center; }
.cand:hover { background: var(--md-surface-variant); border-color: var(--md-outline); }
.cand.sel { background: var(--md-primary-container); border: 2px solid var(--md-primary); padding: calc(var(--space-lg) - 1px) calc(var(--space-md) - 1px); }
.cand-radio { position: absolute; top: 16px; right: 16px; width: 22px; height: 22px; border-radius: 50%; border: 2px solid var(--md-outline); background: transparent; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
.cand.sel .cand-radio { border-color: var(--md-primary); background: var(--md-primary); }
.cand.sel .cand-radio::after { content: ''; width: 10px; height: 10px; background: var(--md-on-primary); border-radius: 50%; animation: scaleIn 0.2s ease;}

.cav { width: 100px; height: 100px; border-radius: 50%; background-color: var(--md-surface-variant); color: var(--md-on-surface-variant); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 700; margin-bottom: var(--space-md); transition: transform 0.2s ease; overflow: hidden; flex-shrink: 0; }
.cand.sel .cav { transform: scale(1.05); box-shadow: var(--elevation-1); }

.cname { font-weight: 700; font-size: 1.15rem; color: var(--md-on-surface); margin-bottom: 4px; font-family: var(--font-heading); line-height: 1.2; }
.cmeta { font-size: 0.85rem; color: var(--md-on-surface-variant); font-weight: 500; margin-bottom: 12px; }
.cbio { font-size: 0.85rem; color: var(--md-on-surface-variant); line-height: 1.5; padding-top: 12px; border-top: 1px solid var(--md-outline-variant); width: 100%; margin-top: auto; }
.cand.sel .cbio { border-color: rgba(0, 108, 76, 0.2); color: var(--md-on-primary-container); }

/* ‚îÄ‚îÄ SUBMIT ZONE ‚îÄ‚îÄ */
.submit-zone { background: var(--md-surface-card); border-radius: var(--radius-md); padding: var(--space-2xl); text-align: center; margin-top: var(--space-xl); box-shadow: var(--elevation-2); border: 1px solid var(--md-outline-variant); }
.submit-zone h3 { font-family: var(--font-heading); font-size: 1.6rem; margin-bottom: 8px; font-weight: 800; color: var(--md-on-surface);}
.submit-zone p { font-size: 1rem; color: var(--md-on-surface-variant); margin-bottom: var(--space-xl); }
.sel-summary { background: var(--md-surface); border: 1px solid var(--md-outline-variant); border-radius: var(--radius-sm); padding: var(--space-lg); margin-bottom: var(--space-xl); text-align: left; font-size: 0.95rem; line-height: 2; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
.sel-summary b { color: var(--md-on-surface); font-weight: 600; display: block; margin-bottom: 2px;}
.sel-summary .miss { color: var(--md-error); }
.sel-summary .miss b { color: var(--md-error); }
.btn-sub { width: 100%; max-width: 320px; font-size: 1.1rem; padding: 16px; }

/* ‚îÄ‚îÄ SUCCESS ‚îÄ‚îÄ */
.success-wrap { text-align: center; padding: 60px 20px; }
.s-icon { font-size: 4rem; margin-bottom: 24px; animation: scaleIn 0.5s ease; display: inline-flex; align-items: center; justify-content: center; background: var(--md-primary-container); width: 100px; height: 100px; border-radius: 50%; box-shadow: var(--elevation-1); }
.s-title { font-family: var(--font-heading); font-size: 2.2rem; font-weight: 800; color: var(--md-on-surface); margin-bottom: 12px; }
.s-sub { color: var(--md-on-surface-variant); font-size: 1rem; line-height: 1.6; max-width: 480px; margin: 0 auto 32px; }
.s-box { background: var(--md-surface); border: 1px solid var(--md-outline-variant); border-radius: var(--radius-md); padding: 24px; font-size: 0.95rem; color: var(--md-on-surface); line-height: 1.8; max-width: 500px; margin: 0 auto 32px; text-align: left; }
.s-box strong { font-family: var(--font-heading); display: block; margin-bottom: 8px;}
.s-box ul { list-style: none; padding-left: 0; }
.s-box li { margin-bottom: 8px; display: flex; align-items: flex-start; gap: 8px; }
.s-box li::before { content: '‚Ä¢'; color: var(--md-primary); font-weight: bold; }

/* ‚îÄ‚îÄ LIVE RESULTS PAGE ‚îÄ‚îÄ */
.live-hero { background: var(--md-primary-container); border-radius: var(--radius-md); padding: var(--space-xl) var(--space-2xl); margin-bottom: var(--space-lg); display: flex; align-items: center; gap: var(--space-xl); color: var(--md-on-primary-container); box-shadow: var(--elevation-1); }
.live-icon { font-size: 3rem; background: rgba(255,255,255,0.5); width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; }
.live-hero-txt { flex: 1; }
.live-hero-txt h2 { font-family: var(--font-heading); font-size: 2rem; font-weight: 800; margin-bottom: 8px; }
.live-hero-txt p { font-size: 1rem; opacity: 0.9; line-height: 1.5; max-width: 500px; }
.live-meta { text-align: right; background: rgba(255,255,255,0.4); padding: 16px 24px; border-radius: var(--radius-sm); }
.lm-voted { font-family: var(--font-heading); font-size: 3rem; font-weight: 800; line-height: 1; color: var(--md-primary); margin-bottom: 4px; }
.lm-label { font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
.lm-pct { font-size: 0.85rem; font-family: var(--font-mono); margin-top: 4px;}

.live-refresh { display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-xl); flex-wrap: wrap; }
.refresh-badge { display: flex; align-items: center; gap: 8px; background: var(--md-surface-card); border: 1px solid var(--md-outline-variant); border-radius: var(--radius-pill); padding: 8px 16px; font-size: 0.85rem; color: var(--md-on-surface); font-weight: 600; box-shadow: var(--elevation-1); }
.refresh-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--md-primary); animation: blink 1.4s infinite; }

.live-overall { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-2xl); }
.ov-card { background: var(--md-surface-card); border: 1px solid var(--md-outline-variant); border-radius: var(--radius-md); padding: 24px 20px; text-align: center; box-shadow: var(--elevation-1); }
.ov-n { font-family: var(--font-heading); font-size: 2.5rem; color: var(--md-on-surface); line-height: 1; font-weight: 800; margin-bottom: 8px; }
.ov-l { font-size: 0.8rem; color: var(--md-on-surface-variant); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

.live-pos-card { background: var(--md-surface-card); border-radius: var(--radius-md); border: 1px solid var(--md-outline-variant); box-shadow: var(--elevation-1); padding: var(--space-xl); margin-bottom: var(--space-lg); }
.lpc-header { display: flex; align-items: flex-start; justify-content: space-between; gap: var(--space-md); margin-bottom: var(--space-lg); flex-wrap: wrap; border-bottom: 1px solid var(--md-outline-variant); padding-bottom: 16px; }
.lpc-name { font-family: var(--font-heading); font-size: 1.4rem; color: var(--md-on-surface); font-weight: 800; display: flex; align-items: center; gap: 12px; margin-bottom: 4px; }
.lpc-total { font-size: 0.9rem; color: var(--md-on-surface-variant); font-weight: 500; }

.live-cand-row { display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md); padding: 16px; background: var(--md-surface); border-radius: var(--radius-sm); border: 1px solid transparent; transition: all 0.2s; }
.live-cand-row.leading { border-color: var(--md-primary); background: var(--md-primary-container); }
.lcr-rank { width: 36px; height: 36px; border-radius: 50%; background: var(--md-surface-variant); color: var(--md-on-surface); display: flex; align-items: center; justify-content: center; font-size: 1rem; font-weight: 700; font-family: var(--font-heading); flex-shrink: 0; }
.lcr-avatar { width: 48px; height: 48px; border-radius: 50%; background-color: var(--md-surface-variant); color: var(--md-on-surface-variant); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 700; font-family: var(--font-heading); flex-shrink: 0; overflow: hidden; border: 2px solid transparent; }
.live-cand-row.leading .lcr-rank { background: var(--md-primary); color: var(--md-on-primary); }
.live-cand-row.leading .lcr-avatar { border-color: var(--md-primary); background-color: #fff; color: var(--md-primary); }
.lcr-info { flex: 1; min-width: 0; }
.lcr-name { font-weight: 700; font-size: 1.1rem; color: var(--md-on-surface); display: flex; align-items: center; gap: 8px; margin-bottom: 4px; font-family: var(--font-heading); }
.lcr-meta { font-size: 0.85rem; color: var(--md-on-surface-variant); font-family: var(--font-mono);}
.lcr-bar-wrap { background: var(--md-outline-variant); border-radius: var(--radius-pill); height: 8px; overflow: hidden; margin-top: 10px; }
.lcr-bar { height: 100%; border-radius: var(--radius-pill); background: var(--md-secondary); transition: width 1s ease; }
.live-cand-row.leading .lcr-bar { background: var(--md-primary); }
.lcr-pct { font-size: 1.2rem; font-weight: 800; color: var(--md-on-surface); white-space: nowrap; text-align: right; font-family: var(--font-heading); }
.live-cand-row.leading .lcr-pct { color: var(--md-on-primary-container); }
.lcr-votes { font-size: 0.85rem; color: var(--md-on-surface-variant); text-align: right; font-weight: 500; margin-top: 2px; }
.runner-assign { background: var(--md-warning-container); border-radius: var(--radius-xs); padding: 12px 16px; margin-top: var(--space-md); font-size: 0.9rem; color: var(--md-warning); display: flex; gap: 12px; align-items: flex-start; }

/* TABLES */
.twrap { overflow-x: auto; border-radius: var(--radius-sm); border: 1px solid var(--md-outline-variant); background: var(--md-surface-card); }
table { width: 100%; border-collapse: collapse; font-size: 0.9rem; text-align: left;}
thead { background: var(--md-surface-variant); border-bottom: 2px solid var(--md-outline-variant); }
thead th { padding: 16px; font-weight: 600; color: var(--md-on-surface); font-family: var(--font-body); }
tbody tr { border-bottom: 1px solid var(--md-outline-variant); transition: background 0.2s;}
tbody tr:hover { background: var(--md-surface); }
tbody td { padding: 16px; color: var(--md-on-surface); vertical-align: middle; }
.badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: var(--radius-xs); font-size: 0.75rem; font-weight: 600; font-family: var(--font-body); letter-spacing: 0.5px;}
.bg { background: var(--md-primary-container); color: var(--md-on-primary-container); }
.bo { background: var(--md-warning-container); color: var(--md-warning); }

/* ADMIN TABS */
.atabs { display: flex; gap: var(--space-sm); background: var(--md-surface-variant); padding: 6px; border-radius: var(--radius-pill); margin-bottom: var(--space-xl); flex-wrap: wrap; }
.atab { padding: 10px 24px; border-radius: var(--radius-pill); border: none; cursor: pointer; font-size: 0.9rem; font-weight: 600; font-family: var(--font-body); transition: all 0.2s; background: transparent; color: var(--md-on-surface-variant); display: flex; align-items: center; gap: 8px;}
.atab.active { background: var(--md-surface-card); color: var(--md-on-surface); box-shadow: var(--elevation-1); }
.atab:hover:not(.active) { color: var(--md-on-surface); }

.admin-hdr-bar { background: var(--md-secondary-container); border-radius: var(--radius-md); padding: var(--space-xl); margin-bottom: var(--space-xl); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: var(--space-lg); color: var(--md-on-surface); }
.admin-hdr-bar h2 { font-family: var(--font-heading); font-size: 1.8rem; font-weight: 800; margin-bottom: 4px; }
.admin-hdr-bar p { color: var(--md-secondary); font-size: 1rem; }
.toggle-wrap { display: flex; align-items: center; gap: 12px; font-weight: 600; font-size: 0.9rem;}
.toggle { position: relative; width: 48px; height: 24px; cursor: pointer; }
.toggle input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; inset: 0; background: var(--md-outline-variant); border-radius: var(--radius-pill); transition: 0.3s; }
.slider::before { content: ''; position: absolute; height: 18px; width: 18px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: 0.3s; }
input:checked + .slider { background: var(--md-primary); }
input:checked + .slider::before { transform: translateX(24px); }

/* TOAST */
#toast { position: fixed; bottom: 24px; right: 24px; background: var(--md-on-surface); color: var(--md-surface); padding: 14px 20px; border-radius: var(--radius-sm); font-size: 0.9rem; font-weight: 500; font-family: var(--font-body); box-shadow: var(--elevation-3); z-index: 9999; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; display: flex; align-items: center; gap: 12px; }
#toast.show { transform: translateY(0); opacity: 1; }
#toast.err { background: var(--md-error); color: var(--md-on-error-container); }

.empty { text-align: center; padding: 60px 20px; color: var(--md-on-surface-variant); }
.empty .ei { font-size: 3rem; margin-bottom: 16px; opacity: 0.7; }

footer { background: var(--md-surface-card); color: var(--md-on-surface-variant); text-align: center; padding: 32px 20px; font-size: 0.85rem; font-family: var(--font-body); border-top: 1px solid var(--md-outline-variant); position: relative; z-index: 10;}
footer strong { color: var(--md-on-surface); font-family: var(--font-heading); font-weight: 700; }

/* ‚îÄ‚îÄ RESPONSIVE DESIGN (Mobile First Adjustments) ‚îÄ‚îÄ */
@media(max-width: 768px) {
  .hdr { padding: 12px var(--space-md); height: auto; min-height: 64px; flex-wrap: wrap; justify-content: space-between; gap: 12px; }
  .logo-l2 { display: none; } 
  .chip { display: none; } 
  .hdr-r { gap: 8px; }
  .btn-hdr { padding: 8px 12px; font-size: 0.8rem; }

  main { padding: var(--space-md) var(--space-md) var(--space-2xl); margin-top: 0;}
  .hero { padding: var(--space-xl) var(--space-md); border-radius: 0;}
  .hero h1 { font-size: 2rem; margin-bottom: var(--space-sm); letter-spacing: -0.5px; }
  .hero p { font-size: 1rem; margin-bottom: var(--space-lg); }
  
  .card, .pos-card, .submit-zone { padding: var(--space-lg) var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-md);}
  .pos-name { font-size: 1.2rem; }
  .gate-icon { font-size: 3rem; margin-bottom: 16px; }
  .gate-title { font-size: 1.6rem; }
  
  .ballot-hdr { flex-direction: column; text-align: center; padding: var(--space-lg) var(--space-md); gap: 16px; }
  .bh-hint { text-align: center; margin-left: 0; width: 100%; padding: 12px; }
  .progress-container { top: 72px; margin-bottom: var(--space-md);} 
  .progress-tracker { flex-direction: column; align-items: stretch; padding: 12px 16px; gap: 12px; }
  .pt-label, .pt-count { text-align: center; }
  .pt-bar-wrap { width: 100%; }
  .phase-banner { flex-direction: column; text-align: center; padding: 16px; gap: 12px; }
  
  .cands-grid { grid-template-columns: 1fr; gap: 16px; }
  .cand { padding: var(--space-lg) var(--space-md); }
  .cav { margin-bottom: var(--space-md); width: 80px; height: 80px; font-size: 2rem; }
  .cand-radio { top: 12px; right: 12px; }
  
  .live-hero { flex-direction: column; text-align: center; padding: var(--space-lg) var(--space-md); gap: var(--space-md); }
  .live-meta { text-align: center; width: 100%; background: transparent; padding: 0;}
  .lm-voted { font-size: 2.5rem; }
  .live-overall { grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: var(--space-xl); }
  .ov-card { padding: 16px 12px; border-radius: var(--radius-sm); }
  .ov-n { font-size: 1.8rem; margin-bottom: 6px; }
  
  .live-pos-card { padding: var(--space-lg) var(--space-md); }
  .live-cand-row { flex-direction: column; align-items: center; gap: 12px; text-align: center; padding: 16px; }
  .lcr-rank, .lcr-avatar { margin: 0 auto; }
  .live-cand-row > div:last-child { text-align: center; width: 100%; display: flex; justify-content: space-between; align-items: center; background: var(--md-surface); padding: 12px; border-radius: var(--radius-xs); border: 1px solid var(--md-outline-variant); margin-top: 8px;}
  
  .admin-hdr-bar { flex-direction: column; text-align: center; padding: var(--space-lg) var(--space-md); gap: 16px; }
  .toggle-wrap { justify-content: space-between; width: 100%; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
  .toggle-wrap:last-of-type { border-bottom: none; }
  .btn-logout { width: 100%; margin-top: 8px; }
  .atabs { justify-content: center; padding: 4px; border-radius: var(--radius-md); }
  .atab { flex: 1; text-align: center; justify-content: center; padding: 8px 4px; font-size: 0.8rem; border-radius: var(--radius-sm); }
  .form-grid { grid-template-columns: 1fr; gap: 16px; }
  
  .success-wrap { padding: 40px 10px; }
  .s-icon { width: 80px; height: 80px; font-size: 2.5rem; margin-bottom: 16px; }
  .s-title { font-size: 1.8rem; }
  #toast { left: 16px; right: 16px; bottom: 16px; max-width: none; justify-content: center; text-align: center;}
}

@media(max-width: 480px) {
  .hdr { justify-content: center; flex-direction: column; text-align: center; gap: 12px; padding: 12px; }
  .hdr-r { flex-wrap: wrap; gap: 8px; width: 100%; }
  .btn-hdr { flex: 1; text-align: center; padding: 8px;}
  .live-overall { grid-template-columns: 1fr; }
}
</style>

<!-- Add Supabase JS Client Library -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- INITIAL LOADING OVERLAY -->
<div id="loading-overlay">
  <div class="spinner"></div>
  <div style="font-family: var(--font-heading); font-size: 1.2rem; color: var(--md-on-surface); font-weight: 700;">Initializing Terminal...</div>
  <div style="color: var(--md-on-surface-variant); font-size: 0.9rem; margin-top: 8px;">Connecting to ESRC Database</div>
</div>

<!-- STATUS BAR -->
<div id="status-bar">
  <span class="sdot"></span>
  <span id="status-text">Connecting to Live Server...</span>
</div>

<!-- HEADER -->
<header>
  <div class="hdr">
    <div class="logo" onclick="showPage('voter')">
      <div class="logo-ico">&lt;/&gt;</div>
      <div>
        <div class="logo-l1">ESRC</div>
        <div class="logo-l2">Embedded System Research Center</div>
      </div>
    </div>
    <div class="hdr-r">
      <button class="btn-hdr" onclick="showPage('register')">üìù Register</button>
      <button class="btn-hdr btn-live" onclick="showPage('live')">üì° Live Results</button>
      <button class="btn-hdr" onclick="showPage('admin')">üõ°Ô∏è Admin</button>
    </div>
  </div>
</header>

<!-- HERO -->
<div class="hero" id="hero-section">
  <div class="hero-inner">
    <div class="eyebrow">‚ö° Secure Voting Terminal</div>
    <h1>ESRC Committee <br><em>Elections 2026‚Äì2027</em></h1>
    <p>Vote for all positions in a single seamless ballot. Runner-up roles are automatically assigned based on total vote counts.</p>
    <div class="pills">
      <div class="pill">üßë‚Äçüíª <b id="total-pill">0</b> Voters Registered</div>
      <div class="pill">üéõÔ∏è <b>10</b> Direct Positions</div>
      <div class="pill">‚ö° <b>8</b> Auto-Roles</div>
    </div>
  </div>
</div>

<!-- MAIN -->
<main>

<!-- ‚ïê‚ïê VOTER PAGE ‚ïê‚ïê -->
<div id="page-voter" class="page active">

  <div class="card gate-wrap" id="voter-gate">
    <div class="gate-icon">üó≥Ô∏è</div>
    <div class="gate-title">Access Your Ballot</div>
    <div class="gate-sub">Enter your Student ID exactly as registered. You will vote for <strong>all positions</strong> in one single secure session.</div>
    <div class="inp-wrap">
      <span class="inp-ico">&gt;_</span>
      <input type="text" id="voter-id-input" placeholder="e.g. 241-15-519" onkeydown="if(event.key==='Enter')verifyVoter()"/>
    </div>
    <button class="btn btn-p" style="width: 100%; padding: 16px; font-size: 1.05rem;" onclick="verifyVoter()" id="btn-verify">
      Verify &amp; Open Ballot ‚Üí
    </button>
    <div class="err-box" id="gate-err"></div>
  </div>

  <div id="ballot-section" style="display:none">
    <div class="ballot-hdr">
      <div class="bh-av">üßë‚Äçüíª</div>
      <div style="flex:1">
        <div class="bh-name" id="bh-name"></div>
        <div class="bh-meta" id="bh-meta"></div>
      </div>
      <div class="bh-hint">Select <b>one</b> candidate per position.<br>Runner-ups are auto-assigned.</div>
    </div>

    <!-- Sticky Progress Tracker -->
    <div class="progress-container">
      <div class="progress-tracker">
        <span class="pt-label">Ballot Progress</span>
        <div class="pt-bar-wrap"><div class="pt-bar" id="pt-bar"></div></div>
        <span class="pt-count" id="pt-count">0 / 0 selected</span>
      </div>
    </div>

    <div id="ballot-body"></div>

    <div class="submit-zone">
      <h3>Review &amp; Submit</h3>
      <p>Please review your choices below. Once submitted, your vote is <strong>final</strong> and cannot be altered.</p>
      <div class="sel-summary" id="sel-summary"></div>
      <button class="btn btn-p btn-sub" id="btn-submit" onclick="submitVote()">
        Confirm &amp; Submit Vote
      </button>
    </div>
  </div>

  <div class="card" id="success-section" style="display:none">
    <div class="success-wrap">
      <div class="s-icon">üöÄ</div>
      <div class="s-title">Vote Securely Submitted!</div>
      <p class="s-sub">Thank you, <strong id="success-name"></strong>. Your cryptographic ballot for the ESRC Committee Elections has been recorded.</p>
      <div class="s-box">
        <strong>üìã Post-Election Protocol:</strong>
        <ul>
          <li>Your votes instantly update the live tallies.</li>
          <li>President runner-up inherits VP-1.</li>
          <li>General Secretary runner-up inherits AGS-1.</li>
          <li>Executive runner-ups inherit Assistant roles.</li>
        </ul>
      </div>
      <button class="btn btn-o" onclick="location.reload()">Return to Home Terminal</button>
    </div>
  </div>

</div>

<!-- ‚ïê‚ïê PUBLIC REGISTRATION PAGE ‚ïê‚ïê -->
<div id="page-register" class="page">
  <div class="card gate-wrap" style="max-width: 600px;" id="reg-wrapper">
    <div class="gate-icon">üìù</div>
    <div class="gate-title">Open Registration</div>
    <div class="gate-sub">Register yourself as a voter or apply as a candidate. All submissions require admin approval before becoming active.</div>
    
    <div class="atabs" style="margin-bottom: 24px;">
      <button class="atab active" onclick="switchRegTab('voter', this)">üßë‚Äçüíª Register as Voter</button>
      <button class="atab" onclick="switchRegTab('candidate', this)">üéõÔ∏è Run for Office</button>
    </div>

    <!-- PUBLIC VOTER FORM -->
    <div id="reg-voter-form" style="text-align: left;">
      <div class="form-grid">
        <div class="fg"><label>Full Name *</label><input type="text" id="pub-nv-name" placeholder="John Doe"/></div>
        <div class="fg"><label>Student ID *</label><input type="text" id="pub-nv-sid" placeholder="e.g. 241-15-519"/></div>
        <div class="fg"><label>Email</label><input type="email" id="pub-nv-email" placeholder="name@diu.edu.bd"/></div>
        <div class="fg"><label>Department</label><input type="text" id="pub-nv-dept" placeholder="e.g. CSE"/></div>
        <div class="fg"><label>Batch</label><input type="text" id="pub-nv-batch" placeholder="e.g. Batch 65"/></div>
      </div>
      <div style="margin-top: 24px;">
        <button class="btn btn-p" style="width: 100%; padding: 14px;" id="btn-pub-add-voter" onclick="submitPublicVoter()">Submit Voter Registration</button>
      </div>
    </div>

    <!-- PUBLIC CANDIDATE FORM -->
    <div id="reg-cand-form" style="display:none; text-align: left;">
      <div class="form-grid">
        <div class="fg"><label>Full Name *</label><input type="text" id="pub-nc-name" placeholder="Candidate Name"/></div>
        <div class="fg"><label>Student ID</label><input type="text" id="pub-nc-sid" placeholder="e.g. 241-15-519"/></div>
        <div class="fg"><label>Target Position *</label>
          <select id="pub-nc-pos">
            <option value="">‚Äî Select Target Position ‚Äî</option>
            <optgroup label="Phase 1 ¬∑ Leadership">
              <option value="President">President</option>
              <option value="Vice President - 2">Vice President - 2</option>
              <option value="General Secretary">General Secretary</option>
              <option value="Assistant General Secretary - 2">Assistant General Secretary - 2</option>
            </optgroup>
            <optgroup label="Phase 2 ¬∑ Executive Council">
              <option value="Treasurer">Treasurer</option>
              <option value="Women's Secretary">Women's Secretary</option>
              <option value="Media Secretary">Media Secretary</option>
              <option value="Office Secretary">Office Secretary</option>
              <option value="Organizing Secretary">Organizing Secretary</option>
              <option value="Press Secretary">Press Secretary</option>
            </optgroup>
          </select>
        </div>
        <div class="fg"><label>Department</label><input type="text" id="pub-nc-dept" placeholder="e.g. CSE"/></div>
        <div class="fg"><label>Batch</label><input type="text" id="pub-nc-batch" placeholder="e.g. Batch 65"/></div>
        <div class="fg"><label>Image URL (Optional)</label><input type="text" id="pub-nc-image" placeholder="https://example.com/image.jpg"/></div>
        <div class="fg"><label>Payment No. (bKash/Nagad) *</label><input type="text" id="pub-nc-pay" placeholder="01XXXXXXXXX"/></div>
        <div class="fg"><label>Transaction ID *</label><input type="text" id="pub-nc-trx" placeholder="TXN..."/></div>
        
        <div class="fg full">
          <label>Terms & Conditions *</label>
          <div class="terms-box">
            <strong>‡ßß. ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø‡¶§‡¶æ ‡¶ì ‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ</strong><br>
            ‡¶ï‡¶Æ‡¶ø‡¶ü‡¶ø‡¶∞ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶¶‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶ï‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ESRC-‡¶è‡¶∞ ‡¶è‡¶ï‡¶ú‡¶® ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§<br><br>
            <strong>‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶∂‡¶∞‡ßç‡¶§ (Mandatory Prerequisite):</strong><br>
            ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶™‡¶¶‡ßá‡¶∞ ‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø‡¶§‡¶æ: ‡¶™‡ßç‡¶∞‡ßá‡¶∏‡¶ø‡¶°‡ßá‡¶®‡ßç‡¶ü, ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶≤ ‡¶∏‡ßá‡¶ï‡ßç‡¶∞‡ßá‡¶ü‡¶æ‡¶∞‡¶ø, ‡¶≠‡¶æ‡¶á‡¶∏ ‡¶™‡ßç‡¶∞‡ßá‡¶∏‡¶ø‡¶°‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶ø‡¶Ç‡¶¨‡¶æ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶ï‡ßÄ‡¶Ø‡¶º (Secretariat) ‡¶™‡¶¶‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶ï‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá ‡¶è‡¶ï‡ßç‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶ü‡¶ø‡¶≠ ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ (Executive Member) ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶¶‡¶æ‡¶Ø‡¶º‡¶ø‡¶§‡ßç‡¶¨ ‡¶™‡¶æ‡¶≤‡¶®‡ßá‡¶∞ ‡¶Ö‡¶≠‡¶ø‡¶ú‡ßç‡¶û‡¶§‡¶æ ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§ ‡¶Ö‡¶∞‡ßç‡¶•‡¶æ‡ßé, ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶∂‡ßÄ‡¶∞‡ßç‡¶∑ ‡¶™‡¶¶‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ; ‡¶ß‡¶æ‡¶™‡ßá ‡¶ß‡¶æ‡¶™‡ßá ‡¶™‡¶¶‡ßã‡¶®‡ßç‡¶®‡¶§‡¶ø ‡¶™‡ßá‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§<br><br>
            <strong>‡¶™‡ßç‡¶∞‡ßá‡¶∏‡¶ø‡¶°‡ßá‡¶®‡ßç‡¶ü ‡¶ì ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶≤ ‡¶∏‡ßá‡¶ï‡ßç‡¶∞‡ßá‡¶ü‡¶æ‡¶∞‡¶ø ‡¶™‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø‡¶§‡¶æ:</strong><br>
            ‡ßß. ‡¶Ö‡¶≠‡¶ø‡¶ú‡ßç‡¶û‡¶§‡¶æ: ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡ßß ‡¶•‡ßá‡¶ï‡ßá ‡ß® ‡¶¨‡¶õ‡¶∞‡ßá‡¶∞ ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶Ö‡¶≠‡¶ø‡¶ú‡ßç‡¶û‡¶§‡¶æ ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§<br>
            ‡ß®. ‡¶Ö‡¶§‡ßÄ‡¶§ ‡¶Ö‡¶¨‡¶¶‡¶æ‡¶®: ESRC-‡¶è‡¶∞ ‡¶¨‡¶ø‡¶ó‡¶§ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶ì ‡¶â‡¶®‡ßç‡¶®‡¶§‡¶ø‡¶§‡ßá ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶ï‡ßç‡¶∑ ‡¶Ö‡¶¨‡¶¶‡¶æ‡¶® ‡¶¨‡¶æ "Contributing Past" ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§<br>
            ‡ß©. ‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶´‡ßã‡¶≤‡¶ø‡¶ì ‡¶ì ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü: ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶ï‡ßá ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß®‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶¶‡¶∞‡ßç‡¶∂‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§ ‡¶Ö‡¶•‡¶¨‡¶æ, ‡¶®‡¶ø‡¶Æ‡ßç‡¶®‡¶≤‡¶ø‡¶ñ‡¶ø‡¶§ ‡¶ï‡ßç‡¶∑‡ßá‡¶§‡ßç‡¶∞‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶ï‡¶ü‡¶ø‡¶§‡ßá ‡¶Ö‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶¶‡¶ï‡ßç‡¶∑‡¶§‡¶æ (Exceptional Skill) ‡¶™‡ßç‡¶∞‡¶Æ‡¶æ‡¶£ ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá:<br>
            <ul>
              <li>‡ß©‡¶°‡¶ø ‡¶ï‡ßç‡¶Ø‡¶æ‡¶° ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® (3D CAD)</li>
              <li>‡¶∏‡¶æ‡¶∞‡ßç‡¶ï‡¶ø‡¶ü ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶®‡¶ø‡¶Ç (Circuit Designing)</li>
              <li>‡¶ó‡ßç‡¶∞‡¶æ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶®‡¶ø‡¶Ç (Graphics Designing)</li>
              <li>‡¶∏‡¶ø ‡¶™‡ßç‡¶∞‡ßã‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡¶ø‡¶Ç-‡¶è ‡¶≠‡¶æ‡¶≤‡ßã ‡¶¶‡¶ñ‡¶≤ (Good knowledge in C Programming)</li>
              <li>‡¶ì‡¶Ø‡¶º‡ßá‡¶¨ ‡¶°‡ßá‡¶≠‡ßá‡¶≤‡¶™‡¶Æ‡ßá‡¶®‡ßç‡¶ü (Web Development)</li>
              <li>‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶è‡¶®‡ßç‡¶° ‡¶ü‡ßá‡¶ï‡¶®‡ßã‡¶≤‡¶ú‡¶ø (Backend Technology)</li>
              <li>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶°‡ßá‡¶≠‡ßá‡¶≤‡¶™‡¶Æ‡ßá‡¶®‡ßç‡¶ü (Mobile App Development)</li>
            </ul>
          </div>
          <label style="display: flex; gap: 8px; align-items: start; margin-top: 12px; cursor: pointer;">
            <input type="checkbox" id="pub-nc-terms" style="width: auto; margin-top: 2px;" />
            <span style="font-size: 0.85rem; color: var(--md-on-surface-variant); line-height: 1.4; text-transform: none; font-weight: 500;">‡¶Ü‡¶Æ‡¶ø ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ ‡¶™‡ßú‡ßá‡¶õ‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßá‡¶®‡ßá ‡¶®‡¶ø‡¶ö‡ßç‡¶õ‡¶ø‡•§ (I have read and agree to the terms and conditions)</span>
          </label>
        </div>
        
        <div class="fg full"><label>Campaign Bio</label><textarea id="pub-nc-bio" placeholder="Short manifesto or vision statement..."></textarea></div>
      </div>
      <div style="margin-top: 24px;">
        <button class="btn btn-p" style="width: 100%; padding: 14px;" id="btn-pub-add-cand" onclick="submitPublicCandidate()">Submit Candidate Application</button>
      </div>
    </div>

  </div>
  
  <div class="card" id="reg-closed-msg" style="display: none; max-width: 600px; margin: 0 auto; text-align: center;">
    <div class="ei" style="font-size: 4rem; margin-bottom: 16px;">üõë</div>
    <h3 style="font-family: var(--font-heading); font-size: 1.8rem; margin-bottom: 8px; color: var(--md-on-surface);">Registration Closed</h3>
    <p style="color: var(--md-on-surface-variant); line-height: 1.6;">The public registration window is currently closed. If you believe this is an error, please contact the election administrator.</p>
  </div>
</div>

<!-- ‚ïê‚ïê LIVE RESULTS PAGE ‚ïê‚ïê -->
<div id="page-live" class="page">

  <div class="live-hero">
    <div class="live-icon">üì°</div>
    <div class="live-hero-txt">
      <h2>Live Results Dashboard</h2>
      <p>Real-time vote counting for all positions. Percentages represent the share of total votes cast for that specific role.</p>
    </div>
    <div class="live-meta">
      <div class="lm-voted" id="lv-voted">0</div>
      <div class="lm-label">Total Votes Cast</div>
      <div class="lm-pct" id="lv-pct">of 0 registered</div>
    </div>
  </div>

  <div class="live-refresh">
    <div class="refresh-badge">
      <span class="refresh-dot"></span>
      Updating in <span style="font-family:var(--font-heading); font-weight:800; color:var(--md-primary); margin:0 4px;" id="lv-countdown">10</span>s
    </div>
    <button class="btn btn-o btn-refresh-now" onclick="renderLive()" id="btn-refresh">Refresh Now</button>
    <div style="margin-left:auto;font-size:0.85rem;color:var(--md-on-surface-variant); font-family: var(--font-mono);" id="lv-lastupdate">‚Äî</div>
  </div>

  <div class="live-overall" id="lv-overall"></div>
  <div id="lv-body"></div>

</div>

<!-- ‚ïê‚ïê ADMIN PAGE ‚ïê‚ïê -->
<div id="page-admin" class="page">

  <div id="admin-gate" class="gate-wrap" style="padding-top: 40px;">
    <div class="card">
      <div class="card-title" style="margin-bottom: 24px; font-size: 1.6rem; text-align: center;">üõ°Ô∏è Admin Auth</div>
      <div class="fg" style="margin-bottom:28px">
        <label>Master Password</label>
        <input type="password" id="admin-pass" placeholder="Enter secure password..." onkeydown="if(event.key==='Enter')adminLogin()"/>
      </div>
      <button class="btn btn-p" style="width: 100%; padding: 14px;" onclick="adminLogin()" id="btn-admin-login">Access Admin Panel</button>
      <div class="err-box" id="admin-err"></div>
    </div>
  </div>

  <div id="admin-panel" style="display:none">
    <div class="admin-hdr-bar">
      <div>
        <h2>Election Control Center</h2>
        <p>Manage voters, candidates, and oversee real-time system metrics.</p>
      </div>
      <div style="display:flex;align-items:center;gap:24px;flex-wrap:wrap">
        <div class="toggle-wrap">
          <span id="reg-lbl">Open Registration</span>
          <label class="toggle"><input type="checkbox" id="reg-toggle" onchange="toggleRegistration()"/><span class="slider"></span></label>
        </div>
        <div class="toggle-wrap">
          <span id="elec-lbl">Accepting Votes</span>
          <label class="toggle"><input type="checkbox" id="elec-toggle" onchange="toggleElection()"/><span class="slider"></span></label>
        </div>
        <div class="toggle-wrap">
          <span id="live-lbl">Public Live Results</span>
          <label class="toggle"><input type="checkbox" id="live-toggle" onchange="toggleLive()"/><span class="slider"></span></label>
        </div>
        <button class="btn btn-o" style="padding: 8px 16px; border-color: transparent; color: var(--md-error);" onclick="adminLogout()">Sign Out</button>
      </div>
    </div>

    <div class="atabs">
      <button class="atab active" onclick="switchATab('voters',this)">üßë‚Äçüíª Voters Registry (<span id="atab-vc">0</span>)</button>
      <button class="atab" onclick="switchATab('candidates',this)">üéõÔ∏è Candidates Setup</button>
      <button class="atab" onclick="switchATab('results',this)">üìà Analytics & Reports</button>
    </div>

    <!-- VOTERS -->
    <div id="atab-voters">
      <!-- Admin Manual Add (Hidden by default to save space, focus on approvals) -->
      <div class="card" style="display: none;">
        <div class="card-title">Add Voter Manually</div>
        <div class="card-sub">Register members who were missed in the initial import.</div>
        <div class="form-grid">
          <div class="fg"><label>Full Name *</label><input type="text" id="nv-name" placeholder="John Doe"/></div>
          <div class="fg"><label>Student ID *</label><input type="text" id="nv-sid" placeholder="e.g. 241-15-519"/></div>
          <div class="fg"><label>Email</label><input type="email" id="nv-email" placeholder="name@diu.edu.bd"/></div>
          <div class="fg"><label>Department</label><input type="text" id="nv-dept" placeholder="e.g. CSE"/></div>
          <div class="fg"><label>Batch</label><input type="text" id="nv-batch" placeholder="e.g. Batch 65"/></div>
        </div>
        <div style="margin-top: 24px;"><button class="btn btn-p" id="btn-add-voter" onclick="addVoter()">Register Voter</button></div>
      </div>
      
      <div class="card">
        <div class="card-title">Voter Directory</div>
        <div class="card-sub" id="voter-count-lbl">‚Äî</div>
        <div style="display:flex; gap:16px; margin-bottom: 24px; flex-wrap: wrap;">
          <input type="text" placeholder="Search by name, ID or department‚Ä¶" oninput="filterVoters(this.value)" style="flex:1; min-width: 200px;"/>
          <button class="btn btn-o" onclick="renderVoterTable()">Refresh Directory</button>
        </div>
        <div class="twrap">
          <table>
            <thead><tr><th>#</th><th>Name</th><th>Student ID</th><th>Dept</th><th>Status</th><th>Approval</th><th>Action</th></tr></thead>
            <tbody id="voter-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- CANDIDATES -->
    <div id="atab-candidates" style="display:none">
      <div class="card">
        <div class="card-title">Active Ballot Candidates</div>
        <div class="card-sub">Review, approve, and manage registered candidates.</div>
        <div class="twrap" style="margin-top:24px;">
          <table>
            <thead><tr><th>#</th><th>Name</th><th>Position</th><th>Dept</th><th>Payment Info</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="cand-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="atab-results" style="display:none">
      <div class="live-overall">
        <div class="ov-card"><div class="ov-n" id="r-total">‚Äî</div><div class="ov-l">Voters</div></div>
        <div class="ov-card"><div class="ov-n" id="r-voted">‚Äî</div><div class="ov-l">Cast</div></div>
        <div class="ov-card"><div class="ov-n" id="r-pct">‚Äî</div><div class="ov-l">Turnout</div></div>
        <div class="ov-card"><div class="ov-n" id="r-pos">‚Äî</div><div class="ov-l">Direct</div></div>
        <div class="ov-card"><div class="ov-n" id="r-auto">8</div><div class="ov-l">Auto</div></div>
      </div>
      <div class="card">
        <div class="card-title">Final Assignment Report</div>
        <div class="card-sub">Detailed breakdown of winners and automatically assigned runner-ups.</div>
        <div id="results-body"><div class="empty"><div class="ei">üì≠</div><p>Awaiting votes...</p></div></div>
      </div>
    </div>

  </div>
</div>

</main>

<div id="toast"></div>

<footer>
  <strong>ESRC</strong> ‚Äî Embedded System Research Center &nbsp;&middot;&nbsp; 2026‚Äì2027 Secure Election Portal
</footer>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE INITIALIZATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL = 'https://pxqruwscthmedqmnaruz.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_58wOpVLaXUajnX0fUdtWPQ_ByhqfzXd';
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA & STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const POSITIONS = [
  { id:'president', name:'President', phase:1, batchNote:'Batch 61‚Äì63', runnerUpRole:'Vice President - 1' },
  { id:'vp2', name:'Vice President - 2', phase:1, batchNote:'Batch 64‚Äì65', runnerUpRole:null },
  { id:'gs', name:'General Secretary', phase:1, batchNote:'Batch 63‚Äì64', runnerUpRole:'Assistant General Secretary - 1' },
  { id:'ags2', name:'Assistant General Secretary - 2', phase:1, batchNote:'Batch 66+', runnerUpRole:null },
  { id:'treasurer', name:'Treasurer', phase:2, batchNote:'Batch 63‚Äì67', runnerUpRole:'Assistant Treasurer' },
  { id:'womens', name:"Women's Secretary", phase:2, batchNote:'Batch 63‚Äì67', runnerUpRole:"Joint Women's Secretary" },
  { id:'media', name:'Media Secretary', phase:2, batchNote:'Batch 63‚Äì67', runnerUpRole:'Assistant Media Secretary' },
  { id:'office', name:'Office Secretary', phase:2, batchNote:'Batch 63‚Äì67', runnerUpRole:'Assistant Office Secretary' },
  { id:'organizing', name:'Organizing Secretary', phase:2, batchNote:'Batch 63‚Äì67', runnerUpRole:'Assistant Organizing Secretary' },
  { id:'press', name:'Press Secretary', phase:2, batchNote:'Batch 63‚Äì67', runnerUpRole:'Assistant Press Secretary' },
];

let voters          = [];
let candidates      = [];
let votes           = {}; 
let selections      = {}; 

let registrationOpen = true;
let electionOpen    = true;
let liveResultsOpen = true; 
let currentVoter    = null;

const ADMIN_PASS    = 'admin123';

// ‚îÄ‚îÄ UI HELPERS FOR LOADING STATES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setBtnLoading(btnId, isLoading, originalText = '') {
  const btn = document.getElementById(btnId);
  if (!btn) return;
  if (isLoading) {
    btn.dataset.origText = btn.innerHTML;
    btn.classList.add('btn-loading');
    btn.innerHTML = `<svg class="inline-spinner" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25" style="opacity:0.25;"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" style="opacity:0.75;"></path></svg> Processing...`;
  } else {
    btn.classList.remove('btn-loading');
    btn.innerHTML = originalText || btn.dataset.origText;
  }
}

// ‚îÄ‚îÄ INITIAL DATA FETCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', async () => {
  await fetchData();
  
  // Hide loading screen smoothly
  const loader = document.getElementById('loading-overlay');
  loader.style.opacity = '0';
  setTimeout(() => loader.style.display = 'none', 300);
});

async function fetchData() {
  try {
    // 1. Fetch Settings
    const { data: settings } = await supabaseClient.from('election_settings').select('*').single();
    if(settings) {
      registrationOpen = settings.registration_open !== false; // Default true if column missing
      electionOpen = settings.is_open;
      liveResultsOpen = settings.live_results_public;
      updateStatusUI();
    }

    // 2. Fetch Voters
    const { data: vData } = await supabaseClient.from('voters').select('*');
    if(vData) {
      voters = vData.map(v => ({
        id: v.id, name: v.full_name, sid: v.student_id, 
        email: v.email, dept: v.department, batch: v.batch, voted: v.has_voted,
        isApproved: v.is_approved !== false // Default true if column doesn't exist yet to prevent total breakage
      }));
    }

    // 3. Fetch Candidates
    const { data: cData } = await supabaseClient.from('candidates').select('*');
    if(cData) {
      candidates = cData.map(c => ({
        id: c.id, name: c.full_name, sid: c.student_id, 
        position: c.target_position, dept: c.department, batch: c.batch, bio: c.bio, imageUrl: c.image_url,
        isApproved: c.is_approved !== false,
        paymentNumber: c.payment_number, trxId: c.transaction_id
      }));
    }

    // 4. Fetch Votes
    const { data: vtData } = await supabaseClient.from('votes').select('*');
    votes = {};
    if(vtData) {
      vtData.forEach(v => {
        if(!votes[v.voter_id]) votes[v.voter_id] = {};
        votes[v.voter_id][v.target_position] = v.candidate_id;
      });
    }

    // Trigger UI updates
    const activeVotersCount = voters.filter(v => v.isApproved).length;
    document.getElementById('total-pill').textContent = activeVotersCount;
    
    if(document.getElementById('page-admin').classList.contains('active')) {
      renderVoterTable(); 
      renderCandTable();
      if(document.getElementById('atab-results').style.display !== 'none') renderResults();
    }
    
    if(document.getElementById('page-live').classList.contains('active')) {
      renderLive();
    }

  } catch (err) {
    console.error("Fetch Error:", err);
  }
}

function updateStatusUI() {
  const bar = document.getElementById('status-bar');
  const txt = document.getElementById('status-text');
  
  // Admin Toggles
  const regToggle = document.getElementById('reg-toggle');
  const elecToggle = document.getElementById('elec-toggle');
  const liveToggle = document.getElementById('live-toggle');

  if(regToggle) regToggle.checked = registrationOpen;
  if(elecToggle) elecToggle.checked = electionOpen;
  if(liveToggle) liveToggle.checked = liveResultsOpen;

  // Registration Page UI
  const regWrapper = document.getElementById('reg-wrapper');
  const regClosedMsg = document.getElementById('reg-closed-msg');
  if(regWrapper && regClosedMsg) {
    if(registrationOpen) {
      regWrapper.style.display = '';
      regClosedMsg.style.display = 'none';
    } else {
      regWrapper.style.display = 'none';
      regClosedMsg.style.display = 'block';
    }
  }

  // Header UI
  if(electionOpen) {
    bar.className = '';
    txt.textContent = 'System Active: Secure Voting is currently OPEN';
  } else {
    bar.className = 'closed';
    txt.textContent = 'System Locked: Secure Voting is CLOSED';
  }
}

// ‚îÄ‚îÄ PAGE NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(p) {
  document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
  document.getElementById('page-' + p).classList.add('active');
  document.getElementById('hero-section').style.display = (p === 'voter' || p === 'register') ? '' : 'none';
  if(p === 'voter') resetGate();
  if(p === 'live') {
    startLiveRefresh();
  } else {
    stopLiveRefresh();
  }
  window.scrollTo({top:0, behavior:'smooth'});
}

function switchRegTab(type, btn) {
  document.querySelectorAll('#page-register .atab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('reg-voter-form').style.display = type === 'voter' ? '' : 'none';
  document.getElementById('reg-cand-form').style.display = type === 'candidate' ? '' : 'none';
}

// ‚îÄ‚îÄ PUBLIC REGISTRATION FLOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitPublicVoter() {
  const name  = document.getElementById('pub-nv-name').value.trim();
  const sid   = document.getElementById('pub-nv-sid').value.trim();
  const email = document.getElementById('pub-nv-email').value.trim();
  const dept  = document.getElementById('pub-nv-dept').value.trim();
  const batch = document.getElementById('pub-nv-batch').value.trim();
  
  if(!name || !sid) { toast('Name and Student ID are required.', true); return; }
  
  // Refresh data first to check for duplicates
  await fetchData();
  if(voters.find(v => v.sid === sid)) { toast('ID already registered.', true); return; }
  
  setBtnLoading('btn-pub-add-voter', true);
  
  const { error } = await supabaseClient.from('voters').insert([{
    full_name: name, student_id: sid, email: email, department: dept, batch: batch, is_approved: false
  }]);

  if(error) {
    toast(error.message, true);
    setBtnLoading('btn-pub-add-voter', false, 'Submit Voter Registration');
    return;
  }

  ['pub-nv-name','pub-nv-sid','pub-nv-email','pub-nv-dept','pub-nv-batch'].forEach(f => document.getElementById(f).value = '');
  await fetchData();
  toast('Registration submitted! Awaiting Admin Approval.');
  setBtnLoading('btn-pub-add-voter', false, 'Submit Voter Registration');
}

async function submitPublicCandidate() {
  const name     = document.getElementById('pub-nc-name').value.trim();
  const sid      = document.getElementById('pub-nc-sid').value.trim();
  const pos      = document.getElementById('pub-nc-pos').value;
  const dept     = document.getElementById('pub-nc-dept').value.trim();
  const batch    = document.getElementById('pub-nc-batch').value.trim();
  const imageUrl = document.getElementById('pub-nc-image').value.trim();
  const pay      = document.getElementById('pub-nc-pay').value.trim();
  const trx      = document.getElementById('pub-nc-trx').value.trim();
  const bio      = document.getElementById('pub-nc-bio').value.trim();
  const termsBox = document.getElementById('pub-nc-terms');
  
  if(!name || !pos || !pay || !trx) { toast('Name, Target Position, and Payment details are required.', true); return; }
  if(!termsBox.checked) { toast('‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ‡¶§‡ßá ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§‡¶ø ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§', true); return; }
  
  setBtnLoading('btn-pub-add-cand', true);
  
  const { error } = await supabaseClient.from('candidates').insert([{
    full_name: name, student_id: sid, target_position: pos, department: dept, batch: batch, image_url: imageUrl, bio: bio, payment_number: pay, transaction_id: trx, is_approved: false
  }]);

  if(error) { 
    toast(error.message, true); 
    setBtnLoading('btn-pub-add-cand', false, 'Submit Candidate Application');
    return; 
  }

  ['pub-nc-name','pub-nc-sid','pub-nc-dept','pub-nc-batch','pub-nc-image','pub-nc-pay','pub-nc-trx','pub-nc-bio'].forEach(f => document.getElementById(f).value = '');
  document.getElementById('pub-nc-pos').value = '';
  termsBox.checked = false;
  
  await fetchData();
  toast('Candidate Application submitted! Awaiting Admin Approval.');
  setBtnLoading('btn-pub-add-cand', false, 'Submit Candidate Application');
}


// ‚îÄ‚îÄ VOTER FLOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resetGate() {
  show('voter-gate'); hide('ballot-section'); hide('success-section');
  document.getElementById('voter-id-input').value = '';
  document.getElementById('gate-err').classList.remove('show');
  currentVoter = null; selections = {};
}

async function verifyVoter() {
  if(!electionOpen) { showErr('gate-err', 'The election is currently closed.'); return; }
  const sid = document.getElementById('voter-id-input').value.trim();
  if(!sid) { showErr('gate-err', 'Please enter your Student ID.'); return; }
  
  setBtnLoading('btn-verify', true);
  
  // Re-fetch to ensure we have latest vote status before letting them in
  await fetchData();
  
  const v = voters.find(x => x.sid === sid);
  if(!v) { 
    showErr('gate-err', 'ID not found in registry. Please register first.'); 
    setBtnLoading('btn-verify', false, 'Verify &amp; Open Ballot ‚Üí');
    return; 
  }
  if(!v.isApproved) {
    showErr('gate-err', 'Registration pending. An Admin must approve your account before you can vote.'); 
    setBtnLoading('btn-verify', false, 'Verify &amp; Open Ballot ‚Üí');
    return; 
  }
  if(v.voted || votes[v.id]) { 
    showErr('gate-err', 'You have already voted. Only one submission is allowed.'); 
    setBtnLoading('btn-verify', false, 'Verify &amp; Open Ballot ‚Üí');
    return; 
  }
  
  setBtnLoading('btn-verify', false, 'Verify &amp; Open Ballot ‚Üí');
  currentVoter = v;
  selections[v.id] = {};
  buildBallot();
  hide('voter-gate');
  show('ballot-section');
  document.getElementById('bh-name').textContent = v.name;
  document.getElementById('bh-meta').textContent = v.dept + ' ‚Ä¢ ' + v.batch + ' ‚Ä¢ ID: ' + v.sid;
  updateProgress();
  window.scrollTo({top:0, behavior:'smooth'});
}

function buildBallot() {
  const body = document.getElementById('ballot-body');
  body.innerHTML = '';
  let currentPhase = 0;
  
  // Filter out unapproved candidates from the ballot
  const activeCandidates = candidates.filter(c => c.isApproved);

  POSITIONS.forEach(pos => {
    const cands = activeCandidates.filter(c => c.position === pos.name);
    if(!cands.length) return;

    if(pos.phase !== currentPhase) {
      currentPhase = pos.phase;
      const banner = document.createElement('div');
      banner.className = 'phase-banner';
      banner.innerHTML = `
        <div class="ph-num">${pos.phase}</div>
        <div class="ph-txt">
          <b>${pos.phase === 1 ? 'Phase 1: Leadership Council' : 'Phase 2: Executive Board'}</b>
          <span>${pos.phase === 1 ? 'President, VP, and General Secretaries' : 'Specialized Executive Secretaries'}</span>
        </div>`;
      body.appendChild(banner);
    }

    const div = document.createElement('div');
    div.className = 'pos-card';
    div.id = 'poscard-' + pos.id;
    div.innerHTML = `
      <div class="pos-head">
        <div class="pos-name">
          ${esc(pos.name)}
          ${pos.runnerUpRole ? `<span class="auto-tag">‚ö° Runner-up becomes ${esc(pos.runnerUpRole)}</span>` : ''}
        </div>
        <div class="pos-rule"><span>üìå</span> ${esc(pos.batchNote)} &middot; Select exactly one candidate</div>
      </div>
      <div class="cands-grid" id="grid-${pos.id}">
        ${cands.map(c => `
          <div class="cand" id="cc-${c.id}" data-posid="${pos.id}" data-cid="${c.id}" onclick="pick(this)">
            <div class="cand-radio"></div>
            <div class="cav" ${c.imageUrl ? `style="background-image: url('${esc(c.imageUrl)}'); background-size: cover; background-position: center; border-color: transparent;"` : ''}>
              ${c.imageUrl ? '' : c.name.trim()[0]}
            </div>
            <div class="cname">${esc(c.name)}</div>
            <div class="cmeta">${esc(c.batch)} &middot; ${esc(c.dept)}</div>
            ${c.bio ? `<div class="cbio">"${esc(c.bio)}"</div>` : ''}
          </div>`).join('')}
      </div>`;
    body.appendChild(div);
  });

  if(!body.children.length) {
    body.innerHTML = '<div class="card"><div class="empty"><div class="ei">ü™´</div><p>No active candidates available for voting yet.</p></div></div>';
  }
}

function pick(el) {
  const posId   = el.dataset.posid;
  const cid     = el.dataset.cid; // UUID strings instead of ints
  const pos     = POSITIONS.find(p => p.id === posId);
  const posName = pos ? pos.name : posId;
  
  document.querySelectorAll(`#grid-${posId} .cand`).forEach(e => e.classList.remove('sel'));
  el.classList.add('sel');
  
  const posCard = document.getElementById('poscard-' + posId);
  if(posCard) posCard.classList.add('has-sel');
  
  selections[currentVoter.id][posName] = cid;
  updateProgress();
  updateSummary();
}

function updateProgress() {
  const activeCandidates = candidates.filter(c => c.isApproved);
  const activePosCount = POSITIONS.filter(p => activeCandidates.some(c => c.position === p.name)).length;
  const selected = Object.keys(selections[currentVoter.id] || {}).length;
  const pct = activePosCount ? Math.round(selected / activePosCount * 100) : 0;
  
  document.getElementById('pt-bar').style.width = pct + '%';
  document.getElementById('pt-count').textContent = `${selected} / ${activePosCount} Processed`;
}

function updateSummary() {
  const sel = selections[currentVoter.id] || {};
  const activeCandidates = candidates.filter(c => c.isApproved);
  
  const lines = POSITIONS
    .filter(p => activeCandidates.some(c => c.position === p.name))
    .map(p => {
      const cid = sel[p.name];
      if(cid) {
        const c = activeCandidates.find(x => x.id === cid);
        return `<div><span style="color:var(--md-primary);margin-right:8px;font-size:1.2rem;vertical-align:sub;">‚úÖ</span><b>${esc(p.name)}</b>${esc(c ? c.name : '‚Äî')}</div>`;
      }
      return `<div class="miss"><span>‚ö†Ô∏è</span> <b>${esc(p.name)}</b>Pending selection</div>`;
    }).join('');
  document.getElementById('sel-summary').innerHTML = lines || '<em>No selections made yet.</em>';
}

async function submitVote() {
  const sel = selections[currentVoter.id] || {};
  const activeCandidates = candidates.filter(c => c.isApproved);
  const activePosCount = POSITIONS.filter(p => activeCandidates.some(c => c.position === p.name)).length;
  
  if(Object.keys(sel).length < activePosCount) { 
    toast('Please make a selection for every position before submitting.', true); 
    return; 
  }
  if(!confirm('Are you sure you want to submit your ballot? Your choices are final and securely encrypted.')) return;
  
  // Format for Supabase Insertion
  const votesToInsert = Object.keys(sel).map(posName => ({
    voter_id: currentVoter.id,
    candidate_id: sel[posName],
    target_position: posName
  }));

  setBtnLoading('btn-submit', true);
  
  try {
    const { error: voteErr } = await supabaseClient.from('votes').insert(votesToInsert);
    if (voteErr) { throw voteErr; }

    const { error: uErr } = await supabaseClient.from('voters').update({ has_voted: true }).eq('id', currentVoter.id);
    if (uErr) { throw uErr; }

    // Success State
    votes[currentVoter.id] = sel;
    currentVoter.voted = true;
    hide('ballot-section');
    show('success-section');
    document.getElementById('success-name').textContent = currentVoter.name;
    
    // Refresh Global Sync
    await fetchData();

  } catch(err) {
    toast('Error submitting vote: ' + err.message, true);
  } finally {
    setBtnLoading('btn-submit', false, 'Confirm &amp; Submit Vote');
  }
}

// ‚îÄ‚îÄ ADMIN CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function toggleRegistration() {
  registrationOpen = document.getElementById('reg-toggle').checked;
  await supabaseClient.from('election_settings').update({registration_open: registrationOpen}).eq('id', 1);
  updateStatusUI();
  toast(registrationOpen ? 'Registration is now OPEN.' : 'Registration is now CLOSED.');
}

async function toggleElection() {
  electionOpen = document.getElementById('elec-toggle').checked;
  await supabaseClient.from('election_settings').update({is_open: electionOpen}).eq('id', 1);
  updateStatusUI();
  toast(electionOpen ? 'System is accepting votes.' : 'System is locked.');
}

async function toggleLive() {
  liveResultsOpen = document.getElementById('live-toggle').checked;
  await supabaseClient.from('election_settings').update({live_results_public: liveResultsOpen}).eq('id', 1);
  updateStatusUI();
  toast(liveResultsOpen ? 'Live results are now visible.' : 'Live results are hidden.');
  if (document.getElementById('page-live').classList.contains('active')) renderLive();
}

function adminLogin() {
  if(document.getElementById('admin-pass').value === ADMIN_PASS) {
    hide('admin-gate'); show('admin-panel');
    renderVoterTable(); renderCandTable();
    toast('Authenticated successfully.');
  } else {
    showErr('admin-err', 'Invalid credentials.');
  }
}

function adminLogout() {
  show('admin-gate'); hide('admin-panel');
  document.getElementById('admin-pass').value = '';
}

function switchATab(name, btn) {
  ['voters','candidates','results'].forEach(t => document.getElementById('atab-'+t).style.display = t === name ? '' : 'none');
  document.querySelectorAll('.atab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if(name === 'results') renderResults();
}

// ‚îÄ‚îÄ ADMIN: VOTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let vFilter = '';
function filterVoters(q) { vFilter = q.toLowerCase(); renderVoterTable(); }

async function addVoter() {
  const name  = document.getElementById('nv-name').value.trim();
  const sid   = document.getElementById('nv-sid').value.trim();
  const email = document.getElementById('nv-email').value.trim();
  const dept  = document.getElementById('nv-dept').value.trim();
  const batch = document.getElementById('nv-batch').value.trim();
  
  if(!name || !sid) { toast('Name and Student ID required.', true); return; }
  if(voters.find(v => v.sid === sid)) { toast('ID already registered.', true); return; }
  
  setBtnLoading('btn-add-voter', true);
  
  // Admin manual adds are explicitly auto-approved
  const { error } = await supabaseClient.from('voters').insert([{
    full_name: name, student_id: sid, email: email, department: dept, batch: batch, is_approved: true
  }]);

  if(error) {
    toast(error.message, true);
    setBtnLoading('btn-add-voter', false, 'Register Voter');
    return;
  }

  ['nv-name','nv-sid','nv-email','nv-dept','nv-batch'].forEach(f => document.getElementById(f).value = '');
  await fetchData();
  toast('Voter manually registered and approved.');
  setBtnLoading('btn-add-voter', false, 'Register Voter');
}

async function approveVoter(id) {
  if(!confirm('Approve this voter for the election?')) return;
  const { error } = await supabaseClient.from('voters').update({ is_approved: true }).eq('id', id);
  if(error) { toast(error.message, true); return; }
  await fetchData();
  toast('Voter Approved.');
}

async function editVoter(id) {
  const v = voters.find(x => x.id === id);
  if (!v) return;
  const newName = prompt("Edit Voter Name:", v.name);
  if (newName === null || newName.trim() === '') return;
  const newSid = prompt("Edit Student ID:", v.sid);
  if (newSid === null || newSid.trim() === '') return;
  
  const { error } = await supabaseClient.from('voters').update({ full_name: newName.trim(), student_id: newSid.trim() }).eq('id', id);
  if(error) { toast(error.message, true); return; }
  await fetchData();
  toast('Voter updated.');
}

async function removeVoter(id) {
  if(!confirm('Permanently remove this voter?')) return;
  const { error } = await supabaseClient.from('voters').delete().eq('id', id);
  if(error) { toast(error.message, true); return; }
  await fetchData();
  toast('Voter removed.');
}

function renderVoterTable() {
  const list = voters.filter(v => 
    !vFilter || 
    v.name.toLowerCase().includes(vFilter) || 
    v.sid.toLowerCase().includes(vFilter) || 
    (v.dept||'').toLowerCase().includes(vFilter)
  );
  
  const voted = voters.filter(v => v.voted || votes[v.id]).length;
  const approved = voters.filter(v => v.isApproved).length;
  
  document.getElementById('atab-vc').textContent = voters.length;
  document.getElementById('voter-count-lbl').textContent = `${voters.length} total ‚Ä¢ ${approved} approved ‚Ä¢ ${voted} voted`;

  const tb = document.getElementById('voter-tbody');
  if(!list.length) { tb.innerHTML = `<tr><td colspan="7"><div class="empty"><div class="ei">üì≠</div>No matching records.</div></td></tr>`; return; }
  
  tb.innerHTML = list.map((v,i) => `
    <tr>
      <td style="color:var(--md-outline)">${i+1}</td>
      <td><strong>${esc(v.name)}</strong></td>
      <td style="font-family:var(--font-mono); font-size:0.85rem;">${esc(v.sid)}</td>
      <td>${esc(v.dept||'‚Äî')}</td>
      <td><span class="badge ${(v.voted||votes[v.id]) ? 'bg' : 'bo'}">${(v.voted||votes[v.id]) ? 'Voted' : 'Pending'}</span></td>
      <td>${v.isApproved ? '<span class="badge bg">Approved</span>' : '<span class="badge bo">Awaiting</span>'}</td>
      <td style="white-space:nowrap; display:flex; gap:8px;">
        ${!v.isApproved ? `<button class="btn-approve" onclick="approveVoter('${v.id}')">Approve</button>` : ''}
        <button class="btn-edit" onclick="editVoter('${v.id}')">Edit</button>
        <button class="btn-d" onclick="removeVoter('${v.id}')">Del</button>
      </td>
    </tr>`).join('');
}

// ‚îÄ‚îÄ ADMIN: CANDIDATES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function approveCandidate(id) {
  if(!confirm('Approve this candidate for the ballot?')) return;
  const { error } = await supabaseClient.from('candidates').update({ is_approved: true }).eq('id', id);
  if(error) { toast(error.message, true); return; }
  await fetchData();
  toast('Candidate Approved.');
}

async function editCandidate(id) {
  const c = candidates.find(x => x.id === id);
  if (!c) return;
  const newName = prompt("Edit Candidate Name:", c.name);
  if (newName === null || newName.trim() === '') return;
  
  const { error } = await supabaseClient.from('candidates').update({ full_name: newName.trim() }).eq('id', id);
  if(error) { toast(error.message, true); return; }
  await fetchData();
  toast('Candidate updated.');
}

async function removeCandidate(id) {
  if(!confirm('Remove this candidate?')) return;
  const { error } = await supabaseClient.from('candidates').delete().eq('id', id);
  if(error) { toast(error.message, true); return; }
  await fetchData();
  toast('Candidate removed.');
}

function renderCandTable() {
  const tb = document.getElementById('cand-tbody');
  if(!candidates.length) { tb.innerHTML = `<tr><td colspan="7"><div class="empty"><div class="ei">ü™´</div>No candidates found.</div></td></tr>`; return; }
  
  tb.innerHTML = candidates.map((c,i) => `
    <tr>
      <td style="color:var(--md-outline)">${i+1}</td>
      <td><strong>${esc(c.name)}</strong></td>
      <td><span class="badge bg">${esc(c.position)}</span></td>
      <td>${esc(c.dept||'‚Äî')}</td>
      <td>
        ${c.trxId ? `<div style="font-size:0.75rem; color:var(--md-on-surface-variant); font-family:var(--font-mono);">Num: ${esc(c.paymentNumber)}<br>Trx: <strong style="color:var(--md-on-surface);">${esc(c.trxId)}</strong></div>` : '‚Äî'}
      </td>
      <td>${c.isApproved ? '<span class="badge bg">Approved</span>' : '<span class="badge bo">Awaiting</span>'}</td>
      <td style="white-space:nowrap; display:flex; gap:8px;">
        ${!c.isApproved ? `<button class="btn-approve" onclick="approveCandidate('${c.id}')">Approve</button>` : ''}
        <button class="btn-edit" onclick="editCandidate('${c.id}')">Edit</button>
        <button class="btn-d" onclick="removeCandidate('${c.id}')">Del</button>
      </td>
    </tr>`).join('');
}

// ‚îÄ‚îÄ SHARED REPORTING LOGIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function aggregateResults() {
  const vcounts = {};
  Object.values(votes).forEach(sel => {
    Object.values(sel).forEach(cid => {
      vcounts[cid] = (vcounts[cid] || 0) + 1;
    });
  });

  const posMap = {};
  // Only tally votes for approved candidates
  candidates.filter(c => c.isApproved).forEach(c => {
    if(!posMap[c.position]) posMap[c.position] = [];
    posMap[c.position].push({...c, vc: vcounts[c.id] || 0});
  });
  return posMap;
}

// ‚îÄ‚îÄ ADMIN: RESULTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderResults() {
  const total = voters.filter(v => v.isApproved).length; // Tally based on active voters
  const voted = voters.filter(v => v.voted || votes[v.id]).length;
  
  document.getElementById('r-total').textContent = total;
  document.getElementById('r-voted').textContent = voted;
  document.getElementById('r-pct').textContent   = total ? Math.round(voted/total*100) + '%' : '0%';
  document.getElementById('r-pos').textContent   = POSITIONS.length;

  const posMap = aggregateResults();
  const activePositions = POSITIONS.filter(p => posMap[p.name]);
  const body = document.getElementById('results-body');
  
  if(!activePositions.length) {
    body.innerHTML = '<div class="empty"><div class="ei">üì≠</div><p>Awaiting votes on approved candidates...</p></div>';
    return;
  }

  let html = '';
  activePositions.forEach(pos => {
    const sorted = [...posMap[pos.name]].sort((a,b) => b.vc - a.vc);
    const winner = sorted[0];
    const runnerup = sorted[1];
    const max = Math.max(winner?.vc || 0, 1);

    html += `<div style="margin-bottom:40px; padding-bottom:32px; border-bottom:1px solid var(--md-outline-variant)">
      <h4 style="font-family:var(--font-heading); font-size:1.25rem; margin-bottom:20px; color:var(--md-on-surface);">${esc(pos.name)}</h4>
      ${sorted.map((c,i) => `
        <div style="margin-bottom:16px; display:flex; align-items:center; gap:20px;">
          <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--md-surface-variant); text-align:center; line-height: 32px; color:var(--md-on-surface-variant); font-weight: bold; flex-shrink:0;">${i===0 && c.vc>0 ? 'üèÜ' : i+1}</div>
          <div style="width: 48px; height: 48px; border-radius: 50%; background-color: var(--md-surface-variant); color: var(--md-on-surface-variant); display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; overflow: hidden; border: 2px solid var(--md-outline-variant); ${c.imageUrl ? `background-image: url('${esc(c.imageUrl)}'); background-size: cover; background-position: center; border-color: transparent;` : ''}">
            ${c.imageUrl ? '' : c.name.trim()[0]}
          </div>
          <div style="flex:1">
            <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:1rem">
              <strong>${esc(c.name)}</strong>
              <span style="color:var(--md-on-surface-variant); font-weight: 600;">${c.vc} votes</span>
            </div>
            <div style="background:var(--md-surface-variant); height:10px; border-radius:100px; overflow:hidden;">
              <div style="background:var(--md-primary); width:${Math.round(c.vc/max*100)}%; height:100%; border-radius:100px;"></div>
            </div>
          </div>
        </div>
      `).join('')}
      ${pos.runnerUpRole && runnerup && runnerup.vc > 0 ? `
        <div class="runner-assign" style="margin-top:24px;">
          ‚ö° Runner-up <b>${esc(runnerup.name)}</b> secures the role of <b>${esc(pos.runnerUpRole)}</b>.
        </div>` : ''}
    </div>`;
  });
  body.innerHTML = html;
}

// ‚îÄ‚îÄ LIVE DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let liveTimer = null;
let liveCountdown = 10;

async function startLiveRefresh() {
  stopLiveRefresh();
  
  // Show spinner inside refresh button instantly on page load
  setBtnLoading('btn-refresh', true);
  await fetchData(); 
  setBtnLoading('btn-refresh', false, 'Refresh Now');
  renderLive();
  
  liveCountdown = 10;
  liveTimer = setInterval(async () => {
    liveCountdown--;
    const el = document.getElementById('lv-countdown');
    if(el) el.textContent = liveCountdown;
    if(liveCountdown <= 0) { 
      setBtnLoading('btn-refresh', true);
      await fetchData(); // Pull fresh db data
      setBtnLoading('btn-refresh', false, 'Refresh Now');
      renderLive(); 
      liveCountdown = 10; 
    }
  }, 1000);
}

function stopLiveRefresh() { if(liveTimer) clearInterval(liveTimer); }

function renderLive() {
  liveCountdown = 10;
  
  if (!liveResultsOpen) {
    document.getElementById('lv-voted').textContent = '-';
    document.getElementById('lv-pct').textContent = 'Hidden by Administrator';
    document.getElementById('lv-lastupdate').textContent = 'Last sync: ' + new Date().toLocaleTimeString();
    document.getElementById('lv-overall').innerHTML = '';
    document.getElementById('lv-body').innerHTML = `
      <div class="card">
        <div class="empty">
          <div class="ei">üõ°Ô∏è</div>
          <h3 style="font-family:var(--font-heading); font-size:1.8rem; color:var(--md-on-surface); margin-bottom:12px;">Live Results Hidden</h3>
          <p>The administrator has temporarily hidden the live public telecast to ensure integrity during ballot processing.</p>
        </div>
      </div>`;
    return;
  }

  const totalVoters = voters.filter(v => v.isApproved).length;
  const totalVoted  = voters.filter(v => v.voted || votes[v.id]).length;
  
  document.getElementById('lv-voted').textContent = totalVoted;
  document.getElementById('lv-pct').textContent = `of ${totalVoters} approved voters`;
  document.getElementById('lv-lastupdate').textContent = 'Last sync: ' + new Date().toLocaleTimeString();

  const posMap = aggregateResults();
  const activePositions = POSITIONS.filter(p => posMap[p.name]);
  
  document.getElementById('lv-overall').innerHTML = `
    <div class="ov-card"><div class="ov-n">${totalVoted}</div><div class="ov-l">Total Ballots Cast</div></div>
    <div class="ov-card"><div class="ov-n">${totalVoters ? Math.round(totalVoted/totalVoters*100) : 0}%</div><div class="ov-l">Voter Turnout</div></div>
    <div class="ov-card"><div class="ov-n">${activePositions.length}</div><div class="ov-l">Active Races</div></div>
  `;

  const body = document.getElementById('lv-body');
  if(!activePositions.length) {
    body.innerHTML = '<div class="card"><div class="empty"><div class="ei">ü™´</div>Awaiting approved candidates...</div></div>';
    return;
  }

  let html = '';
  activePositions.forEach(pos => {
    const cands = (posMap[pos.name] || []).sort((a,b) => b.vc - a.vc);
    const posTotal = cands.reduce((s,c) => s + c.vc, 0);
    const winner = cands[0];
    const runnerup = cands[1];

    html += `<div class="live-pos-card">
      <div class="lpc-header">
        <div>
          <div class="lpc-name">${esc(pos.name)}</div>
          <div class="lpc-total">${posTotal} total votes distributed</div>
        </div>
      </div>
      ${cands.map((c, i) => {
        const pct = posTotal > 0 ? Math.round(c.vc / posTotal * 100) : 0;
        const isLeading = i === 0 && c.vc > 0;
        return `
          <div class="live-cand-row ${isLeading ? 'leading' : ''}">
            <div class="lcr-rank">${i === 0 && c.vc > 0 ? 'üèÜ' : i + 1}</div>
            <div class="lcr-avatar" ${c.imageUrl ? `style="background-image: url('${esc(c.imageUrl)}'); background-size: cover; background-position: center; border-color: transparent;"` : ''}>
              ${c.imageUrl ? '' : c.name.trim()[0]}
            </div>
            <div class="lcr-info">
              <div class="lcr-name">${esc(c.name)}</div>
              <div class="lcr-meta">${esc(c.batch)} &middot; ${esc(c.dept)}</div>
              <div class="lcr-bar-wrap"><div class="lcr-bar" style="width:${pct}%"></div></div>
            </div>
            <div>
              <div class="lcr-pct">${pct}%</div>
              <div class="lcr-votes">${c.vc} votes</div>
            </div>
          </div>`;
      }).join('')}
      ${pos.runnerUpRole && runnerup && runnerup.vc > 0 ? `
        <div class="runner-assign">
          <span>‚ö°</span>
          <span>Based on current projections, <strong>${esc(runnerup.name)}</strong> tracks for <strong>${esc(pos.runnerUpRole)}</strong>.</span>
        </div>` : ''}
    </div>`;
  });
  body.innerHTML = html;
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function show(id) { document.getElementById(id).style.display = ''; }
function hide(id) { document.getElementById(id).style.display = 'none'; }
function showErr(id, msg) {
  const e = document.getElementById(id);
  e.textContent = msg; e.classList.add('show');
  setTimeout(() => e.classList.remove('show'), 4000);
}
function toast(msg, err=false) {
  const t = document.getElementById('toast');
  t.innerHTML = (err ? '‚ö†Ô∏è ' : '‚úÖ ') + msg; 
  t.className = 'show' + (err ? ' err' : '');
  setTimeout(() => t.className = '', 3000);
}
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
</script>
</body>
</html>