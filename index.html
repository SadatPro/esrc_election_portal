<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ESRC Elections 2026‚Äì2027 | Voting Portal</title>

<!-- Modern Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap" rel="stylesheet">

<style>
:root {
  /* Green Color Palette */
  --primary: #00E676;           /* Vibrant Green */
  --primary-hover: #00C853; 
  --primary-glow: rgba(0, 230, 118, 0.4);
  --primary-subtle: rgba(0, 230, 118, 0.15);
  
  --bg-gradient: linear-gradient(135deg, #021a12 0%, #06402b 100%);
  
  /* Glassmorphism Variables */
  --glass-bg: rgba(255, 255, 255, 0.06);
  --glass-bg-hover: rgba(255, 255, 255, 0.1);
  --glass-bg-active: rgba(255, 255, 255, 0.15);
  --glass-border: rgba(255, 255, 255, 0.12);
  --glass-border-light: rgba(255, 255, 255, 0.25);
  
  --text-main: #FFFFFF;
  --text-sec: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.4);
  
  --danger: #FF3B30;
  --danger-glass: rgba(255, 59, 48, 0.15);
  --warning: #FFD600;
  --warning-glass: rgba(255, 214, 0, 0.15);
  
  /* Typography */
  --font-body: 'Inter', -apple-system, sans-serif;
  --font-heading: 'Plus Jakarta Sans', sans-serif;
  --font-mono: ui-monospace, SFMono-Regular, Consolas, monospace;
  
  /* Radii */
  --radius-sm: 10px;
  --radius-md: 16px;
  --radius-lg: 24px;
  --radius-xl: 32px;
  --radius-pill: 100px;
  
  /* Shadows */
  --shadow-glass: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
  --shadow-glow: 0 0 20px var(--primary-glow);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; }

body { 
  font-family: var(--font-body); 
  background: var(--bg-gradient);
  background-attachment: fixed;
  color: var(--text-main); 
  min-height: 100vh; 
  overflow-x: hidden; 
  line-height: 1.5; 
  font-size: 16px;
}

/* Glowing Ambient Orbs for Glassmorphism Refraction */
body::before {
  content: ''; position: fixed; top: -10%; left: -10%; width: 50vw; height: 50vw;
  background: radial-gradient(circle, rgba(0, 230, 118, 0.15) 0%, transparent 60%);
  border-radius: 50%; z-index: -1; pointer-events: none;
}
body::after {
  content: ''; position: fixed; bottom: -10%; right: -10%; width: 40vw; height: 40vw;
  background: radial-gradient(circle, rgba(0, 200, 83, 0.2) 0%, transparent 60%);
  border-radius: 50%; z-index: -1; pointer-events: none;
}

/* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
@keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
@keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

/* ‚îÄ‚îÄ GLASS MIXIN ‚îÄ‚îÄ */
.glass-panel {
  background: var(--glass-bg);
  backdrop-filter: blur(16px) saturate(180%);
  -webkit-backdrop-filter: blur(16px) saturate(180%);
  border: 1px solid var(--glass-border);
  box-shadow: var(--shadow-glass);
}

/* ‚îÄ‚îÄ LOADING OVERLAY ‚îÄ‚îÄ */
#loading-overlay {
  position: fixed; inset: 0; background: rgba(2, 26, 18, 0.85); backdrop-filter: blur(20px); z-index: 9999;
  display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.4s ease;
}
.spinner {
  width: 50px; height: 50px; border: 4px solid var(--glass-border-light); border-top-color: var(--primary);
  border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; box-shadow: var(--shadow-glow);
}
.inline-spinner {
  width: 18px; height: 18px; border-width: 2px; border-color: rgba(255,255,255,0.3); border-top-color: #fff;
  border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px;
}
.btn-loading { pointer-events: none; opacity: 0.8; }

/* ‚îÄ‚îÄ STATUS BAR ‚îÄ‚îÄ */
#status-bar { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 8px 16px; font-size: 13px; font-weight: 600; color: #000; background: var(--primary); transition: background 0.3s; z-index: 400; position: relative;}
#status-bar.closed { background: var(--danger); color: #fff;}
.sdot { width: 8px; height: 8px; border-radius: 50%; background: #000; flex-shrink: 0; animation: blink 2s infinite; }
#status-bar.closed .sdot { background: #fff; animation: none; }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header { background: rgba(2, 26, 18, 0.6); backdrop-filter: blur(24px) saturate(180%); -webkit-backdrop-filter: blur(24px) saturate(180%); position: sticky; top: 0; z-index: 300; border-bottom: 1px solid var(--glass-border); }
.hdr { max-width: 1040px; margin: 0 auto; padding: 0 24px; height: 72px; display: flex; align-items: center; justify-content: space-between; gap: 16px; }
.logo { display: flex; align-items: center; gap: 12px; cursor: pointer; text-decoration: none; }
.logo-ico { width: 40px; height: 40px; background: var(--primary-subtle); border: 1px solid var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; box-shadow: 0 0 10px var(--primary-glow); }
.logo-ico img { width: 100%; height: 100%; object-fit: contain; padding: 4px; }
.logo-l1 { font-family: var(--font-heading); font-size: 20px; font-weight: 800; letter-spacing: -0.5px; color: var(--text-main); }
.hdr-r { display: flex; align-items: center; gap: 12px; }
.btn-hdr { background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-main); padding: 8px 18px; border-radius: var(--radius-pill); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
.btn-hdr:hover { background: var(--glass-bg-hover); border-color: var(--glass-border-light); }
.btn-live { background: var(--primary-subtle); border-color: var(--primary); color: var(--primary); }
.btn-live:hover { background: rgba(0, 230, 118, 0.25); }

/* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
.hero { padding: 60px 24px 60px; text-align: center; max-width: 800px; margin: 0 auto; animation: fadeUp 0.6s ease; }
.hero-logo { width: 160px; height: auto; margin: 0 auto 32px; display: block; filter: drop-shadow(0 10px 30px rgba(0, 230, 118, 0.5)); animation: float 6s ease-in-out infinite; }
.eyebrow { display: inline-flex; align-items: center; gap: 8px; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--primary); font-size: 13px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; padding: 6px 16px; border-radius: var(--radius-pill); margin-bottom: 20px; backdrop-filter: blur(8px); }
.hero h1 { font-family: var(--font-heading); font-size: clamp(3rem, 7vw, 4.5rem); line-height: 1.1; margin-bottom: 24px; font-weight: 800; letter-spacing: -1.5px; }
.hero h1 em { font-style: normal; color: var(--primary); text-shadow: var(--shadow-glow); }
.hero p { color: var(--text-sec); font-size: 18px; line-height: 1.6; margin-bottom: 40px; }
.pills { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
.pill { background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-sec); padding: 8px 16px; border-radius: var(--radius-pill); font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px; backdrop-filter: blur(8px); }
.pill b { font-weight: 700; color: var(--text-main); }

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
main { max-width: 1040px; margin: 0 auto 80px; padding: 0 24px; position: relative; z-index: 10; }
.page { display: none; }
.page.active { display: block; animation: fadeUp 0.4s ease forwards; }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card { @extend .glass-panel; background: var(--glass-bg); backdrop-filter: blur(16px) saturate(180%); -webkit-backdrop-filter: blur(16px) saturate(180%); border: 1px solid var(--glass-border); box-shadow: var(--shadow-glass); border-radius: var(--radius-lg); padding: 32px; margin-bottom: 24px; }
.card-title { font-family: var(--font-heading); font-size: 24px; color: var(--text-main); margin-bottom: 8px; font-weight: 700; letter-spacing: -0.5px; }
.card-sub { font-size: 15px; color: var(--text-sec); margin-bottom: 24px; line-height: 1.5; }

/* ‚îÄ‚îÄ FORMS & INPUTS ‚îÄ‚îÄ */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.fg { display: flex; flex-direction: column; gap: 8px; text-align: left; }
.fg.full { grid-column: 1 / -1; }
label { font-size: 13px; font-weight: 600; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.5px;}
input[type=text], input[type=email], input[type=password], select, textarea { 
  width: 100%; padding: 14px 16px; border: 1px solid var(--glass-border); border-radius: var(--radius-sm); 
  font-size: 16px; font-family: var(--font-body); color: var(--text-main); background: rgba(0,0,0,0.2); transition: all 0.2s; 
}
input:focus, select:focus, textarea:focus { border-color: var(--primary); background: rgba(0,0,0,0.4); outline: none; box-shadow: 0 0 0 4px var(--primary-subtle); }
input::placeholder, textarea::placeholder { color: var(--text-tertiary); }
select option { background: #06402b; color: #fff; }

/* Terms Box */
.terms-box {
  background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: var(--radius-sm);
  padding: 16px; max-height: 200px; overflow-y: auto; font-size: 14px; color: var(--text-sec); line-height: 1.6;
}
.terms-box strong { color: var(--text-main); }
.terms-box ul { padding-left: 20px; margin: 8px 0;}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn { padding: 14px 28px; border-radius: var(--radius-pill); border: none; cursor: pointer; font-size: 16px; font-weight: 700; font-family: var(--font-body); transition: all 0.2s cubic-bezier(0.1, 0.8, 0.3, 1); display: inline-flex; align-items: center; justify-content: center; gap: 8px;}
.btn-p { background: var(--primary); color: #000; box-shadow: 0 4px 16px var(--primary-glow); }
.btn-p:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 6px 24px var(--primary-glow); }
.btn-p:active { transform: scale(0.97); }
.btn-o { background: var(--glass-bg); color: var(--text-main); border: 1px solid var(--glass-border); }
.btn-o:hover { background: var(--glass-bg-hover); border-color: var(--glass-border-light); }
.btn-d { background: var(--danger-glass); color: var(--danger); padding: 8px 16px; font-size: 14px; border: 1px solid var(--danger); border-radius: var(--radius-pill); font-weight: 600; cursor: pointer;}
.btn-d:hover { background: var(--danger); color: #fff; }
.btn-approve { background: var(--primary-subtle); color: var(--primary); border: 1px solid var(--primary); padding: 8px 16px; font-size: 14px; border-radius: var(--radius-pill); font-weight: 600; cursor: pointer; transition: all 0.2s; }
.btn-approve:hover { background: var(--primary); color: #000; }
.btn-edit { background: var(--glass-bg); color: var(--text-main); border: 1px solid var(--glass-border); padding: 8px 16px; font-size: 14px; border-radius: var(--radius-pill); font-weight: 600; cursor: pointer; }
.btn-edit:hover { background: var(--glass-bg-hover); }

/* ‚îÄ‚îÄ GATE ‚îÄ‚îÄ */
.gate-wrap { max-width: 500px; margin: 0 auto; text-align: center; }
.gate-icon { font-size: 56px; margin-bottom: 20px; filter: drop-shadow(0 0 20px rgba(255,255,255,0.2)); }
.gate-title { font-family: var(--font-heading); font-size: 32px; color: var(--text-main); margin-bottom: 12px; font-weight: 800; }
.gate-sub { color: var(--text-sec); font-size: 16px; margin-bottom: 32px; line-height: 1.5; }
.inp-wrap { position: relative; margin-bottom: 24px; }
.inp-wrap input { padding-left: 52px; padding-top: 16px; padding-bottom: 16px; font-size: 18px;}
.inp-ico { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); font-size: 20px; color: var(--primary); font-family: var(--font-mono); font-weight: bold; pointer-events: none;}
.err-box { background: var(--danger-glass); border: 1px solid var(--danger); color: #ff8a80; border-radius: var(--radius-sm); padding: 12px 16px; font-size: 14px; margin-top: 16px; display: none; text-align: left; font-weight: 500; }
.err-box.show { display: block; animation: scaleIn 0.2s ease; }

/* ‚îÄ‚îÄ BALLOT HEADER ‚îÄ‚îÄ */
.ballot-hdr { background: var(--glass-bg); backdrop-filter: blur(16px); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); padding: 24px 32px; margin-bottom: 32px; display: flex; align-items: center; gap: 24px; box-shadow: var(--shadow-glass); position: relative; overflow: hidden;}
.ballot-hdr::after { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 200px; background: linear-gradient(90deg, transparent, var(--primary-subtle)); pointer-events: none;}
.bh-av { width: 64px; height: 64px; border-radius: 50%; background: rgba(0,0,0,0.3); border: 2px solid var(--primary); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 28px; flex-shrink: 0; box-shadow: var(--shadow-glow);}
.bh-name { font-family: var(--font-heading); font-size: 24px; font-weight: 800; margin-bottom: 4px;}
.bh-meta { font-size: 14px; color: var(--primary); font-family: var(--font-mono); font-weight: 600; letter-spacing: 0.5px; }
.bh-hint { margin-left: auto; font-size: 14px; text-align: right; color: var(--text-sec); line-height: 1.5; background: rgba(0,0,0,0.2); padding: 12px 16px; border-radius: var(--radius-sm); border: 1px solid var(--glass-border); z-index: 1;}
.bh-hint b { color: var(--primary); }

/* ‚îÄ‚îÄ STICKY PROGRESS ‚îÄ‚îÄ */
.progress-container { position: sticky; top: 88px; z-index: 200; margin-bottom: 32px; }
.progress-tracker { background: rgba(2, 26, 18, 0.75); backdrop-filter: blur(24px) saturate(180%); -webkit-backdrop-filter: blur(24px) saturate(180%); border-radius: var(--radius-lg); padding: 16px 24px; display: flex; align-items: center; gap: 20px; box-shadow: var(--shadow-glass); border: 1px solid var(--glass-border);}
.pt-label { font-size: 13px; font-weight: 700; color: var(--text-sec); text-transform: uppercase; letter-spacing: 1px; }
.pt-bar-wrap { flex: 1; min-width: 140px; background: rgba(0,0,0,0.4); border-radius: var(--radius-pill); height: 8px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);}
.pt-bar { height: 100%; border-radius: var(--radius-pill); background: var(--primary); transition: width 0.4s ease; width: 0%; box-shadow: 0 0 10px var(--primary);}
.pt-count { font-size: 14px; color: var(--text-main); white-space: nowrap; font-weight: 600; font-family: var(--font-mono); background: var(--glass-bg); padding: 6px 12px; border-radius: var(--radius-sm); border: 1px solid var(--glass-border);}

/* ‚îÄ‚îÄ PHASE BANNER ‚îÄ‚îÄ */
.phase-banner { display: flex; align-items: center; gap: 16px; padding: 32px 0 16px; border-bottom: 1px solid var(--glass-border); margin-bottom: 24px;}
.ph-num { width: 36px; height: 36px; background: var(--primary-subtle); color: var(--primary); border: 1px solid var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; font-family: var(--font-heading); flex-shrink: 0; box-shadow: var(--shadow-glow);}
.ph-txt { font-size: 15px; color: var(--text-sec); }
.ph-txt b { color: var(--text-main); font-weight: 700; font-family: var(--font-heading); font-size: 20px; display: block; margin-bottom: 2px;}

/* ‚îÄ‚îÄ POSITION CARD ‚îÄ‚îÄ */
.pos-card { background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-radius: var(--radius-lg); border: 1px solid var(--glass-border); box-shadow: var(--shadow-glass); padding: 32px; margin-bottom: 32px; transition: all 0.3s ease; scroll-margin-top: 160px; }
.pos-card:hover { background: var(--glass-bg-hover); border-color: var(--glass-border-light); }
.pos-card.has-sel { border-color: var(--primary); box-shadow: 0 0 20px var(--primary-subtle); background: rgba(0, 230, 118, 0.03); }
.pos-head { margin-bottom: 24px; }
.pos-name { font-family: var(--font-heading); font-size: 22px; color: var(--text-main); display: flex; align-items: center; gap: 12px; margin-bottom: 8px; font-weight: 800; }
.pos-rule { font-size: 14px; color: var(--text-sec); font-weight: 500; display: inline-flex; align-items: center; gap: 8px;}
.auto-tag { display: inline-flex; align-items: center; background: var(--warning-glass); color: var(--warning); border: 1px solid var(--warning); border-radius: var(--radius-sm); padding: 4px 10px; font-size: 12px; font-weight: 700; letter-spacing: 0.5px;}

/* ‚îÄ‚îÄ CANDIDATE CARDS (BALLOT) ‚îÄ‚îÄ */
.cands-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 24px; }
.cand { background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: var(--radius-xl); padding: 32px 20px; cursor: pointer; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); text-align: center; position: relative; user-select: none; display: flex; flex-direction: column; align-items: center; box-shadow: var(--shadow-sm); overflow: hidden;}
.cand:hover { background: rgba(0,0,0,0.4); border-color: var(--glass-border-light); transform: translateY(-4px); }
.cand.sel { border-color: var(--primary); background: #ffffff; box-shadow: 0 8px 24px rgba(16, 185, 129, 0.15), 0 0 0 2px var(--primary) inset; transform: translateY(-4px); }
.cand-radio { position: absolute; top: 20px; right: 20px; width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--border); background: var(--surface); transition: all 0.2s; display: flex; align-items: center; justify-content: center; z-index: 2;}
.cand.sel .cand-radio { border-color: var(--primary); background: var(--primary); }
.cand.sel .cand-radio::after { content: ''; width: 12px; height: 12px; background: #fff; border-radius: 50%; animation: scaleIn 0.2s ease;}
.cav { width: 140px; height: 140px; border-radius: 50%; background-color: var(--surface-alt); color: var(--text-muted); display: flex; align-items: center; justify-content: center; font-size: 3.5rem; font-weight: 800; font-family: var(--font-heading); margin-bottom: 24px; transition: all 0.3s ease; border: 4px solid var(--surface-alt); position: relative; z-index: 1; box-shadow: var(--shadow-md); overflow: hidden; flex-shrink: 0; }
.cand:hover .cav { border-color: var(--primary-light); }
.cand.sel .cav { border-color: var(--primary); box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3); transform: scale(1.05); }
.cname { font-weight: 800; font-size: 1.25rem; color: var(--text-main); margin-bottom: 6px; font-family: var(--font-heading); line-height: 1.2; letter-spacing: -0.2px; z-index: 1;}
.cmeta { font-size: 0.9rem; color: var(--text-muted); font-weight: 600; margin-bottom: 16px; font-family: var(--font-mono); z-index: 1;}
.cbio { font-size: 0.9rem; color: var(--text-light); line-height: 1.6; padding-top: 20px; border-top: 1px solid var(--border); width: 100%; margin-top: auto; z-index: 1;}
.cand.sel .cbio { border-color: rgba(16, 185, 129, 0.2); color: var(--primary-dark); font-weight: 500;}

/* ‚îÄ‚îÄ CANDIDATE PROFILE CARDS (PUBLIC) ‚îÄ‚îÄ */
.cp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 24px; margin-bottom: 48px; }
.cp-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--radius-xl); padding: 32px 24px; box-shadow: var(--shadow-glass); display: flex; flex-direction: column; align-items: center; text-align: center; backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); transition: transform 0.2s; }
.cp-card:hover { transform: translateY(-4px); border-color: var(--glass-border-light); }
.cp-img { width: 120px; height: 120px; border-radius: 50%; background-color: rgba(0,0,0,0.3); border: 3px solid var(--primary); margin-bottom: 20px; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: 800; color: var(--text-sec); box-shadow: 0 0 20px var(--primary-glow); flex-shrink: 0;}
.cp-name { font-family: var(--font-heading); font-size: 22px; font-weight: 800; color: var(--text-main); margin-bottom: 8px; letter-spacing: -0.3px; }
.cp-meta { font-size: 14px; color: var(--text-sec); font-family: var(--font-mono); margin-bottom: 20px; }
.cp-bio { font-size: 14px; color: var(--text-main); line-height: 1.6; text-align: left; background: rgba(0,0,0,0.2); padding: 20px; border-radius: var(--radius-md); width: 100%; border: 1px solid var(--glass-border); flex-grow: 1; font-style: italic; }
.cp-section-title { font-family: var(--font-heading); font-size: 24px; font-weight: 800; color: var(--text-main); margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px solid var(--glass-border-light); }

/* ‚îÄ‚îÄ SUBMIT ZONE ‚îÄ‚îÄ */
.submit-zone { background: var(--glass-bg); backdrop-filter: blur(16px); border-radius: var(--radius-lg); padding: 48px; text-align: center; margin-top: 40px; box-shadow: var(--shadow-glass); border: 1px solid var(--glass-border); position: relative; overflow: hidden;}
.submit-zone::after { content: ''; position: absolute; left: -50px; bottom: -50px; width: 200px; height: 200px; background: radial-gradient(circle, var(--primary-subtle), transparent 70%); pointer-events: none; }
.submit-zone h3 { font-family: var(--font-heading); font-size: 28px; margin-bottom: 12px; font-weight: 800; color: var(--text-main);}
.submit-zone p { font-size: 16px; color: var(--text-sec); margin-bottom: 32px; }
.sel-summary { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: 24px 32px; margin-bottom: 40px; text-align: left; font-size: 15px; line-height: 1.6; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; position: relative; z-index: 1;}
.sel-summary b { color: var(--text-sec); font-weight: 600; display: block; font-size: 12px; text-transform: uppercase; margin-bottom: 4px; letter-spacing: 1px;}
.sel-summary div { color: var(--text-main); font-weight: 700; font-size: 16px;}
.sel-summary .miss { background: var(--danger-glass); padding: 12px; border-radius: var(--radius-sm); border: 1px solid var(--danger); }
.sel-summary .miss b, .sel-summary .miss div { color: #ff8a80; }
.btn-sub { width: 100%; max-width: 360px; font-size: 18px; padding: 18px; letter-spacing: 0.5px; position: relative; z-index: 1;}

/* ‚îÄ‚îÄ SUCCESS ‚îÄ‚îÄ */
.success-wrap { text-align: center; padding: 60px 20px; }
.s-icon { font-size: 64px; margin-bottom: 24px; animation: scaleIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: inline-flex; align-items: center; justify-content: center; background: var(--primary-subtle); border: 2px solid var(--primary); width: 120px; height: 120px; border-radius: 50%; box-shadow: var(--shadow-glow); text-shadow: none;}
.s-title { font-family: var(--font-heading); font-size: 36px; font-weight: 800; color: var(--text-main); margin-bottom: 16px; }
.s-sub { color: var(--text-sec); font-size: 18px; line-height: 1.6; max-width: 500px; margin: 0 auto 40px; }
.s-box { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: 32px; font-size: 16px; color: var(--text-main); line-height: 1.8; max-width: 540px; margin: 0 auto 40px; text-align: left; }
.s-box strong { font-family: var(--font-heading); display: block; margin-bottom: 16px; font-size: 18px; color: var(--primary);}
.s-box ul { list-style: none; padding-left: 0; }
.s-box li { margin-bottom: 12px; display: flex; align-items: flex-start; gap: 12px; color: var(--text-sec);}
.s-box li::before { content: '‚úì'; color: var(--primary); font-weight: bold; }

/* ‚îÄ‚îÄ LIVE RESULTS PAGE ‚îÄ‚îÄ */
.live-hero { background: var(--glass-bg); border-radius: var(--radius-lg); padding: 48px; margin-bottom: 32px; display: flex; align-items: center; gap: 32px; border: 1px solid var(--glass-border); box-shadow: var(--shadow-glass); backdrop-filter: blur(16px); }
.live-icon { font-size: 56px; flex-shrink: 0; filter: drop-shadow(0 0 20px rgba(255,255,255,0.2));}
.live-hero-txt { flex: 1; }
.live-hero-txt h2 { font-family: var(--font-heading); font-size: 32px; font-weight: 800; margin-bottom: 12px; }
.live-hero-txt p { font-size: 16px; color: var(--text-sec); line-height: 1.6; max-width: 500px; }
.live-meta { text-align: right; background: rgba(0,0,0,0.3); padding: 24px 32px; border-radius: var(--radius-md); border: 1px solid var(--glass-border);}
.lm-voted { font-family: var(--font-heading); font-size: 48px; font-weight: 800; line-height: 1; color: var(--primary); margin-bottom: 8px; text-shadow: var(--shadow-glow); }
.lm-label { font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-main); }
.lm-pct { font-size: 14px; color: var(--text-sec); font-family: var(--font-mono); margin-top: 6px;}

.live-refresh { display: flex; align-items: center; gap: 16px; margin-bottom: 40px; flex-wrap: wrap; }
.refresh-badge { display: flex; align-items: center; gap: 10px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--radius-pill); padding: 10px 20px; font-size: 14px; font-weight: 600; backdrop-filter: blur(8px); }
.refresh-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--primary); animation: blink 1.4s infinite; box-shadow: 0 0 10px var(--primary);}
.btn-refresh-now { background: var(--glass-bg); color: var(--text-main); border: 1px solid var(--glass-border); border-radius: var(--radius-pill); padding: 10px 24px; font-size: 14px; font-weight: 600; font-family: var(--font-body); cursor: pointer; transition: all 0.2s; box-shadow: var(--shadow-sm);}
.btn-refresh-now:hover { background: var(--glass-bg-hover); border-color: var(--glass-border-light); color: var(--primary);}

.live-overall { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 48px; }
.ov-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: 32px 24px; text-align: center; box-shadow: var(--shadow-glass); backdrop-filter: blur(8px);}
.ov-n { font-family: var(--font-heading); font-size: 40px; color: var(--text-main); line-height: 1; font-weight: 800; margin-bottom: 12px; text-shadow: 0 2px 10px rgba(0,0,0,0.5);}
.ov-l { font-size: 14px; color: var(--primary); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

.live-pos-card { background: var(--glass-bg); border-radius: var(--radius-lg); border: 1px solid var(--glass-border); box-shadow: var(--shadow-glass); padding: 40px; margin-bottom: 32px; backdrop-filter: blur(16px); }
.lpc-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; margin-bottom: 32px; flex-wrap: wrap; border-bottom: 1px solid var(--glass-border-light); padding-bottom: 20px; }
.lpc-name { font-family: var(--font-heading); font-size: 24px; color: var(--text-main); font-weight: 800; display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
.lpc-total { font-size: 15px; color: var(--text-sec); font-weight: 500; font-family: var(--font-mono); }

.live-cand-row { display: flex; align-items: center; gap: 24px; margin-bottom: 16px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: var(--radius-md); border: 1px solid transparent; transition: all 0.3s; }
.live-cand-row.leading { background: rgba(0, 230, 118, 0.05); border: 1px solid var(--primary); box-shadow: inset 0 0 20px rgba(0,230,118,0.1); }
.lcr-rank { width: 48px; height: 48px; border-radius: 50%; background: rgba(0,0,0,0.5); color: var(--text-sec); display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 800; font-family: var(--font-heading); flex-shrink: 0; border: 1px solid var(--glass-border);}
.lcr-avatar { width: 64px; height: 64px; border-radius: 50%; background-color: rgba(0,0,0,0.5); color: var(--text-sec); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 800; flex-shrink: 0; overflow: hidden; border: 2px solid var(--glass-border); }
.live-cand-row.leading .lcr-rank { background: var(--primary-subtle); color: var(--primary); border-color: var(--primary); box-shadow: var(--shadow-glow);}
.live-cand-row.leading .lcr-avatar { border-color: var(--primary); box-shadow: var(--shadow-glow); color: var(--primary);}
.lcr-info { flex: 1; min-width: 0; }
.lcr-name { font-weight: 800; font-size: 20px; color: var(--text-main); display: flex; align-items: center; gap: 12px; margin-bottom: 6px; font-family: var(--font-heading); }
.lcr-meta { font-size: 14px; color: var(--text-sec); font-family: var(--font-mono);}
.lcr-bar-wrap { background: rgba(0,0,0,0.5); border-radius: var(--radius-pill); height: 10px; overflow: hidden; margin-top: 12px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);}
.lcr-bar { height: 100%; border-radius: var(--radius-pill); background: var(--text-tertiary); transition: width 1s cubic-bezier(0.22, 1, 0.36, 1); }
.live-cand-row.leading .lcr-bar { background: var(--primary); box-shadow: 0 0 10px var(--primary);}
.lcr-pct { font-size: 28px; font-weight: 800; color: var(--text-main); white-space: nowrap; text-align: right; font-family: var(--font-heading); }
.live-cand-row.leading .lcr-pct { color: var(--primary); text-shadow: 0 0 10px var(--primary-glow);}
.lcr-votes { font-size: 14px; color: var(--text-sec); text-align: right; font-weight: 600; margin-top: 4px; }
.runner-assign { background: var(--warning-glass); border: 1px solid var(--warning); border-radius: var(--radius-sm); padding: 16px 20px; margin-top: 24px; font-size: 14px; color: #FFD600; display: flex; gap: 12px; align-items: flex-start; box-shadow: var(--shadow-sm);}

/* ‚îÄ‚îÄ SEGMENTED CONTROL (GLASS) ‚îÄ‚îÄ */
.atabs { display: flex; background: rgba(0,0,0,0.3); padding: 4px; border-radius: var(--radius-pill); margin-bottom: 32px; border: 1px solid var(--glass-border);}
.atab { flex: 1; padding: 12px 24px; border-radius: var(--radius-pill); border: none; cursor: pointer; font-size: 15px; font-weight: 600; font-family: var(--font-body); transition: all 0.3s; background: transparent; color: var(--text-sec); text-align: center; }
.atab.active { background: var(--primary); color: #000; box-shadow: 0 4px 12px var(--primary-glow); }
.atab:hover:not(.active) { color: var(--text-main); background: rgba(255,255,255,0.05);}

/* TABLES */
.twrap { overflow-x: auto; border-radius: var(--radius-md); background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border);}
table { width: 100%; border-collapse: collapse; font-size: 15px; text-align: left;}
thead { background: rgba(0,0,0,0.4); border-bottom: 1px solid var(--glass-border-light); }
thead th { padding: 16px 20px; font-weight: 700; color: var(--primary); font-size: 13px; text-transform: uppercase; letter-spacing: 1px;}
tbody tr { border-bottom: 1px solid var(--glass-border); transition: background 0.2s;}
tbody tr:hover { background: rgba(255,255,255,0.05); }
tbody td { padding: 16px 20px; color: var(--text-main); vertical-align: middle; }
.badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; letter-spacing: 0.5px; }
.bg { background: var(--primary-subtle); color: var(--primary); border: 1px solid var(--primary); }
.bo { background: var(--warning-glass); color: var(--warning); border: 1px solid var(--warning);}

/* ‚îÄ‚îÄ ADMIN SPECIFIC ‚îÄ‚îÄ */
.admin-hdr-bar { background: var(--glass-bg); backdrop-filter: blur(16px); border-radius: var(--radius-lg); padding: 32px 40px; margin-bottom: 40px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 24px; box-shadow: var(--shadow-glass); border: 1px solid var(--glass-border);}
.admin-hdr-bar h2 { font-family: var(--font-heading); font-size: 28px; font-weight: 800; margin-bottom: 8px; }
.admin-hdr-bar p { color: var(--text-sec); font-size: 16px; }
.toggle-wrap { display: flex; align-items: center; gap: 12px; font-weight: 600; font-size: 15px; color: var(--text-main);}

/* Toggle Switch */
.toggle { position: relative; width: 56px; height: 32px; cursor: pointer; }
.toggle input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; inset: 0; background: rgba(255,255,255,0.2); border-radius: 32px; transition: 0.3s; border: 1px solid var(--glass-border);}
.slider::before { content: ''; position: absolute; height: 26px; width: 26px; left: 2px; bottom: 2px; background: #fff; border-radius: 50%; transition: 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.3);}
input:checked + .slider { background: var(--primary); border-color: var(--primary);}
input:checked + .slider::before { transform: translateX(24px); }

/* TOAST */
#toast { position: fixed; bottom: 32px; right: 32px; background: rgba(2, 26, 18, 0.9); backdrop-filter: blur(20px); border: 1px solid var(--primary); color: #fff; padding: 16px 24px; border-radius: var(--radius-pill); font-size: 15px; font-weight: 600; box-shadow: 0 10px 40px rgba(0,230,118,0.2); z-index: 9999; transform: translateY(100px); opacity: 0; transition: all 0.4s cubic-bezier(0.1, 0.8, 0.3, 1); display: flex; align-items: center; gap: 12px; }
#toast.show { transform: translateY(0); opacity: 1; }
#toast.err { background: rgba(60, 0, 0, 0.9); border-color: var(--danger); box-shadow: 0 10px 40px rgba(255, 59, 48, 0.2); }

.empty { text-align: center; padding: 80px 20px; color: var(--text-sec); }
.empty .ei { font-size: 64px; margin-bottom: 20px; filter: drop-shadow(0 0 20px rgba(255,255,255,0.1)); }

footer { color: var(--text-sec); text-align: center; padding: 40px 20px; font-size: 14px; border-top: 1px solid var(--glass-border); position: relative; z-index: 10; margin-top: 60px;}
footer strong { color: var(--text-main); font-weight: 700; font-family: var(--font-heading); letter-spacing: 1px;}

/* ‚îÄ‚îÄ RESPONSIVE DESIGN ‚îÄ‚îÄ */
@media(max-width: 768px) {
  .hdr { padding: 0 16px; height: 64px; }
  main { padding: 24px 16px 60px; }
  .hero { padding: 40px 16px 24px; }
  .hero h1 { font-size: 2.2rem; }
  
  .card, .pos-card, .submit-zone, .live-hero, .live-pos-card, .admin-hdr-bar { 
    padding: 24px 20px; border-radius: var(--radius-md); margin-bottom: 20px;
  }
  
  .ballot-hdr { flex-direction: column; text-align: center; }
  .bh-hint { text-align: center; margin-left: 0; width: 100%; margin-top: 12px; }
  
  .progress-container { top: 70px; margin-bottom: 20px;} 
  .progress-tracker { flex-direction: column; align-items: stretch; padding: 16px; gap: 12px; }
  .pt-label, .pt-count { text-align: center; }
  
  .cands-grid, .cp-grid { grid-template-columns: 1fr; gap: 16px; }
  .cand { padding: 24px 16px; }
  .cav { width: 90px; height: 90px; font-size: 28px; margin-bottom: 16px;}
  
  .live-hero { flex-direction: column; text-align: center; gap: 20px; }
  .live-meta { text-align: center; width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); padding: 16px;}
  .lm-voted { font-size: 40px; }
  .live-overall { grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px; }
  .ov-card { padding: 20px 12px; }
  .ov-n { font-size: 32px; }
  
  .live-cand-row { flex-direction: column; align-items: center; gap: 16px; text-align: center; padding: 20px 16px; }
  .live-cand-row > div:last-child { text-align: center; width: 100%; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); padding: 12px 16px; border-radius: var(--radius-sm); margin-top: 8px;}
  
  .admin-hdr-bar { flex-direction: column; text-align: center; gap: 20px; }
  .toggle-wrap { justify-content: space-between; width: 100%; padding: 12px 0; border-bottom: 1px solid var(--glass-border); }
  .toggle-wrap:last-of-type { border-bottom: none; }
  .btn-logout { width: 100%; margin-top: 8px; }
  
  .form-grid { grid-template-columns: 1fr; gap: 16px; }
  
  #toast { left: 16px; right: 16px; bottom: 20px; justify-content: center; text-align: center; border-radius: var(--radius-md);}
}
</style>

<!-- Add Supabase JS Client Library -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- INITIAL LOADING OVERLAY -->
<div id="loading-overlay">
  <div class="spinner"></div>
  <div style="font-family: var(--font-heading); font-size: 1.25rem; color: var(--text-main); font-weight: 800; text-shadow: var(--shadow-glow);">Initializing Terminal...</div>
  <div style="color: var(--primary); font-size: 0.9rem; margin-top: 8px; font-family: var(--font-mono);">Connecting to ESRC Database_</div>
</div>

<!-- STATUS BAR -->
<div id="status-bar">
  <span class="sdot"></span>
  <span id="status-text">Connecting...</span>
</div>

<!-- HEADER -->
<header>
  <div class="hdr">
    <div class="logo" onclick="showPage('voter')">
      <div class="logo-ico">
        <img src="https://raw.githubusercontent.com/SadatPro/img/refs/heads/main/esrc_logo.png" alt="ESRC">
      </div>
      <div class="logo-l1">ESRC Portal</div>
    </div>
    <div class="hdr-r">
      <button class="btn-hdr" onclick="showPage('candidates-list')">Candidates</button>
      <button class="btn-hdr" onclick="showPage('register')">Register</button>
      <button class="btn-hdr btn-live" onclick="showPage('live')">Results</button>
      <button class="btn-hdr" onclick="showPage('admin')">Admin</button>
    </div>
  </div>
</header>

<!-- HERO -->
<div class="hero" id="hero-section">
  <div class="hero-inner">
    <img src="https://raw.githubusercontent.com/SadatPro/img/refs/heads/main/esrc_logo.png" alt="ESRC Logo" class="hero-logo">
    <div class="eyebrow">Elections 2026‚Äì2027</div>
    <h1>ESRC Committee <br><em>Elections</em></h1>
    <p>Participate in shaping the future of the Embedded System Research Center. Vote securely or register your candidacy for the upcoming term.</p>
    <div class="pills">
      <div class="pill">üßë‚Äçüíª <b id="total-pill">0</b> Voters</div>
      <div class="pill">üéõÔ∏è <b>10</b> Positions</div>
      <div class="pill">‚ö° <b>8</b> Auto-Roles</div>
    </div>
  </div>
</div>

<!-- MAIN -->
<main>

<!-- ‚ïê‚ïê VOTER PAGE ‚ïê‚ïê -->
<div id="page-voter" class="page active">

  <div class="card gate-wrap" id="voter-gate">
    <div class="gate-icon">üó≥Ô∏è</div>
    <div class="gate-title">Access Ballot</div>
    <div class="gate-sub">Enter your Student ID exactly as registered. You will vote for <strong>all positions</strong> in one single secure session.</div>
    <div class="inp-wrap">
      <span class="inp-ico">&gt;_</span>
      <input type="text" id="voter-id-input" placeholder="e.g. 241-15-519" onkeydown="if(event.key==='Enter')verifyVoter()"/>
    </div>
    <button class="btn btn-p" style="width: 100%;" onclick="verifyVoter()" id="btn-verify">
      Continue
    </button>
    <div class="err-box" id="gate-err"></div>
  </div>

  <div id="ballot-section" style="display:none">
    <div class="ballot-hdr">
      <div class="bh-av">üßë‚Äçüíª</div>
      <div style="flex:1">
        <div class="bh-name" id="bh-name"></div>
        <div class="bh-meta" id="bh-meta"></div>
      </div>
      <div class="bh-hint">Select <b>one</b> candidate per position.<br>Runner-ups are auto-assigned.</div>
    </div>

    <!-- Sticky Progress Tracker -->
    <div class="progress-container">
      <div class="progress-tracker">
        <span class="pt-label">Progress</span>
        <div class="pt-bar-wrap"><div class="pt-bar" id="pt-bar"></div></div>
        <span class="pt-count" id="pt-count">0 / 0</span>
      </div>
    </div>

    <div id="ballot-body"></div>

    <div class="submit-zone">
      <h3>Review &amp; Submit</h3>
      <p>Please review your choices below. Once submitted, your vote is final.</p>
      <div class="sel-summary" id="sel-summary"></div>
      <button class="btn btn-p btn-sub" id="btn-submit" onclick="submitVote()">
        Submit Ballot
      </button>
    </div>
  </div>

  <div class="card" id="success-section" style="display:none">
    <div class="success-wrap">
      <div class="s-icon">üöÄ</div>
      <div class="s-title">Submitted</div>
      <p class="s-sub">Thank you, <strong id="success-name"></strong>. Your cryptographic ballot for the ESRC Committee Elections has been recorded.</p>
      <div class="s-box">
        <strong>üìã Post-Election Protocol:</strong>
        <ul>
          <li>Your votes instantly update the live tallies.</li>
          <li>President runner-up inherits VP-1.</li>
          <li>General Secretary runner-up inherits AGS-1.</li>
          <li>Executive runner-ups inherit Assistant roles.</li>
        </ul>
      </div>
      <button class="btn btn-o" onclick="location.reload()">Return Home</button>
    </div>
  </div>

</div>

<!-- ‚ïê‚ïê CANDIDATES LIST PAGE ‚ïê‚ïê -->
<div id="page-candidates-list" class="page">
  <div class="live-hero" style="margin-bottom: 40px;">
    <div class="live-icon">üßë‚Äçüíª</div>
    <div class="live-hero-txt">
      <h2>Meet the Candidates</h2>
      <p>Explore the profiles and manifestos of all approved candidates running for the ESRC Committee Elections 2026‚Äì2027.</p>
    </div>
  </div>
  <div id="candidates-list-body"></div>
</div>

<!-- ‚ïê‚ïê PUBLIC REGISTRATION PAGE ‚ïê‚ïê -->
<div id="page-register" class="page">
  <div class="card gate-wrap" style="max-width: 640px;" id="reg-wrapper">
    <div class="gate-icon">üìù</div>
    <div class="gate-title">Registration</div>
    <div class="gate-sub">Register yourself as a voter or apply as a candidate. All submissions require admin approval.</div>
    
    <div class="atabs" style="margin-bottom: 32px;">
      <button class="atab active" onclick="switchRegTab('voter', this)">Voter</button>
      <button class="atab" onclick="switchRegTab('candidate', this)">Candidate</button>
    </div>

    <!-- PUBLIC VOTER FORM -->
    <div id="reg-voter-form" style="text-align: left;">
      <div class="form-grid">
        <div class="fg"><label>Full Name</label><input type="text" id="pub-nv-name" placeholder="John Doe"/></div>
        <div class="fg"><label>Student ID</label><input type="text" id="pub-nv-sid" placeholder="e.g. 241-15-519"/></div>
        <div class="fg"><label>Email</label><input type="email" id="pub-nv-email" placeholder="name@diu.edu.bd"/></div>
        <div class="fg"><label>Department</label><input type="text" id="pub-nv-dept" placeholder="e.g. CSE"/></div>
        <div class="fg"><label>Batch</label><input type="text" id="pub-nv-batch" placeholder="e.g. Batch 65"/></div>
      </div>
      <div style="margin-top: 32px;">
        <button class="btn btn-p" style="width: 100%;" id="btn-pub-add-voter" onclick="submitPublicVoter()">Submit Registration</button>
      </div>
    </div>

    <!-- PUBLIC CANDIDATE FORM -->
    <div id="reg-cand-form" style="display:none; text-align: left;">
      <div class="form-grid">
        <div class="fg"><label>Full Name</label><input type="text" id="pub-nc-name" placeholder="Candidate Name"/></div>
        <div class="fg"><label>Student ID</label><input type="text" id="pub-nc-sid" placeholder="e.g. 241-15-519"/></div>
        <div class="fg"><label>Target Position</label>
          <select id="pub-nc-pos">
            <option value="">‚Äî Select Target Position ‚Äî</option>
            <optgroup label="Phase 1 ¬∑ Leadership">
              <option value="President">President</option>
              <option value="Vice President - 2">Vice President - 2</option>
              <option value="General Secretary">General Secretary</option>
              <option value="Assistant General Secretary - 2">Assistant General Secretary - 2</option>
            </optgroup>
            <optgroup label="Phase 2 ¬∑ Executive Council">
              <option value="Treasurer">Treasurer</option>
              <option value="Women's Secretary">Women's Secretary</option>
              <option value="Media Secretary">Media Secretary</option>
              <option value="Office Secretary">Office Secretary</option>
              <option value="Organizing Secretary">Organizing Secretary</option>
              <option value="Press Secretary">Press Secretary</option>
            </optgroup>
          </select>
        </div>
        <div class="fg"><label>Department</label><input type="text" id="pub-nc-dept" placeholder="e.g. CSE"/></div>
        <div class="fg"><label>Batch</label><input type="text" id="pub-nc-batch" placeholder="e.g. Batch 65"/></div>
        <div class="fg"><label>Image URL</label><input type="text" id="pub-nc-image" placeholder="https://example.com/image.jpg"/></div>
        
        <div class="fg full" style="margin-top: 8px;">
          <label>Payment Details *</label>
          <div style="background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); padding: 16px; margin-bottom: 8px;">
            <div style="font-size: 14px; color: var(--text-sec); margin-bottom: 12px; font-weight: 500;">Please send the registration fee to one of the following numbers:</div>
            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
              <div style="display: flex; align-items: center; gap: 8px; background: rgba(226, 19, 110, 0.15); border: 1px solid rgba(226, 19, 110, 0.3); padding: 8px 16px; border-radius: 8px; color: #fff; font-size: 15px;">
                <span style="font-weight: 800; color: #e2136e; letter-spacing: 0.5px;">bKash:</span> <span style="font-family: var(--font-mono); font-weight: 600; letter-spacing: 1px;">01645479277</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px; background: rgba(247, 102, 34, 0.15); border: 1px solid rgba(247, 102, 34, 0.3); padding: 8px 16px; border-radius: 8px; color: #fff; font-size: 15px;">
                <span style="font-weight: 800; color: #f76622; letter-spacing: 0.5px;">Nagad:</span> <span style="font-family: var(--font-mono); font-weight: 600; letter-spacing: 1px;">01309250507</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="fg"><label>Payment Number (send moeny)</label><input type="text" id="pub-nc-pay" placeholder="e.g. 01XXXXXXXXX"/></div>
        <div class="fg"><label>Transaction ID</label><input type="text" id="pub-nc-trx" placeholder="Enter TXN ID..."/></div>
        
        <div class="fg full">
          <label>Terms & Conditions</label>
          <div class="terms-box">
            <strong>‡ßß. ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø‡¶§‡¶æ ‡¶ì ‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ</strong><br>
            ‡¶ï‡¶Æ‡¶ø‡¶ü‡¶ø‡¶∞ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶¶‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶ï‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ESRC-‡¶è‡¶∞ ‡¶è‡¶ï‡¶ú‡¶® ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§<br><br>
            <strong>‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶∂‡¶∞‡ßç‡¶§ (Mandatory Prerequisite):</strong><br>
            ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶™‡¶¶‡ßá‡¶∞ ‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø‡¶§‡¶æ: ‡¶™‡ßç‡¶∞‡ßá‡¶∏‡¶ø‡¶°‡ßá‡¶®‡ßç‡¶ü, ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶≤ ‡¶∏‡ßá‡¶ï‡ßç‡¶∞‡ßá‡¶ü‡¶æ‡¶∞‡¶ø, ‡¶≠‡¶æ‡¶á‡¶∏ ‡¶™‡ßç‡¶∞‡ßá‡¶∏‡¶ø‡¶°‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶ø‡¶Ç‡¶¨‡¶æ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶ï‡ßÄ‡¶Ø‡¶º (Secretariat) ‡¶™‡¶¶‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶ï‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá ‡¶è‡¶ï‡ßç‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶ü‡¶ø‡¶≠ ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ (Executive Member) ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶¶‡¶æ‡¶Ø‡¶º‡¶ø‡¶§‡ßç‡¶¨ ‡¶™‡¶æ‡¶≤‡¶®‡ßá‡¶∞ ‡¶Ö‡¶≠‡¶ø‡¶ú‡ßç‡¶û‡¶§‡¶æ ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§ ‡¶Ö‡¶∞‡ßç‡¶•‡¶æ‡ßé, ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶∂‡ßÄ‡¶∞‡ßç‡¶∑ ‡¶™‡¶¶‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ; ‡¶ß‡¶æ‡¶™‡ßá ‡¶ß‡¶æ‡¶™‡ßá ‡¶™‡¶¶‡ßã‡¶®‡ßç‡¶®‡¶§‡¶ø ‡¶™‡ßá‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§<br><br>
            <strong>‡¶™‡ßç‡¶∞‡ßá‡¶∏‡¶ø‡¶°‡ßá‡¶®‡ßç‡¶ü ‡¶ì ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶≤ ‡¶∏‡ßá‡¶ï‡ßç‡¶∞‡ßá‡¶ü‡¶æ‡¶∞‡¶ø ‡¶™‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø‡¶§‡¶æ:</strong><br>
            ‡ßß. ‡¶Ö‡¶≠‡¶ø‡¶ú‡ßç‡¶û‡¶§‡¶æ: ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡ßß ‡¶•‡ßá‡¶ï‡ßá ‡ß® ‡¶¨‡¶õ‡¶∞‡ßá‡¶∞ ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶Ö‡¶≠‡¶ø‡¶ú‡ßç‡¶û‡¶§‡¶æ ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§<br>
            ‡ß®. ‡¶Ö‡¶§‡ßÄ‡¶§ ‡¶Ö‡¶¨‡¶¶‡¶æ‡¶®: ESRC-‡¶è‡¶∞ ‡¶¨‡¶ø‡¶ó‡¶§ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶ì ‡¶â‡¶®‡ßç‡¶®‡¶§‡¶ø‡¶§‡ßá ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶ï‡ßç‡¶∑ ‡¶Ö‡¶¨‡¶¶‡¶æ‡¶® ‡¶¨‡¶æ "Contributing Past" ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§<br>
            ‡ß©. ‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶´‡ßã‡¶≤‡¶ø‡¶ì ‡¶ì ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü: ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶ï‡ßá ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß®‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶¶‡¶∞‡ßç‡¶∂‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§ ‡¶Ö‡¶•‡¶¨‡¶æ, ‡¶®‡¶ø‡¶Æ‡ßç‡¶®‡¶≤‡¶ø‡¶ñ‡¶ø‡¶§ ‡¶ï‡ßç‡¶∑‡ßá‡¶§‡ßç‡¶∞‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶ï‡¶ü‡¶ø‡¶§‡ßá ‡¶Ö‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶¶‡¶ï‡ßç‡¶∑‡¶§‡¶æ (Exceptional Skill) ‡¶™‡ßç‡¶∞‡¶Æ‡¶æ‡¶£ ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá:<br>
            <ul>
              <li>‡ß©‡¶°‡¶ø ‡¶ï‡ßç‡¶Ø‡¶æ‡¶° ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® (3D CAD)</li>
              <li>‡¶∏‡¶æ‡¶∞‡ßç‡¶ï‡¶ø‡¶ü ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶®‡¶ø‡¶Ç (Circuit Designing)</li>
              <li>‡¶ó‡ßç‡¶∞‡¶æ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶®‡¶ø‡¶Ç (Graphics Designing)</li>
              <li>‡¶∏‡¶ø ‡¶™‡ßç‡¶∞‡ßã‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡¶ø‡¶Ç-‡¶è ‡¶≠‡¶æ‡¶≤‡ßã ‡¶¶‡¶ñ‡¶≤ (Good knowledge in C Programming)</li>
              <li>‡¶ì‡¶Ø‡¶º‡ßá‡¶¨ ‡¶°‡ßá‡¶≠‡ßá‡¶≤‡¶™‡¶Æ‡ßá‡¶®‡ßç‡¶ü (Web Development)</li>
              <li>‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶è‡¶®‡ßç‡¶° ‡¶ü‡ßá‡¶ï‡¶®‡ßã‡¶≤‡¶ú‡¶ø (Backend Technology)</li>
              <li>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶°‡ßá‡¶≠‡ßá‡¶≤‡¶™‡¶Æ‡ßá‡¶®‡ßç‡¶ü (Mobile App Development)</li>
            </ul>
          </div>
          <label style="display: flex; gap: 12px; align-items: start; margin-top: 16px; cursor: pointer; text-transform: none; font-weight: normal; color: var(--text-main);">
            <input type="checkbox" id="pub-nc-terms" style="width: auto; margin-top: 2px; accent-color: var(--primary);" />
            <span style="font-size: 15px; line-height: 1.4;">‡¶Ü‡¶Æ‡¶ø ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ ‡¶™‡ßú‡ßá‡¶õ‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßá‡¶®‡ßá ‡¶®‡¶ø‡¶ö‡ßç‡¶õ‡¶ø‡•§ (I have read and agree to the terms and conditions)</span>
          </label>
        </div>
        
        <div class="fg full"><label>Campaign Bio</label><textarea id="pub-nc-bio" placeholder="Short manifesto or vision statement..."></textarea></div>
      </div>
      <div style="margin-top: 32px;">
        <button class="btn btn-p" style="width: 100%;" id="btn-pub-add-cand" onclick="submitPublicCandidate()">Submit Application</button>
      </div>
    </div>

  </div>
  
  <div class="card" id="reg-closed-msg" style="display: none; max-width: 600px; margin: 0 auto; text-align: center;">
    <div class="ei" style="font-size: 64px; margin-bottom: 24px;">üõë</div>
    <h3 style="font-size: 28px; font-weight: 800; margin-bottom: 12px;">Registration Closed</h3>
    <p style="color: var(--text-sec); font-size: 16px;">The public registration window is currently closed. If you believe this is an error, please contact the election administrator.</p>
  </div>
</div>

<!-- ‚ïê‚ïê LIVE RESULTS PAGE ‚ïê‚ïê -->
<div id="page-live" class="page">

  <div class="live-hero">
    <div class="live-icon">üì°</div>
    <div class="live-hero-txt">
      <h2>Live Results Dashboard</h2>
      <p>Real-time vote counting for all positions. Percentages represent the share of total votes cast for that specific role.</p>
    </div>
    <div class="live-meta">
      <div class="lm-voted" id="lv-voted">0</div>
      <div class="lm-label">Total Votes Cast</div>
      <div class="lm-pct" id="lv-pct">of 0 registered</div>
    </div>
  </div>

  <div class="live-refresh">
    <div class="refresh-badge">
      <span class="refresh-dot"></span>
      Updating in <span style="font-weight:700; color:var(--primary); margin:0 6px;" id="lv-countdown">10</span>s
    </div>
    <button class="btn btn-o btn-refresh-now" onclick="renderLive()" id="btn-refresh">Refresh Now</button>
    <div style="margin-left:auto;font-size:13px;color:var(--text-sec);" id="lv-lastupdate">‚Äî</div>
  </div>

  <div class="live-overall" id="lv-overall"></div>
  <div id="lv-body"></div>

</div>

<!-- ‚ïê‚ïê ADMIN PAGE ‚ïê‚ïê -->
<div id="page-admin" class="page">

  <div id="admin-gate" class="gate-wrap" style="padding-top: 40px;">
    <div class="card">
      <div class="card-title" style="margin-bottom: 32px; text-align: center; font-size: 28px;">üõ°Ô∏è Admin Auth</div>
      <div class="fg" style="margin-bottom:32px">
        <label>Master Password</label>
        <input type="password" id="admin-pass" placeholder="Enter password..." onkeydown="if(event.key==='Enter')adminLogin()"/>
      </div>
      <button class="btn btn-p" style="width: 100%;" onclick="adminLogin()" id="btn-admin-login">Log In</button>
      <div class="err-box" id="admin-err"></div>
    </div>
  </div>

  <div id="admin-panel" style="display:none">
    <div class="admin-hdr-bar">
      <div>
        <h2>Control Center</h2>
        <p>Manage voters, candidates, and system metrics.</p>
      </div>
      <div style="display:flex;align-items:center;gap:32px;flex-wrap:wrap">
        <div class="toggle-wrap">
          <span id="reg-lbl">Open Registration</span>
          <label class="toggle"><input type="checkbox" id="reg-toggle" onchange="toggleRegistration()"/><span class="slider"></span></label>
        </div>
        <div class="toggle-wrap">
          <span id="elec-lbl">Accepting Votes</span>
          <label class="toggle"><input type="checkbox" id="elec-toggle" onchange="toggleElection()"/><span class="slider"></span></label>
        </div>
        <div class="toggle-wrap">
          <span id="live-lbl">Public Results</span>
          <label class="toggle"><input type="checkbox" id="live-toggle" onchange="toggleLive()"/><span class="slider"></span></label>
        </div>
        <button class="btn-d" onclick="adminLogout()">Sign Out</button>
      </div>
    </div>

    <div class="atabs">
      <button class="atab active" onclick="switchATab('voters',this)">Voters (<span id="atab-vc">0</span>)</button>
      <button class="atab" onclick="switchATab('candidates',this)">Candidates</button>
      <button class="atab" onclick="switchATab('results',this)">Reports</button>
    </div>

    <!-- VOTERS -->
    <div id="atab-voters">
      <div class="card" style="display: none;">
        <div class="card-title">Add Voter Manually</div>
        <div class="card-sub">Register members who were missed in the initial import.</div>
        <div class="form-grid">
          <div class="fg"><label>Full Name</label><input type="text" id="nv-name" placeholder="John Doe"/></div>
          <div class="fg"><label>Student ID</label><input type="text" id="nv-sid" placeholder="e.g. 241-15-519"/></div>
          <div class="fg"><label>Email</label><input type="email" id="nv-email" placeholder="name@diu.edu.bd"/></div>
          <div class="fg"><label>Department</label><input type="text" id="nv-dept" placeholder="e.g. CSE"/></div>
          <div class="fg"><label>Batch</label><input type="text" id="nv-batch" placeholder="e.g. Batch 65"/></div>
        </div>
        <div style="margin-top: 24px;"><button class="btn btn-p" id="btn-add-voter" onclick="addVoter()">Add Voter</button></div>
      </div>
      
      <div class="card">
        <div class="card-title">Voter Directory</div>
        <div class="card-sub" id="voter-count-lbl">‚Äî</div>
        <div style="display:flex; gap:16px; margin-bottom: 24px; flex-wrap: wrap;">
          <input type="text" placeholder="Search by name, ID or department‚Ä¶" oninput="filterVoters(this.value)" style="flex:1; min-width: 200px;"/>
          <button class="btn btn-o" onclick="renderVoterTable()">Refresh</button>
        </div>
        <div class="twrap">
          <table>
            <thead><tr><th>#</th><th>Name</th><th>Student ID</th><th>Dept</th><th>Status</th><th>Approval</th><th>Action</th></tr></thead>
            <tbody id="voter-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- CANDIDATES -->
    <div id="atab-candidates" style="display:none">
      <div class="card">
        <div class="card-title">Candidate Directory</div>
        <div class="card-sub">Review, approve, and manage registered candidates.</div>
        <div class="twrap" style="margin-top:24px;">
          <table>
            <thead><tr><th>#</th><th>Name</th><th>Position</th><th>Dept</th><th>Payment Info</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="cand-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="atab-results" style="display:none">
      <div class="live-overall">
        <div class="ov-card"><div class="ov-n" id="r-total">‚Äî</div><div class="ov-l">Voters</div></div>
        <div class="ov-card"><div class="ov-n" id="r-voted">‚Äî</div><div class="ov-l">Cast</div></div>
        <div class="ov-card"><div class="ov-n" id="r-pct">‚Äî</div><div class="ov-l">Turnout</div></div>
        <div class="ov-card"><div class="ov-n" id="r-pos">‚Äî</div><div class="ov-l">Direct</div></div>
        <div class="ov-card"><div class="ov-n" id="r-auto">8</div><div class="ov-l">Auto</div></div>
      </div>
      <div class="card">
        <div class="card-title">Final Report</div>
        <div class="card-sub">Detailed breakdown of winners and automatically assigned runner-ups.</div>
        <div id="results-body"><div class="empty"><div class="ei">üì≠</div><p>Awaiting votes...</p></div></div>
      </div>
    </div>

  </div>
</div>

</main>

<div id="toast"></div>

<footer>
  <strong>ESRC</strong> ‚Äî Embedded System Research Center<br>
  <span style="font-size: 13px; margin-top: 8px; display: block;">2026‚Äì2027 Secure Election Portal</span>
</footer>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE INITIALIZATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL = 'https://pxqruwscthmedqmnaruz.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_58wOpVLaXUajnX0fUdtWPQ_ByhqfzXd';
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA & STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const POSITIONS = [
  { id:'president', name:'President', phase:1, batchNote:'Batch 61‚Äì63', runnerUpRole:'Vice President - 1' },
  { id:'vp2', name:'Vice President - 2', phase:1, batchNote:'Batch 64‚Äì65', runnerUpRole:null },
  { id:'gs', name:'General Secretary', phase:1, batchNote:'Batch 63‚Äì64', runnerUpRole:'Assistant General Secretary - 1' },
  { id:'ags2', name:'Assistant General Secretary - 2', phase:1, batchNote:'Batch 66+', runnerUpRole:null },
  { id:'treasurer', name:'Treasurer', phase:2, batchNote:'Batch 63‚Äì67', runnerUpRole:'Assistant Treasurer' },
  { id:'womens', name:"Women's Secretary", phase:2, batchNote:'Batch 63‚Äì67', runnerUpRole:"Joint Women's Secretary" },
  { id:'media', name:'Media Secretary', phase:2, batchNote:'Batch 63‚Äì67', runnerUpRole:'Assistant Media Secretary' },
  { id:'office', name:'Office Secretary', phase:2, batchNote:'Batch 63‚Äì67', runnerUpRole:'Assistant Office Secretary' },
  { id:'organizing', name:'Organizing Secretary', phase:2, batchNote:'Batch 63‚Äì67', runnerUpRole:'Assistant Organizing Secretary' },
  { id:'press', name:'Press Secretary', phase:2, batchNote:'Batch 63‚Äì67', runnerUpRole:'Assistant Press Secretary' },
];

let voters          = [];
let candidates      = [];
let votes           = {}; 
let selections      = {}; 

let registrationOpen = true;
let electionOpen    = true;
let liveResultsOpen = true; 
let currentVoter    = null;

const ADMIN_PASS    = 'admin123';

// ‚îÄ‚îÄ UI HELPERS FOR LOADING STATES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setBtnLoading(btnId, isLoading, originalText = '') {
  const btn = document.getElementById(btnId);
  if (!btn) return;
  if (isLoading) {
    btn.dataset.origText = btn.innerHTML;
    btn.classList.add('btn-loading');
    btn.innerHTML = `<svg class="inline-spinner" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25" style="opacity:0.25;"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" style="opacity:0.75;"></path></svg> Processing`;
  } else {
    btn.classList.remove('btn-loading');
    btn.innerHTML = originalText || btn.dataset.origText;
  }
}

// ‚îÄ‚îÄ INITIAL DATA FETCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', async () => {
  await fetchData();
  
  // Hide loading screen smoothly
  const loader = document.getElementById('loading-overlay');
  loader.style.opacity = '0';
  setTimeout(() => loader.style.display = 'none', 300);
});

async function fetchData() {
  try {
    // 1. Fetch Settings
    const { data: settings } = await supabaseClient.from('election_settings').select('*').single();
    if(settings) {
      registrationOpen = settings.registration_open !== false; 
      electionOpen = settings.is_open;
      liveResultsOpen = settings.live_results_public;
      updateStatusUI();
    }

    // 2. Fetch Voters
    const { data: vData } = await supabaseClient.from('voters').select('*');
    if(vData) {
      voters = vData.map(v => ({
        id: v.id, name: v.full_name, sid: v.student_id, 
        email: v.email, dept: v.department, batch: v.batch, voted: v.has_voted,
        isApproved: v.is_approved !== false 
      }));
    }

    // 3. Fetch Candidates
    const { data: cData } = await supabaseClient.from('candidates').select('*');
    if(cData) {
      candidates = cData.map(c => ({
        id: c.id, name: c.full_name, sid: c.student_id, 
        position: c.target_position, dept: c.department, batch: c.batch, bio: c.bio, imageUrl: c.image_url,
        isApproved: c.is_approved !== false,
        paymentNumber: c.payment_number, trxId: c.transaction_id
      }));
    }

    // 4. Fetch Votes
    const { data: vtData } = await supabaseClient.from('votes').select('*');
    votes = {};
    if(vtData) {
      vtData.forEach(v => {
        if(!votes[v.voter_id]) votes[v.voter_id] = {};
        votes[v.voter_id][v.target_position] = v.candidate_id;
      });
    }

    // Trigger UI updates
    const activeVotersCount = voters.filter(v => v.isApproved).length;
    document.getElementById('total-pill').textContent = activeVotersCount;
    
    renderCandidatesPage(); // Update Public Candidates Tab

    if(document.getElementById('page-admin').classList.contains('active')) {
      renderVoterTable(); 
      renderCandTable();
      if(document.getElementById('atab-results').style.display !== 'none') renderResults();
    }
    
    if(document.getElementById('page-live').classList.contains('active')) {
      renderLive();
    }

  } catch (err) {
    console.error("Fetch Error:", err);
  }
}

function updateStatusUI() {
  const bar = document.getElementById('status-bar');
  const txt = document.getElementById('status-text');
  
  // Admin Toggles
  const regToggle = document.getElementById('reg-toggle');
  const elecToggle = document.getElementById('elec-toggle');
  const liveToggle = document.getElementById('live-toggle');

  if(regToggle) regToggle.checked = registrationOpen;
  if(elecToggle) elecToggle.checked = electionOpen;
  if(liveToggle) liveToggle.checked = liveResultsOpen;

  // Registration Page UI
  const regWrapper = document.getElementById('reg-wrapper');
  const regClosedMsg = document.getElementById('reg-closed-msg');
  if(regWrapper && regClosedMsg) {
    if(registrationOpen) {
      regWrapper.style.display = '';
      regClosedMsg.style.display = 'none';
    } else {
      regWrapper.style.display = 'none';
      regClosedMsg.style.display = 'block';
    }
  }

  // Header UI
  if(electionOpen) {
    bar.className = '';
    txt.textContent = 'Voting Active';
  } else {
    bar.className = 'closed';
    txt.textContent = 'Voting Closed';
  }
}

// ‚îÄ‚îÄ PAGE NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(p) {
  document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
  document.getElementById('page-' + p).classList.add('active');
  document.getElementById('hero-section').style.display = (p === 'voter' || p === 'register' || p === 'candidates-list') ? '' : 'none';
  if(p === 'voter') resetGate();
  if(p === 'live') {
    startLiveRefresh();
  } else {
    stopLiveRefresh();
  }
  window.scrollTo({top:0, behavior:'smooth'});
}

function switchRegTab(type, btn) {
  document.querySelectorAll('#page-register .atab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('reg-voter-form').style.display = type === 'voter' ? '' : 'none';
  document.getElementById('reg-cand-form').style.display = type === 'candidate' ? '' : 'none';
}

// ‚îÄ‚îÄ PUBLIC CANDIDATES LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCandidatesPage() {
  const body = document.getElementById('candidates-list-body');
  const activeCandidates = candidates.filter(c => c.isApproved);
  
  if(!activeCandidates.length) {
    body.innerHTML = '<div class="card"><div class="empty"><div class="ei">ü™´</div><p>No approved candidates available yet.</p></div></div>';
    return;
  }

  let html = '';
  POSITIONS.forEach(pos => {
    const posCands = activeCandidates.filter(c => c.position === pos.name);
    if(!posCands.length) return;

    html += `
      <div class="cp-section-title">${esc(pos.name)}</div>
      <div class="cp-grid">
        ${posCands.map(c => `
          <div class="cp-card">
            <div class="cp-img" ${c.imageUrl ? `style="background-image: url('${esc(c.imageUrl)}');"` : ''}>
              ${c.imageUrl ? '' : c.name.trim()[0]}
            </div>
            <div class="cp-name">${esc(c.name)}</div>
            <div class="badge bg" style="margin-bottom: 12px; font-size: 13px;">${esc(c.position)}</div>
            <div class="cp-meta">${esc(c.batch)} &middot; ${esc(c.dept)}</div>
            <div class="cp-bio">"${esc(c.bio || 'No manifesto provided.')}"</div>
          </div>
        `).join('')}
      </div>
    `;
  });
  body.innerHTML = html;
}

// ‚îÄ‚îÄ PUBLIC REGISTRATION FLOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitPublicVoter() {
  const name  = document.getElementById('pub-nv-name').value.trim();
  const sid   = document.getElementById('pub-nv-sid').value.trim();
  const email = document.getElementById('pub-nv-email').value.trim();
  const dept  = document.getElementById('pub-nv-dept').value.trim();
  const batch = document.getElementById('pub-nv-batch').value.trim();
  
  if(!name || !sid) { toast('Name and Student ID are required.', true); return; }
  
  // Refresh data first to check for duplicates
  await fetchData();
  if(voters.find(v => v.sid === sid)) { toast('ID already registered.', true); return; }
  
  setBtnLoading('btn-pub-add-voter', true);
  
  const { error } = await supabaseClient.from('voters').insert([{
    full_name: name, student_id: sid, email: email, department: dept, batch: batch, is_approved: false
  }]);

  if(error) {
    toast(error.message, true);
    setBtnLoading('btn-pub-add-voter', false, 'Submit Registration');
    return;
  }

  ['pub-nv-name','pub-nv-sid','pub-nv-email','pub-nv-dept','pub-nv-batch'].forEach(f => document.getElementById(f).value = '');
  await fetchData();
  toast('Registration submitted! Awaiting Admin Approval.');
  setBtnLoading('btn-pub-add-voter', false, 'Submit Registration');
}

async function submitPublicCandidate() {
  const name     = document.getElementById('pub-nc-name').value.trim();
  const sid      = document.getElementById('pub-nc-sid').value.trim();
  const pos      = document.getElementById('pub-nc-pos').value;
  const dept     = document.getElementById('pub-nc-dept').value.trim();
  const batch    = document.getElementById('pub-nc-batch').value.trim();
  const imageUrl = document.getElementById('pub-nc-image').value.trim();
  const pay      = document.getElementById('pub-nc-pay').value.trim();
  const trx      = document.getElementById('pub-nc-trx').value.trim();
  const bio      = document.getElementById('pub-nc-bio').value.trim();
  const termsBox = document.getElementById('pub-nc-terms');
  
  if(!name || !pos || !pay || !trx) { toast('Name, Position, and Payment details are required.', true); return; }
  if(!termsBox.checked) { toast('You must agree to the terms.', true); return; }
  
  setBtnLoading('btn-pub-add-cand', true);
  
  const { error } = await supabaseClient.from('candidates').insert([{
    full_name: name, student_id: sid, target_position: pos, department: dept, batch: batch, image_url: imageUrl, bio: bio, payment_number: pay, transaction_id: trx, is_approved: false
  }]);

  if(error) { 
    toast(error.message, true); 
    setBtnLoading('btn-pub-add-cand', false, 'Submit Application');
    return; 
  }

  ['pub-nc-name','pub-nc-sid','pub-nc-dept','pub-nc-batch','pub-nc-image','pub-nc-pay','pub-nc-trx','pub-nc-bio'].forEach(f => document.getElementById(f).value = '');
  document.getElementById('pub-nc-pos').value = '';
  termsBox.checked = false;
  
  await fetchData();
  toast('Application submitted! Awaiting Admin Approval.');
  setBtnLoading('btn-pub-add-cand', false, 'Submit Application');
}


// ‚îÄ‚îÄ VOTER FLOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resetGate() {
  show('voter-gate'); hide('ballot-section'); hide('success-section');
  document.getElementById('voter-id-input').value = '';
  document.getElementById('gate-err').classList.remove('show');
  currentVoter = null; selections = {};
}

async function verifyVoter() {
  if(!electionOpen) { showErr('gate-err', 'The election is currently closed.'); return; }
  const sid = document.getElementById('voter-id-input').value.trim();
  if(!sid) { showErr('gate-err', 'Please enter your Student ID.'); return; }
  
  setBtnLoading('btn-verify', true);
  
  await fetchData();
  
  const v = voters.find(x => x.sid === sid);
  if(!v) { 
    showErr('gate-err', 'ID not found. Please register first.'); 
    setBtnLoading('btn-verify', false, 'Continue');
    return; 
  }
  if(!v.isApproved) {
    showErr('gate-err', 'Registration pending admin approval.'); 
    setBtnLoading('btn-verify', false, 'Continue');
    return; 
  }
  if(v.voted || votes[v.id]) { 
    showErr('gate-err', 'You have already voted.'); 
    setBtnLoading('btn-verify', false, 'Continue');
    return; 
  }
  
  setBtnLoading('btn-verify', false, 'Continue');
  currentVoter = v;
  selections[v.id] = {};
  buildBallot();
  hide('voter-gate');
  show('ballot-section');
  document.getElementById('bh-name').textContent = v.name;
  document.getElementById('bh-meta').textContent = v.dept + ' ‚Ä¢ ' + v.batch + ' ‚Ä¢ ID: ' + v.sid;
  updateProgress();
  window.scrollTo({top:0, behavior:'smooth'});
}

function buildBallot() {
  const body = document.getElementById('ballot-body');
  body.innerHTML = '';
  let currentPhase = 0;
  
  const activeCandidates = candidates.filter(c => c.isApproved);

  POSITIONS.forEach(pos => {
    const cands = activeCandidates.filter(c => c.position === pos.name);
    if(!cands.length) return;

    if(pos.phase !== currentPhase) {
      currentPhase = pos.phase;
      const banner = document.createElement('div');
      banner.className = 'phase-banner';
      banner.innerHTML = `
        <div class="ph-num">${pos.phase}</div>
        <div class="ph-txt">
          <b>${pos.phase === 1 ? 'Leadership Council' : 'Executive Board'}</b>
          <span>${pos.phase === 1 ? 'President, VP, and General Secretaries' : 'Specialized Executive Secretaries'}</span>
        </div>`;
      body.appendChild(banner);
    }

    const div = document.createElement('div');
    div.className = 'pos-card';
    div.id = 'poscard-' + pos.id;
    div.innerHTML = `
      <div class="pos-head">
        <div class="pos-name">
          ${esc(pos.name)}
          ${pos.runnerUpRole ? `<span class="auto-tag">Runner-up becomes ${esc(pos.runnerUpRole)}</span>` : ''}
        </div>
        <div class="pos-rule">${esc(pos.batchNote)} &middot; Select exactly one candidate</div>
      </div>
      <div class="cands-grid" id="grid-${pos.id}">
        ${cands.map(c => `
          <div class="cand" id="cc-${c.id}" data-posid="${pos.id}" data-cid="${c.id}" onclick="pick(this)">
            <div class="cand-radio"></div>
            <div class="cav" ${c.imageUrl ? `style="background-image: url('${esc(c.imageUrl)}'); background-size: cover; background-position: center; border-color: transparent;"` : ''}>
              ${c.imageUrl ? '' : c.name.trim()[0]}
            </div>
            <div class="cname">${esc(c.name)}</div>
            <div class="cmeta">${esc(c.batch)} &middot; ${esc(c.dept)}</div>
            ${c.bio ? `<div class="cbio">"${esc(c.bio)}"</div>` : ''}
          </div>`).join('')}
      </div>`;
    body.appendChild(div);
  });

  if(!body.children.length) {
    body.innerHTML = '<div class="card"><div class="empty"><div class="ei">ü™´</div><p>No active candidates available for voting yet.</p></div></div>';
  }
}

function pick(el) {
  const posId   = el.dataset.posid;
  const cid     = el.dataset.cid; 
  const pos     = POSITIONS.find(p => p.id === posId);
  const posName = pos ? pos.name : posId;
  
  document.querySelectorAll(`#grid-${posId} .cand`).forEach(e => e.classList.remove('sel'));
  el.classList.add('sel');
  
  const posCard = document.getElementById('poscard-' + posId);
  if(posCard) posCard.classList.add('has-sel');
  
  selections[currentVoter.id][posName] = cid;
  updateProgress();
  updateSummary();
}

function updateProgress() {
  const activeCandidates = candidates.filter(c => c.isApproved);
  const activePosCount = POSITIONS.filter(p => activeCandidates.some(c => c.position === p.name)).length;
  const selected = Object.keys(selections[currentVoter.id] || {}).length;
  const pct = activePosCount ? Math.round(selected / activePosCount * 100) : 0;
  
  document.getElementById('pt-bar').style.width = pct + '%';
  document.getElementById('pt-count').textContent = `${selected} of ${activePosCount}`;
}

function updateSummary() {
  const sel = selections[currentVoter.id] || {};
  const activeCandidates = candidates.filter(c => c.isApproved);
  
  const lines = POSITIONS
    .filter(p => activeCandidates.some(c => c.position === p.name))
    .map(p => {
      const cid = sel[p.name];
      if(cid) {
        const c = activeCandidates.find(x => x.id === cid);
        return `<div><b>${esc(p.name)}</b><div>${esc(c ? c.name : '‚Äî')}</div></div>`;
      }
      return `<div class="miss"><b>${esc(p.name)}</b><div>Pending selection</div></div>`;
    }).join('');
  document.getElementById('sel-summary').innerHTML = lines || '<em>No selections made yet.</em>';
}

async function submitVote() {
  const sel = selections[currentVoter.id] || {};
  const activeCandidates = candidates.filter(c => c.isApproved);
  const activePosCount = POSITIONS.filter(p => activeCandidates.some(c => c.position === p.name)).length;
  
  if(Object.keys(sel).length < activePosCount) { 
    toast('Please make a selection for every position.', true); 
    return; 
  }
  if(!confirm('Are you sure you want to submit your ballot? This is final.')) return;
  
  const votesToInsert = Object.keys(sel).map(posName => ({
    voter_id: currentVoter.id,
    candidate_id: sel[posName],
    target_position: posName
  }));

  setBtnLoading('btn-submit', true);
  
  try {
    const { error: voteErr } = await supabaseClient.from('votes').insert(votesToInsert);
    if (voteErr) { throw voteErr; }

    const { error: uErr } = await supabaseClient.from('voters').update({ has_voted: true }).eq('id', currentVoter.id);
    if (uErr) { throw uErr; }

    votes[currentVoter.id] = sel;
    currentVoter.voted = true;
    hide('ballot-section');
    show('success-section');
    document.getElementById('success-name').textContent = currentVoter.name;
    
    await fetchData();

  } catch(err) {
    toast('Error submitting vote: ' + err.message, true);
  } finally {
    setBtnLoading('btn-submit', false, 'Submit Ballot');
  }
}

// ‚îÄ‚îÄ ADMIN CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function toggleRegistration() {
  registrationOpen = document.getElementById('reg-toggle').checked;
  await supabaseClient.from('election_settings').update({registration_open: registrationOpen}).eq('id', 1);
  updateStatusUI();
  toast(registrationOpen ? 'Registration is OPEN.' : 'Registration is CLOSED.');
}

async function toggleElection() {
  electionOpen = document.getElementById('elec-toggle').checked;
  await supabaseClient.from('election_settings').update({is_open: electionOpen}).eq('id', 1);
  updateStatusUI();
  toast(electionOpen ? 'System is accepting votes.' : 'System is locked.');
}

async function toggleLive() {
  liveResultsOpen = document.getElementById('live-toggle').checked;
  await supabaseClient.from('election_settings').update({live_results_public: liveResultsOpen}).eq('id', 1);
  updateStatusUI();
  toast(liveResultsOpen ? 'Live results are visible.' : 'Live results are hidden.');
  if (document.getElementById('page-live').classList.contains('active')) renderLive();
}

function adminLogin() {
  if(document.getElementById('admin-pass').value === ADMIN_PASS) {
    hide('admin-gate'); show('admin-panel');
    renderVoterTable(); renderCandTable();
    toast('Authenticated.');
  } else {
    showErr('admin-err', 'Invalid credentials.');
  }
}

function adminLogout() {
  show('admin-gate'); hide('admin-panel');
  document.getElementById('admin-pass').value = '';
}

function switchATab(name, btn) {
  ['voters','candidates','results'].forEach(t => document.getElementById('atab-'+t).style.display = t === name ? '' : 'none');
  document.querySelectorAll('.atab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if(name === 'results') renderResults();
}

// ‚îÄ‚îÄ ADMIN: VOTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let vFilter = '';
function filterVoters(q) { vFilter = q.toLowerCase(); renderVoterTable(); }

async function addVoter() {
  const name  = document.getElementById('nv-name').value.trim();
  const sid   = document.getElementById('nv-sid').value.trim();
  const email = document.getElementById('nv-email').value.trim();
  const dept  = document.getElementById('nv-dept').value.trim();
  const batch = document.getElementById('nv-batch').value.trim();
  
  if(!name || !sid) { toast('Name and Student ID required.', true); return; }
  if(voters.find(v => v.sid === sid)) { toast('ID already registered.', true); return; }
  
  setBtnLoading('btn-add-voter', true);
  
  // Admin manual adds are explicitly auto-approved
  const { error } = await supabaseClient.from('voters').insert([{
    full_name: name, student_id: sid, email: email, department: dept, batch: batch, is_approved: true
  }]);

  if(error) {
    toast(error.message, true);
    setBtnLoading('btn-add-voter', false, 'Add Voter');
    return;
  }

  ['nv-name','nv-sid','nv-email','nv-dept','nv-batch'].forEach(f => document.getElementById(f).value = '');
  await fetchData();
  toast('Voter manually registered.');
  setBtnLoading('btn-add-voter', false, 'Add Voter');
}

async function approveVoter(id) {
  if(!confirm('Approve this voter?')) return;
  const { data, error } = await supabaseClient.from('voters').update({ is_approved: true }).eq('id', id).select();
  if(error) { toast(error.message, true); return; }
  if(!data || data.length === 0) { toast('Error: Permission denied. Check Supabase UPDATE policies.', true); return; }
  await fetchData();
  toast('Voter Approved.');
}

async function editVoter(id) {
  const v = voters.find(x => x.id === id);
  if (!v) return;
  const newName = prompt("Edit Voter Name:", v.name);
  if (newName === null || newName.trim() === '') return;
  const newSid = prompt("Edit Student ID:", v.sid);
  if (newSid === null || newSid.trim() === '') return;
  
  const { data, error } = await supabaseClient.from('voters').update({ full_name: newName.trim(), student_id: newSid.trim() }).eq('id', id).select();
  if(error) { toast(error.message, true); return; }
  if(!data || data.length === 0) { toast('Error: Permission denied. Check Supabase UPDATE policies.', true); return; }
  await fetchData();
  toast('Voter updated.');
}

async function removeVoter(id) {
  if(!confirm('Remove this voter?')) return;
  const { error } = await supabaseClient.from('voters').delete().eq('id', id);
  if(error) { toast(error.message, true); return; }
  await fetchData();
  toast('Voter removed.');
}

function renderVoterTable() {
  const list = voters.filter(v => 
    !vFilter || 
    v.name.toLowerCase().includes(vFilter) || 
    v.sid.toLowerCase().includes(vFilter) || 
    (v.dept||'').toLowerCase().includes(vFilter)
  );
  
  const voted = voters.filter(v => v.voted || votes[v.id]).length;
  const approved = voters.filter(v => v.isApproved).length;
  
  document.getElementById('atab-vc').textContent = voters.length;
  document.getElementById('voter-count-lbl').textContent = `${voters.length} total ‚Ä¢ ${approved} approved ‚Ä¢ ${voted} voted`;

  const tb = document.getElementById('voter-tbody');
  if(!list.length) { tb.innerHTML = `<tr><td colspan="7"><div class="empty">No records.</div></td></tr>`; return; }
  
  tb.innerHTML = list.map((v,i) => `
    <tr>
      <td style="color:var(--text-tertiary)">${i+1}</td>
      <td><strong>${esc(v.name)}</strong></td>
      <td style="font-family:var(--font-mono); font-size:14px;">${esc(v.sid)}</td>
      <td>${esc(v.dept||'‚Äî')}</td>
      <td><span class="badge ${(v.voted||votes[v.id]) ? 'bg' : 'bo'}">${(v.voted||votes[v.id]) ? 'Voted' : 'Pending'}</span></td>
      <td>${v.isApproved ? '<span class="badge bg">Approved</span>' : '<span class="badge bo">Awaiting</span>'}</td>
      <td style="white-space:nowrap; display:flex; gap:8px;">
        ${!v.isApproved ? `<button class="btn-approve" onclick="approveVoter('${v.id}')">Approve</button>` : ''}
        <button class="btn-edit" onclick="editVoter('${v.id}')">Edit</button>
        <button class="btn-d" onclick="removeVoter('${v.id}')">Del</button>
      </td>
    </tr>`).join('');
}

// ‚îÄ‚îÄ ADMIN: CANDIDATES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function approveCandidate(id) {
  if(!confirm('Approve this candidate?')) return;
  const { data, error } = await supabaseClient.from('candidates').update({ is_approved: true }).eq('id', id).select();
  if(error) { toast(error.message, true); return; }
  if(!data || data.length === 0) { toast('Error: Permission denied. Check Supabase UPDATE policies.', true); return; }
  await fetchData();
  toast('Candidate Approved.');
}

async function editCandidate(id) {
  const c = candidates.find(x => x.id === id);
  if (!c) return;
  const newName = prompt("Edit Candidate Name:", c.name);
  if (newName === null || newName.trim() === '') return;
  
  const { data, error } = await supabaseClient.from('candidates').update({ full_name: newName.trim() }).eq('id', id).select();
  if(error) { toast(error.message, true); return; }
  if(!data || data.length === 0) { toast('Error: Permission denied. Check Supabase UPDATE policies.', true); return; }
  await fetchData();
  toast('Candidate updated.');
}

async function removeCandidate(id) {
  if(!confirm('Remove this candidate?')) return;
  const { error } = await supabaseClient.from('candidates').delete().eq('id', id);
  if(error) { toast(error.message, true); return; }
  await fetchData();
  toast('Candidate removed.');
}

function renderCandTable() {
  const tb = document.getElementById('cand-tbody');
  if(!candidates.length) { tb.innerHTML = `<tr><td colspan="7"><div class="empty">No candidates found.</div></td></tr>`; return; }
  
  tb.innerHTML = candidates.map((c,i) => `
    <tr>
      <td style="color:var(--text-tertiary)">${i+1}</td>
      <td><strong>${esc(c.name)}</strong></td>
      <td><span class="badge bg">${esc(c.position)}</span></td>
      <td>${esc(c.dept||'‚Äî')}</td>
      <td>
        ${c.trxId ? `<div style="font-size:12px; color:var(--text-sec); font-family:var(--font-mono);">Num: ${esc(c.paymentNumber)}<br>Trx: <strong style="color:var(--text-main);">${esc(c.trxId)}</strong></div>` : '‚Äî'}
      </td>
      <td>${c.isApproved ? '<span class="badge bg">Approved</span>' : '<span class="badge bo">Awaiting</span>'}</td>
      <td style="white-space:nowrap; display:flex; gap:8px;">
        ${!c.isApproved ? `<button class="btn-approve" onclick="approveCandidate('${c.id}')">Approve</button>` : ''}
        <button class="btn-edit" onclick="editCandidate('${c.id}')">Edit</button>
        <button class="btn-d" onclick="removeCandidate('${c.id}')">Del</button>
      </td>
    </tr>`).join('');
}

// ‚îÄ‚îÄ SHARED REPORTING LOGIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function aggregateResults() {
  const vcounts = {};
  Object.values(votes).forEach(sel => {
    Object.values(sel).forEach(cid => {
      vcounts[cid] = (vcounts[cid] || 0) + 1;
    });
  });

  const posMap = {};
  // Only tally votes for approved candidates
  candidates.filter(c => c.isApproved).forEach(c => {
    if(!posMap[c.position]) posMap[c.position] = [];
    posMap[c.position].push({...c, vc: vcounts[c.id] || 0});
  });
  return posMap;
}

// ‚îÄ‚îÄ ADMIN: RESULTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderResults() {
  const total = voters.filter(v => v.isApproved).length; 
  const voted = voters.filter(v => v.voted || votes[v.id]).length;
  
  document.getElementById('r-total').textContent = total;
  document.getElementById('r-voted').textContent = voted;
  document.getElementById('r-pct').textContent   = total ? Math.round(voted/total*100) + '%' : '0%';
  document.getElementById('r-pos').textContent   = POSITIONS.length;

  const posMap = aggregateResults();
  const activePositions = POSITIONS.filter(p => posMap[p.name]);
  const body = document.getElementById('results-body');
  
  if(!activePositions.length) {
    body.innerHTML = '<div class="empty">Awaiting votes...</div>';
    return;
  }

  let html = '';
  activePositions.forEach(pos => {
    const sorted = [...posMap[pos.name]].sort((a,b) => b.vc - a.vc);
    const winner = sorted[0];
    const runnerup = sorted[1];
    const max = Math.max(winner?.vc || 0, 1);

    html += `<div style="margin-bottom:40px; padding-bottom:32px; border-bottom:0.5px solid var(--glass-border)">
      <h4 style="font-size:20px; font-weight: 600; margin-bottom:20px; color:var(--text-main);">${esc(pos.name)}</h4>
      ${sorted.map((c,i) => `
        <div style="margin-bottom:16px; display:flex; align-items:center; gap:16px;">
          <div style="width: 28px; height: 28px; border-radius: 50%; background: var(--glass-bg); text-align:center; line-height: 28px; color:var(--text-sec); font-weight: bold; flex-shrink:0;">${i===0 && c.vc>0 ? 'üèÜ' : i+1}</div>
          <div style="width: 40px; height: 40px; border-radius: 50%; background-color: var(--glass-bg); color: var(--text-sec); display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; overflow: hidden; border: 0.5px solid var(--glass-border); ${c.imageUrl ? `background-image: url('${esc(c.imageUrl)}'); background-size: cover; background-position: center; border-color: transparent;` : ''}">
            ${c.imageUrl ? '' : c.name.trim()[0]}
          </div>
          <div style="flex:1">
            <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:15px">
              <strong>${esc(c.name)}</strong>
              <span style="color:var(--text-sec); font-weight: 500;">${c.vc} votes</span>
            </div>
            <div style="background:var(--glass-bg); height:8px; border-radius:100px; overflow:hidden;">
              <div style="background:var(--primary); width:${Math.round(c.vc/max*100)}%; height:100%; border-radius:100px;"></div>
            </div>
          </div>
        </div>
      `).join('')}
      ${pos.runnerUpRole && runnerup && runnerup.vc > 0 ? `
        <div class="runner-assign" style="margin-top:24px;">
          ‚ö° Runner-up <b>${esc(runnerup.name)}</b> secures <b>${esc(pos.runnerUpRole)}</b>.
        </div>` : ''}
    </div>`;
  });
  body.innerHTML = html;
}

// ‚îÄ‚îÄ LIVE DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let liveTimer = null;
let liveCountdown = 10;

async function startLiveRefresh() {
  stopLiveRefresh();
  
  setBtnLoading('btn-refresh', true);
  await fetchData(); 
  setBtnLoading('btn-refresh', false, 'Refresh Now');
  renderLive();
  
  liveCountdown = 10;
  liveTimer = setInterval(async () => {
    liveCountdown--;
    const el = document.getElementById('lv-countdown');
    if(el) el.textContent = liveCountdown;
    if(liveCountdown <= 0) { 
      setBtnLoading('btn-refresh', true);
      await fetchData(); 
      setBtnLoading('btn-refresh', false, 'Refresh Now');
      renderLive(); 
      liveCountdown = 10; 
    }
  }, 1000);
}

function stopLiveRefresh() { if(liveTimer) clearInterval(liveTimer); }

function renderLive() {
  liveCountdown = 10;
  
  if (!liveResultsOpen) {
    document.getElementById('lv-voted').textContent = '-';
    document.getElementById('lv-pct').textContent = 'Hidden by Administrator';
    document.getElementById('lv-lastupdate').textContent = 'Last sync: ' + new Date().toLocaleTimeString();
    document.getElementById('lv-overall').innerHTML = '';
    document.getElementById('lv-body').innerHTML = `
      <div class="card">
        <div class="empty">
          <div class="ei">üõ°Ô∏è</div>
          <h3 style="font-size:24px; color:var(--text-main); margin-bottom:12px;">Results Hidden</h3>
          <p>The administrator has temporarily hidden the live public telecast.</p>
        </div>
      </div>`;
    return;
  }

  const totalVoters = voters.filter(v => v.isApproved).length;
  const totalVoted  = voters.filter(v => v.voted || votes[v.id]).length;
  
  document.getElementById('lv-voted').textContent = totalVoted;
  document.getElementById('lv-pct').textContent = `of ${totalVoters} approved voters`;
  document.getElementById('lv-lastupdate').textContent = 'Last sync: ' + new Date().toLocaleTimeString();

  const posMap = aggregateResults();
  const activePositions = POSITIONS.filter(p => posMap[p.name]);
  
  document.getElementById('lv-overall').innerHTML = `
    <div class="ov-card"><div class="ov-n">${totalVoted}</div><div class="ov-l">Total Ballots Cast</div></div>
    <div class="ov-card"><div class="ov-n">${totalVoters ? Math.round(totalVoted/totalVoters*100) : 0}%</div><div class="ov-l">Voter Turnout</div></div>
    <div class="ov-card"><div class="ov-n">${activePositions.length}</div><div class="ov-l">Active Races</div></div>
  `;

  const body = document.getElementById('lv-body');
  if(!activePositions.length) {
    body.innerHTML = '<div class="card"><div class="empty">Awaiting approved candidates...</div></div>';
    return;
  }

  let html = '';
  activePositions.forEach(pos => {
    const cands = (posMap[pos.name] || []).sort((a,b) => b.vc - a.vc);
    const posTotal = cands.reduce((s,c) => s + c.vc, 0);
    const winner = cands[0];
    const runnerup = cands[1];

    html += `<div class="live-pos-card">
      <div class="lpc-header">
        <div>
          <div class="lpc-name">${esc(pos.name)}</div>
          <div class="lpc-total">${posTotal} total votes distributed</div>
        </div>
      </div>
      ${cands.map((c, i) => {
        const pct = posTotal > 0 ? Math.round(c.vc / posTotal * 100) : 0;
        const isLeading = i === 0 && c.vc > 0;
        return `
          <div class="live-cand-row ${isLeading ? 'leading' : ''}">
            <div class="lcr-rank">${i === 0 && c.vc > 0 ? 'üèÜ' : i + 1}</div>
            <div class="lcr-avatar" ${c.imageUrl ? `style="background-image: url('${esc(c.imageUrl)}'); background-size: cover; background-position: center; border-color: transparent;"` : ''}>
              ${c.imageUrl ? '' : c.name.trim()[0]}
            </div>
            <div class="lcr-info">
              <div class="lcr-name">${esc(c.name)}</div>
              <div class="lcr-meta">${esc(c.batch)} &middot; ${esc(c.dept)}</div>
              <div class="lcr-bar-wrap"><div class="lcr-bar" style="width:${pct}%"></div></div>
            </div>
            <div>
              <div class="lcr-pct">${pct}%</div>
              <div class="lcr-votes">${c.vc} votes</div>
            </div>
          </div>`;
      }).join('')}
            ${pos.runnerUpRole && runnerup && runnerup.vc > 0 ? `
        <div class="runner-assign">
          <span>‚ö°</span>
          <span>Based on current projections, <strong>${esc(runnerup.name)}</strong> tracks for <strong>${esc(pos.runnerUpRole)}</strong>.</span>
        </div>` : ''}
    </div>`;
  });
  body.innerHTML = html;
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function show(id) { document.getElementById(id).style.display = ''; }
function hide(id) { document.getElementById(id).style.display = 'none'; }
function showErr(id, msg) {
  const e = document.getElementById(id);
  e.textContent = msg; e.classList.add('show');
  setTimeout(() => e.classList.remove('show'), 4000);
}
function toast(msg, err=false) {
  const t = document.getElementById('toast');
  t.innerHTML = (err ? '‚ö†Ô∏è ' : '‚úÖ ') + msg; 
  t.className = 'show' + (err ? ' err' : '');
  setTimeout(() => t.className = '', 3000);
}
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
</script>
</body>
</html>